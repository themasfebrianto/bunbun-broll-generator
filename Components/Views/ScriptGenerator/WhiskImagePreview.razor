@namespace BunbunBroll.Components.Views.ScriptGenerator
@using BunbunBroll.Models

@if (Item.WhiskStatus == WhiskGenerationStatus.Pending)
{
    <div class="flex flex-col items-center justify-center h-full gap-2 py-8">
        <div class="h-12 w-12 rounded-full bg-amber-500/10 flex items-center justify-center text-2xl">‚è≥</div>
        <span class="text-xs text-amber-400">Menunggu generate</span>
        <span class="text-[10px] text-muted-foreground">Klik "Generate Image" di bawah prompt</span>
    </div>
}
else if (Item.WhiskStatus == WhiskGenerationStatus.Generating)
{
    <div class="flex flex-col items-center justify-center h-full gap-2 py-8 text-purple-400">
        <svg class="animate-spin h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-xs">Generating via Whisk...</span>
    </div>
}
else if (Item.WhiskStatus == WhiskGenerationStatus.Done && !string.IsNullOrEmpty(Item.WhiskImagePath))
{
    <div class="space-y-2">
        <div class="flex items-center justify-between py-1">
            <div class="flex items-center gap-2 text-emerald-400 text-xs font-medium">
                <span>‚úÖ Generated @(Item.WhiskVideoStatus == WhiskGenerationStatus.Done ? "+ üé•" : "")</span>
            </div>
        </div>

        @if (Item.WhiskVideoStatus == WhiskGenerationStatus.Done && !string.IsNullOrEmpty(Item.WhiskVideoPath) && System.IO.File.Exists(ResolveLocalPath(Item.WhiskVideoPath)))
        {
            <div class="rounded-lg overflow-hidden border border-primary/30 bg-black aspect-video relative">
                @{
                    var videoSrc = !string.IsNullOrEmpty(Item.FilteredVideoPath)
                        ? $"{GetAssetUrl(Item.FilteredVideoPath)}?v={DateTime.Now.Ticks}"
                        : GetAssetUrl(Item.WhiskVideoPath);
                }
                <video src="@videoSrc" 
                       poster="@GetAssetUrl(Item.WhiskImagePath)"
                       preload="none"
                       class="w-full h-full object-cover" controls loop muted playsinline></video>

                @* Filter Progress Overlay *@
                @if (Item.IsFilteringVideo)
                {
                    <div class="absolute inset-0 bg-background/80 backdrop-blur-sm flex flex-col items-center justify-center z-10 p-4">
                        <div class="text-xs font-semibold mb-2">@Item.FilterStatus</div>
                        <div class="w-full h-1.5 bg-muted rounded-full overflow-hidden">
                            <div class="h-full bg-primary transition-all duration-300" style="width: @(Item.FilterProgress)%"></div>
                        </div>
                    </div>
                }

                @* Filter Controls *@
                @if (!string.IsNullOrEmpty(Item.FilteredVideoPath))
                {
                    <div class="absolute top-1 left-1 bg-blue-500/80 text-white text-[9px] px-1.5 py-0.5 rounded font-bold pointer-events-none">
                        @GetEffectDisplayName()
                    </div>
                    <button class="absolute top-1 right-1 bg-black/60 hover:bg-black/80 text-white rounded-full p-1"
                            title="Clear Filter"
                            @onclick="() => { Item.FilteredVideoPath = null; }"
                            @onclick:stopPropagation="true">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                }
            </div>
        }
        else if (Item.IsConvertingVideo)
        {
            <div class="rounded-lg border border-border/30 bg-muted/20 aspect-video flex flex-col items-center justify-center gap-3">
                <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-[10px] text-muted-foreground animate-pulse">Converting to Ken Burns...</span>
            </div>
        }
        else if (System.IO.File.Exists(ResolveLocalPath(Item.WhiskImagePath)))
        {
            <div class="rounded-lg overflow-hidden border border-border/30">
                <img src="@GetAssetUrl(Item.WhiskImagePath!)" alt="Generated image" class="w-full h-auto" />
            </div>
        }
        else
        {
            <div class="text-xs text-yellow-500">‚ö†Ô∏è File not found (@ResolveLocalPath(Item.WhiskImagePath))</div>
        }

        @if (Item.WhiskVideoStatus == WhiskGenerationStatus.Failed)
        {
            <div class="text-[9px] text-destructive bg-destructive/10 p-1.5 rounded border border-destructive/20 mt-1">
                ‚ùå Error: @Item.WhiskVideoError
            </div>
        }

        <div class="flex items-center justify-between mt-1">
            <div class="text-[10px] text-muted-foreground font-mono truncate flex-1">@System.IO.Path.GetFileName(Item.WhiskImagePath)</div>
            <div class="flex items-center gap-1.5">
                <span class="text-[10px] text-muted-foreground">üé•</span>
                <select class="bg-muted/50 border border-border/30 rounded px-1.5 py-0.5 text-[10px] focus:ring-1 focus:ring-primary cursor-pointer"
                        value="@Item.KenBurnsMotion"
                        disabled="@Item.IsConvertingVideo"
                        @onchange="OnMotionChange">
                    @foreach (var motion in Enum.GetValues<KenBurnsMotionType>().Where(m => m != KenBurnsMotionType.Random && m != KenBurnsMotionType.None))
                    {
                        <option value="@motion">@motion</option>
                    }
                </select>
            </div>
        </div>
    </div>
}
else if (Item.WhiskStatus == WhiskGenerationStatus.Failed)
{
    <div class="rounded-md border border-destructive/30 bg-destructive/10 p-2 text-destructive text-xs space-y-2">
        <div>‚ùå Gagal: @Item.WhiskError</div>
        @if (!string.IsNullOrEmpty(Item.WhiskError) && (Item.WhiskError.Contains("cookie", StringComparison.OrdinalIgnoreCase) || Item.WhiskError.Contains("Account.refresh", StringComparison.OrdinalIgnoreCase)))
        {
            <div class="flex justify-end mt-1">
                <button class="btn-primary text-[10px] h-7 px-3 flex items-center gap-1.5 bg-amber-600 hover:bg-amber-500 border-amber-500 text-white" 
                        @onclick="() => OnCookieUpdateRequested.InvokeAsync()">
                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    Update Cookie & Retry
                </button>
            </div>
        }
    </div>
}

@code {
    [Parameter] public BrollPromptItem Item { get; set; } = null!;
    [Parameter] public EventCallback OnGenerateKenBurns { get; set; }
    [Parameter] public EventCallback OnResetSegmentVideo { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnCookieUpdateRequested { get; set; }
    [Parameter] public Func<string, string> GetAssetUrl { get; set; } = _ => "";
    [Parameter] public Func<string?, string> ResolveLocalPath { get; set; } = _ => "";

    private async Task OnMotionChange(ChangeEventArgs e)
    {
        if (Enum.TryParse<KenBurnsMotionType>(e.Value?.ToString(), out var m))
        {
            Item.KenBurnsMotion = m;
            await OnSave.InvokeAsync();
        }
    }

    private string GetEffectDisplayName()
    {
        var parts = new List<string>();
        if (Item.EffectiveFilter != VideoFilter.None)
            parts.Add(Item.EffectiveFilter.ToString().ToUpper());
        if (Item.EffectiveTexture != VideoTexture.None)
            parts.Add(Item.EffectiveTexture.ToString().ToUpper());
        return parts.Count > 0 ? string.Join(" + ", parts) : "FILTERED";
    }
}
