@namespace BunbunBroll.Components.Views.ScriptGenerator
@using BunbunBroll.Models

@if (Item.WhiskStatus == WhiskGenerationStatus.Pending)
{
    <div class="flex flex-col items-center justify-center h-full gap-2 py-8">
        <div class="h-12 w-12 rounded-full bg-amber-500/10 flex items-center justify-center text-2xl">‚è≥</div>
        <span class="text-xs text-amber-400">Menunggu generate</span>
        <span class="text-[10px] text-muted-foreground">Klik "Generate Image" di bawah prompt</span>
    </div>
}
else if (Item.WhiskStatus == WhiskGenerationStatus.Generating)
{
    <div class="flex flex-col items-center justify-center h-full gap-2 py-8 text-purple-400">
        <svg class="animate-spin h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-xs">Generating via Whisk...</span>
    </div>
}
else if (Item.WhiskStatus == WhiskGenerationStatus.Done && !string.IsNullOrEmpty(Item.WhiskImagePath))
{
    <div class="space-y-2">
        <div class="flex items-center justify-between py-1">
            <div class="flex items-center gap-2 text-emerald-400 text-xs font-medium">
                <span>‚úÖ Generated @(Item.WhiskVideoStatus == WhiskGenerationStatus.Done ? "+ üé•" : "")</span>
            </div>
            @if (!Item.IsConvertingVideo)
            {
                <button class="btn btn-ghost btn-xs text-primary hover:bg-primary/10 gap-1 p-1 h-6" 
                        title="@(Item.WhiskVideoStatus == WhiskGenerationStatus.Done ? "Re-convert with current motion" : "Convert to Ken Burns Video")"
                        @onclick="OnGenerateKenBurns">
                    üé• @(Item.WhiskVideoStatus == WhiskGenerationStatus.Done ? "Re-convert" : "Convert")
                </button>
            }
        </div>

        @if (Item.WhiskVideoStatus == WhiskGenerationStatus.Done && !string.IsNullOrEmpty(Item.WhiskVideoPath) && System.IO.File.Exists(ResolveLocalPath(Item.WhiskVideoPath)))
        {
            <div class="rounded-lg overflow-hidden border border-primary/30 bg-black aspect-video">
                <video src="@GetAssetUrl(Item.WhiskVideoPath)" 
                       class="w-full h-full object-cover" controls loop muted playsinline></video>
            </div>
        }
        else if (Item.IsConvertingVideo)
        {
            <div class="rounded-lg border border-border/30 bg-muted/20 aspect-video flex flex-col items-center justify-center gap-3">
                <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-[10px] text-muted-foreground animate-pulse">Converting to Ken Burns...</span>
            </div>
        }
        else if (System.IO.File.Exists(ResolveLocalPath(Item.WhiskImagePath)))
        {
            <div class="rounded-lg overflow-hidden border border-border/30">
                <img src="@GetAssetUrl(Item.WhiskImagePath!)" alt="Generated image" class="w-full h-auto" />
            </div>
        }
        else
        {
            <div class="text-xs text-yellow-500">‚ö†Ô∏è File not found (@ResolveLocalPath(Item.WhiskImagePath))</div>
        }

        @if (Item.WhiskVideoStatus == WhiskGenerationStatus.Failed)
        {
            <div class="text-[9px] text-destructive bg-destructive/10 p-1.5 rounded border border-destructive/20 mt-1">
                ‚ùå Error: @Item.WhiskVideoError
            </div>
        }

        <div class="flex items-center justify-between mt-1">
            <div class="text-[10px] text-muted-foreground font-mono truncate flex-1">@System.IO.Path.GetFileName(Item.WhiskImagePath)</div>
            <div class="flex items-center gap-1.5">
                <span class="text-[10px] text-muted-foreground">üé•</span>
                <select class="bg-muted/50 border border-border/30 rounded px-1.5 py-0.5 text-[10px] focus:ring-1 focus:ring-primary cursor-pointer"
                        value="@Item.KenBurnsMotion"
                        disabled="@Item.IsConvertingVideo"
                        @onchange="OnMotionChange">
                    @foreach (var motion in Enum.GetValues<KenBurnsMotionType>().Where(m => m != KenBurnsMotionType.Random && m != KenBurnsMotionType.None))
                    {
                        <option value="@motion">@motion</option>
                    }
                </select>
            </div>
        </div>
    </div>
}
else if (Item.WhiskStatus == WhiskGenerationStatus.Failed)
{
    <div class="rounded-md border border-destructive/30 bg-destructive/10 p-2 text-destructive text-xs">
        ‚ùå Gagal: @Item.WhiskError
    </div>
}

@code {
    [Parameter] public BrollPromptItem Item { get; set; } = null!;
    [Parameter] public EventCallback OnGenerateKenBurns { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public Func<string, string> GetAssetUrl { get; set; } = _ => "";
    [Parameter] public Func<string?, string> ResolveLocalPath { get; set; } = _ => "";

    private async Task OnMotionChange(ChangeEventArgs e)
    {
        if (Enum.TryParse<KenBurnsMotionType>(e.Value?.ToString(), out var m))
        {
            Item.KenBurnsMotion = m;
            await OnSave.InvokeAsync();
        }
    }
}
