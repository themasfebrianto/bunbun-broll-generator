@namespace BunbunBroll.Components.Views.Broll
@using BunbunBroll.Models
@using BunbunBroll.Components.Common

<div class="lg:w-[260px] w-full shrink-0 lg:sticky lg:top-20 space-y-4">
    <!-- Back Button -->
    <button class="btn-secondary h-9 w-full lg:w-auto" @onclick="OnBack">
        <Icon Name="chevron-left" Size="16" Class="mr-2" />
        Balik ke Editor
    </button>

    <!-- Project Info Card -->
    <Card>
        <div class="space-y-4">
            <div class="space-y-1">
                <p class="text-xs text-muted-foreground">Project</p>
                <p class="font-medium truncate">@ProjectName</p>
            </div>

            @if (!string.IsNullOrEmpty(Mood))
            {
                <div class="space-y-1">
                    <p class="text-xs text-muted-foreground">Visual Style</p>
                    <div class="flex items-center gap-2">
                        <Badge Variant="primary">@Mood</Badge>
                    </div>
                </div>
            }

            <div class="grid grid-cols-2 gap-4 pt-2 border-t border-border">
                <div>
                    <p class="text-xs text-muted-foreground mb-1">Ready</p>
                    <p class="text-2xl font-bold font-mono">@ReadyCount</p>
                </div>
                <div>
                    <p class="text-xs text-muted-foreground mb-1">Total</p>
                    <p class="text-2xl font-bold font-mono">@TotalCount</p>
                </div>
            </div>
        </div>
    </Card>

    <!-- Raw B-Roll Downloads Section -->
    <Card>
        <div class="space-y-3">
            <div class="flex items-center gap-2">
                <Icon Name="download" Size="16" Class="text-muted-foreground" />
                <span class="text-sm font-medium">Raw B-Roll Clips</span>
            </div>
            
            <Button Text="@DownloadButtonText"
                    Icon="download"
                    Variant="secondary"
                    Class="h-10 w-full"
                    IsLoading="IsDownloading"
                    IsDisabled="@(ReadyCount == 0)"
                    OnClick="OnDownloadZip" />
            
            <!-- Secondary Actions -->
            <div class="grid grid-cols-2 gap-2">
                <Button Text="Ekspor Link"
                        Icon="file"
                        Variant="secondary"
                        Size="sm"
                        IsDisabled="@(ReadyCount == 0)"
                        OnClick="OnExportLinks" />

                <Button Text="Simpen Project"
                        Icon="save"
                        Variant="secondary"
                        Size="sm"
                        OnClick="OnSaveProject" />
            </div>

            <p class="text-center text-[10px] text-muted-foreground">Original landscape clips from Pexels/Pixabay</p>
        </div>
    </Card>

    <!-- Short Video Section (Hidden for now) -->
    @if (ShowShortVideoPanel)
    {
        <div class="card p-4 space-y-4 border-primary/20">
            <div class="flex items-center gap-2">
                <Icon Name="video" Size="16" Class="text-primary" />
                <span class="text-sm font-medium">Auto Short Video</span>
            </div>
            
            <!-- Aspect Ratio Selector -->
            <div class="space-y-2">
                <label class="text-xs font-medium text-muted-foreground">Aspect Ratio</label>
                <div class="grid grid-cols-4 gap-1.5">
                    @foreach (var ratio in Enum.GetValues<AspectRatio>())
                    {
                        var currentRatio = ratio;
                        <button type="button"
                                class="flex flex-col items-center justify-center p-2 rounded-md border text-xs transition-colors @(SelectedRatio == currentRatio ? "border-primary bg-primary/10" : "border-border hover:border-foreground/30")"
                                @onclick="() => HandleSelectRatio(currentRatio)">
                            <div class="mb-1 flex items-center justify-center" style="width: 24px; height: 24px;">
                                @GetRatioPreview(currentRatio)
                            </div>
                            <span class="text-[9px] @(SelectedRatio == currentRatio ? "text-primary" : "text-muted-foreground")">@currentRatio.GetDisplayName()</span>
                        </button>
                    }
                </div>
                <p class="text-[10px] text-muted-foreground text-center">@SelectedRatio.GetDescription()</p>
            </div>

            <!-- Generate Button -->
            <Button Text="Classify Script"
                    Icon="play"
                    Class="h-11 w-full"
                    IsLoading="IsGeneratingShortVideo"
                    IsDisabled="@(ReadyCount == 0)"
                    OnClick="OnGenerateShortVideo" />

            <!-- Progress -->
            @if (IsGeneratingShortVideo)
            {
                <div class="space-y-2 p-3 rounded-lg bg-muted/50 border border-border">
                    <div class="flex items-center justify-between text-xs">
                        <span class="font-medium text-primary">@GenerateStage</span>
                        <span class="font-mono text-muted-foreground">@FormatElapsedTime()</span>
                    </div>
                    <div class="h-2 w-full bg-muted rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-primary to-primary/70 transition-all duration-300 ease-out rounded-full"
                             style="width: @GenerateProgress%"></div>
                    </div>
                    <div class="flex items-center justify-between text-[10px] text-muted-foreground">
                        <span class="truncate max-w-[70%]">@GenerateMessage</span>
                        <span class="font-mono font-medium">@GenerateProgress%</span>
                    </div>
                </div>
            }

            <!-- Result -->
            @if (ShortVideoResult?.Success == true)
            {
                <div class="p-3 rounded-md bg-green-500/10 border border-green-500/30 space-y-2">
                    <div class="flex items-center gap-2">
                        <Icon Name="check" Size="16" Class="text-green-500" />
                        <p class="text-xs text-green-600 dark:text-green-400 font-medium">
                            Video ready! @ShortVideoResult.DurationSeconds s â€¢ @FormatFileSize(ShortVideoResult.FileSizeBytes)
                        </p>
                    </div>
                    <Button Text="Download MP4"
                            Icon="download"
                            Variant="secondary"
                            Size="sm"
                            Class="h-8 w-full"
                            OnClick="OnDownloadShortVideo" />
                </div>
            }
            else if (ShortVideoResult?.Success == false)
            {
                <div class="p-2 rounded-md bg-red-500/10 border border-red-500/30">
                    <p class="text-xs text-red-500">@ShortVideoResult.ErrorMessage</p>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string ProjectName { get; set; } = "";
    [Parameter] public string? Mood { get; set; }
    [Parameter] public int ReadyCount { get; set; }
    [Parameter] public int TotalCount { get; set; }
    [Parameter] public bool IsDownloading { get; set; }
    [Parameter] public bool ShowShortVideoPanel { get; set; }
    
    // Short Video Props
    [Parameter] public AspectRatio SelectedRatio { get; set; } = AspectRatio.Portrait_9x16;
    [Parameter] public bool IsGeneratingShortVideo { get; set; }
    [Parameter] public int GenerateProgress { get; set; }
    [Parameter] public string GenerateStage { get; set; } = "";
    [Parameter] public string GenerateMessage { get; set; } = "";
    [Parameter] public int ElapsedSeconds { get; set; }
    [Parameter] public ShortVideoResult? ShortVideoResult { get; set; }
    
    [Parameter] public EventCallback OnBack { get; set; }
    [Parameter] public EventCallback OnDownloadZip { get; set; }
    [Parameter] public EventCallback OnExportLinks { get; set; }
    [Parameter] public EventCallback OnSaveProject { get; set; }
    [Parameter] public EventCallback<AspectRatio> OnSelectRatio { get; set; }
    [Parameter] public EventCallback OnGenerateShortVideo { get; set; }
    [Parameter] public EventCallback OnDownloadShortVideo { get; set; }

    private string DownloadButtonText => $"Download Semua ({ReadyCount} klip)";

    private string FormatElapsedTime() => TimeSpan.FromSeconds(ElapsedSeconds).ToString(@"mm\:ss");

    private static string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private RenderFragment GetRatioPreview(AspectRatio ratio) => ratio switch
    {
        AspectRatio.Portrait_9x16 => @<div class="w-3 h-5 border-2 rounded-sm @(SelectedRatio == ratio ? "border-primary" : "border-muted-foreground")"></div>,
        AspectRatio.Square_1x1 => @<div class="w-4 h-4 border-2 rounded-sm @(SelectedRatio == ratio ? "border-primary" : "border-muted-foreground")"></div>,
        AspectRatio.Portrait_4x5 => @<div class="w-3.5 h-4 border-2 rounded-sm @(SelectedRatio == ratio ? "border-primary" : "border-muted-foreground")"></div>,
        AspectRatio.Landscape_16x9 => @<div class="w-5 h-3 border-2 rounded-sm @(SelectedRatio == ratio ? "border-primary" : "border-muted-foreground")"></div>,
        _ => @<div class="w-4 h-4 border-2 rounded-sm @(SelectedRatio == ratio ? "border-primary" : "border-muted-foreground")"></div>
    };

    private async Task HandleSelectRatio(AspectRatio ratio)
    {
        if (OnSelectRatio.HasDelegate)
            await OnSelectRatio.InvokeAsync(ratio);
    }
}
