@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<AuthGuard>
    <div class="min-h-screen flex flex-col">
        <header class="app-header">
            <div class="header-content flex items-center justify-between">
                <!-- Left section: Logo + Hamburger -->
                <div class="flex items-center gap-2 flex-1">
                    <button id="hamburger-button"
                            class="md:hidden flex items-center justify-center w-10 h-10 -ml-2 text-muted-foreground hover:text-foreground active:scale-95 transition-transform"
                            type="button"
                            aria-label="Toggle menu">
                        <svg id="hamburger-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line class="hamburger-line" x1="3" y1="12" x2="21" y2="12"></line>
                            <line class="hamburger-line" x1="3" y1="6" x2="21" y2="6"></line>
                            <line class="hamburger-line" x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <a href="/" class="logo">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <span>Bunbun</span>
                    </a>
                </div>

                <!-- Right section: Nav + Actions -->
                <div class="flex items-center gap-2 md:gap-4">
                    <nav class="hidden md:flex items-center gap-6 text-sm">
                        <a href="/" class="nav-link @(IsActive("/") ? "active" : "")">Generator</a>
                        <a href="/projects" class="nav-link @(IsActive("/projects") ? "active" : "")">History</a>
                        <a href="/about" class="nav-link @(IsActive("/about") ? "active" : "")">About</a>
                    </nav>
                    <div class="hidden md:block border-l border-border h-5 mx-1"></div>
                    <div class="flex items-center gap-1">
                        <ThemeToggle />
                        <SignOutButton />
                    </div>
                </div>
            </div>

            <!-- Mobile Menu (hidden by default, toggled via JS) -->
            <div id="mobile-menu" class="md:hidden hidden">
                <!-- Backdrop overlay -->
                <div id="mobile-menu-backdrop" class="fixed inset-0 z-40 bg-black/20 top-[65px]"></div>
                <!-- Menu content -->
                <div class="relative z-50 border-t border-border bg-background">
                    <nav class="flex flex-col p-4 gap-4 text-sm font-medium">
                        <a href="/" class="flex items-center gap-2 px-2 py-1 @(IsActive("/") ? "text-foreground" : "text-muted-foreground") mobile-menu-link">
                            Generator
                        </a>
                        <a href="/projects" class="flex items-center gap-2 px-2 py-1 @(IsActive("/projects") ? "text-foreground" : "text-muted-foreground") mobile-menu-link">
                            History
                        </a>
                        <a href="/about" class="flex items-center gap-2 px-2 py-1 @(IsActive("/about") ? "text-foreground" : "text-muted-foreground") mobile-menu-link">
                            About
                        </a>
                    </nav>
                </div>
            </div>
        </header>

        <main class="flex-1">
            @Body
        </main>

        <footer class="app-footer">
            <div class="footer-content">
                <p class="text-sm text-muted-foreground">© 2026 Bunbun Intelligence. B-Roll automation pipeline.</p>
            </div>
        </footer>
    </div>
</AuthGuard>

<script>
    // Mobile menu functionality with pure JavaScript
    (function() {
        let hamburgerButton = null;
        let mobileMenu = null;
        let mobileMenuBackdrop = null;
        let hamburgerIcon = null;
        let mobileMenuLinks = null;
        let isMenuOpen = false;

        function toggleMenu() {
            isMenuOpen = !isMenuOpen;

            if (isMenuOpen) {
                // Show menu
                mobileMenu.classList.remove('hidden');
                // Update icon to X
                hamburgerIcon.innerHTML = `
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                `;
            } else {
                // Hide menu
                mobileMenu.classList.add('hidden');
                // Update icon to hamburger
                hamburgerIcon.innerHTML = `
                    <line class="hamburger-line" x1="3" y1="12" x2="21" y2="12"></line>
                    <line class="hamburger-line" x1="3" y1="6" x2="21" y2="6"></line>
                    <line class="hamburger-line" x1="3" y1="18" x2="21" y2="18"></line>
                `;
            }
        }

        function closeMenu() {
            if (isMenuOpen) {
                isMenuOpen = false;
                mobileMenu.classList.add('hidden');
                // Reset icon to hamburger
                hamburgerIcon.innerHTML = `
                    <line class="hamburger-line" x1="3" y1="12" x2="21" y2="12"></line>
                    <line class="hamburger-line" x1="3" y1="6" x2="21" y2="6"></line>
                    <line class="hamburger-line" x1="3" y1="18" x2="21" y2="18"></line>
                `;
            }
        }

        function init() {
            hamburgerButton = document.getElementById('hamburger-button');
            mobileMenu = document.getElementById('mobile-menu');
            mobileMenuBackdrop = document.getElementById('mobile-menu-backdrop');
            hamburgerIcon = document.getElementById('hamburger-icon');
            mobileMenuLinks = document.querySelectorAll('.mobile-menu-link');

            if (hamburgerButton) {
                hamburgerButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Hamburger clicked!');
                    toggleMenu();
                });
            }

            if (mobileMenuBackdrop) {
                mobileMenuBackdrop.addEventListener('click', closeMenu);
            }

            // Close menu when clicking on links
            mobileMenuLinks.forEach(function(link) {
                link.addEventListener('click', closeMenu);
            });

            console.log('Mobile menu initialized');
        }

        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // Store cleanup function for Blazor disposal
        window.bunbunMobileMenuCleanup = function() {
            if (hamburgerButton) {
                hamburgerButton.removeEventListener('click', toggleMenu);
            }
            if (mobileMenuBackdrop) {
                mobileMenuBackdrop.removeEventListener('click', closeMenu);
            }
        };
    })();
</script>

@code {
    private bool _mobileMenuOpen = false;

    private bool IsActive(string href)
    {
        var relativePath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);

        if (href == "/")
        {
            // Home is active only when path is empty or starts with /editor
            return string.IsNullOrEmpty(relativePath) || relativePath.StartsWith("editor");
        }

        return relativePath.StartsWith(href.TrimStart('/'), StringComparison.OrdinalIgnoreCase);
    }

    public async ValueTask DisposeAsync()
    {
        // Clean up JavaScript event listeners
        await JSRuntime.InvokeVoidAsync("eval", "if (window.bunbunMobileMenuCleanup) { window.bunbunMobileMenuCleanup(); }");
    }
}
