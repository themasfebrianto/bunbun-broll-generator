<!DOCTYPE html>
<html lang="en" class="dark">
<script>
// MUST run synchronously before any content to prevent flash
(function(){try{var t=localStorage.getItem('theme');if(t==='light'){document.documentElement.classList.remove('dark');document.documentElement.style.colorScheme='light';}else{document.documentElement.style.colorScheme='dark';}}catch(e){}})();
</script>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <title>Bunbun B-Roll Generator</title>
    
    <!-- Tailwind CSS Play CDN -->
    <!-- Google Fonts: Inter + Geist Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          container: {
            center: true,
            padding: "2rem",
            screens: {
              "2xl": "1400px",
            },
          },
          extend: {
            colors: {
              border: "hsl(var(--border))",
              input: "hsl(var(--input))",
              ring: "hsl(var(--ring))",
              background: "hsl(var(--background))",
              foreground: "hsl(var(--foreground))",
              primary: {
                DEFAULT: "hsl(var(--primary))",
                foreground: "hsl(var(--primary-foreground))",
              },
              secondary: {
                DEFAULT: "hsl(var(--secondary))",
                foreground: "hsl(var(--secondary-foreground))",
              },
              destructive: {
                DEFAULT: "hsl(var(--destructive))",
                foreground: "hsl(var(--destructive-foreground))",
              },
              success: {
                DEFAULT: "hsl(var(--success))",
                foreground: "hsl(var(--success-foreground))",
              },
              muted: {
                DEFAULT: "hsl(var(--muted))",
                foreground: "hsl(var(--muted-foreground))",
              },
              accent: {
                DEFAULT: "hsl(var(--accent))",
                foreground: "hsl(var(--accent-foreground))",
              },
              popover: {
                DEFAULT: "hsl(var(--popover))",
                foreground: "hsl(var(--popover-foreground))",
              },
              card: {
                DEFAULT: "hsl(var(--card))",
                foreground: "hsl(var(--card-foreground))",
              },
            },
            borderRadius: {
              lg: "var(--radius)",
              md: "calc(var(--radius) - 2px)",
              sm: "calc(var(--radius) - 4px)",
            },
            fontFamily: {
              sans: ["Inter", "-apple-system", "BlinkMacSystemFont", "Segoe UI", "sans-serif"],
              mono: ["JetBrains Mono", "Fira Code", "monospace"],
            },
          },
        },
      }
    </script>
    <style type="text/tailwindcss">
      @@layer base {
        /* Vercel-Style Light Mode - Clean & Minimal */
        :root {
          --background: 0 0% 100%;
          --foreground: 0 0% 0%;
          --card: 0 0% 100%;
          --card-foreground: 0 0% 0%;
          --popover: 0 0% 100%;
          --popover-foreground: 0 0% 0%;
          --primary: 0 0% 9%;
          --primary-foreground: 0 0% 100%;
          --secondary: 0 0% 96%;
          --secondary-foreground: 0 0% 9%;
          --muted: 0 0% 96%;
          --muted-foreground: 0 0% 45%;
          --accent: 0 0% 96%;
          --accent-foreground: 0 0% 9%;
          --destructive: 0 84% 60%;
          --destructive-foreground: 0 0% 100%;
          --success: 142 76% 36%;
          --success-foreground: 0 0% 100%;
          --border: 0 0% 90%;
          --input: 0 0% 90%;
          --ring: 0 0% 9%;
          --radius: 0.5rem;
        }
        
        /* Vercel-Style Dark Mode - Pure Black */
        .dark {
          --background: 0 0% 0%;
          --foreground: 0 0% 100%;
          --card: 0 0% 7%;
          --card-foreground: 0 0% 100%;
          --popover: 0 0% 7%;
          --popover-foreground: 0 0% 100%;
          --primary: 0 0% 100%;
          --primary-foreground: 0 0% 0%;
          --secondary: 0 0% 12%;
          --secondary-foreground: 0 0% 100%;
          --muted: 0 0% 12%;
          --muted-foreground: 0 0% 65%;
          --accent: 0 0% 12%;
          --accent-foreground: 0 0% 100%;
          --destructive: 0 62% 30%;
          --destructive-foreground: 0 0% 100%;
          --success: 142 70% 45%;
          --success-foreground: 0 0% 100%;
          --border: 0 0% 18%;
          --input: 0 0% 18%;
          --ring: 0 0% 83%;
        }
      }

      @@layer components {
        /* Vercel-style header - solid bg, 1px border */
        .app-header {
          @@apply sticky top-0 z-50 w-full border-b border-border bg-background;
        }
        .header-content {
          @@apply container flex h-16 items-center justify-between;
        }
        .logo {
          @@apply flex items-center gap-2 font-semibold tracking-tight text-foreground transition-opacity hover:opacity-70;
        }
        .nav-links {
          @@apply flex items-center gap-6 text-sm;
        }
        .nav-link {
          @@apply text-muted-foreground transition-colors duration-150 hover:text-foreground;
        }
        .nav-link.active {
          @@apply text-foreground font-medium;
        }
        .app-footer {
          @@apply border-t border-border py-6 md:px-8 md:py-0;
        }
        .footer-content {
          @@apply container flex flex-col items-center justify-between gap-4 md:h-24 md:flex-row;
        }
        
        /* Vercel-style buttons */
        .btn-primary {
          @@apply inline-flex items-center justify-center rounded-lg text-sm font-medium 
                 bg-primary text-primary-foreground h-10 px-4
                 transition-opacity duration-150 hover:opacity-90
                 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2
                 disabled:pointer-events-none disabled:opacity-50;
        }
        .btn-secondary {
          @@apply inline-flex items-center justify-center rounded-lg text-sm font-medium 
                 bg-transparent text-foreground border border-border h-10 px-4
                 transition-colors duration-150 hover:bg-muted hover:border-foreground/20
                 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2
                 disabled:pointer-events-none disabled:opacity-50;
        }
        .btn-ghost {
          @@apply inline-flex items-center justify-center rounded-lg text-sm font-medium 
                 bg-transparent text-foreground h-10 px-4
                 transition-colors duration-150 hover:bg-muted
                 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2
                 disabled:pointer-events-none disabled:opacity-50;
        }
        .btn-destructive {
          @@apply inline-flex items-center justify-center rounded-lg text-sm font-medium 
                 bg-destructive text-destructive-foreground h-10 px-4
                 transition-opacity duration-150 hover:opacity-90
                 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-destructive focus-visible:ring-offset-2
                 disabled:pointer-events-none disabled:opacity-50;
        }
        
        /* Vercel-style cards - 1px border, no shadow */
        .card {
          @@apply rounded-lg border border-border bg-card text-card-foreground
                 transition-colors duration-150;
        }
        .card-hover {
          @@apply hover:border-foreground/20;
        }
        
        /* Vercel-style inputs */
        .input {
          @@apply flex h-10 w-full rounded-lg border border-border bg-transparent px-3 py-2 text-sm
                 transition-colors duration-150
                 placeholder:text-muted-foreground
                 hover:border-foreground/30
                 focus:outline-none focus:border-foreground
                 disabled:cursor-not-allowed disabled:opacity-50;
        }

        select.input {
          @@apply appearance-none bg-no-repeat pr-10 cursor-pointer;
          background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
          background-position: right 0.5rem center;
          background-size: 1.5em 1.5em;
          color-scheme: light;
        }

        .dark select.input {
          background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
          color-scheme: dark;
        }

        select.input option {
          background-color: hsl(var(--card));
          color: hsl(var(--foreground));
        }
        
        /* Vercel-style badges */
        .badge {
          @@apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium
                 bg-muted text-muted-foreground;
        }
        .badge-mono {
          @@apply font-mono text-[11px] tracking-tight;
        }
        
        /* Toast container */
        .toast-container {
          @@apply fixed bottom-4 right-4 z-[100] flex flex-col gap-2;
        }
        .toast {
          @@apply flex items-center gap-3 rounded-lg border border-border bg-card px-4 py-3 text-sm shadow-lg
                 animate-in slide-in-from-bottom-2;
        }
        .toast-success {
          @@apply border-success/30 bg-success/10 text-success;
        }
        .toast-error {
          @@apply border-destructive/30 bg-destructive/10 text-destructive;
        }
        
        /* Modal/Dialog */
        .modal-backdrop {
          @@apply fixed inset-0 z-50 bg-background/80 backdrop-blur-sm;
        }
        .modal {
          @@apply fixed left-1/2 top-1/2 z-50 w-full max-w-md -translate-x-1/2 -translate-y-1/2
                 rounded-lg border border-border bg-card p-6 shadow-lg;
        }
      }
      
      @@layer utilities {
        /* Animations */
        .animate-in {
          animation: fadeIn 0.2s ease;
        }
        .slide-in-from-bottom-2 {
          animation: slideInFromBottom 0.2s ease;
        }
        .slide-in-from-top-2 {
          animation: slideInFromTop 0.2s ease;
        }
        
        @@keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @@keyframes slideInFromBottom {
          from { opacity: 0; transform: translateY(8px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @@keyframes slideInFromTop {
          from { opacity: 0; transform: translateY(-8px); }
          to { opacity: 1; transform: translateY(0); }
        }
      }
    </style>
    
    <script>
        // Theme toggle and get functions (initialization happens inline in <html> tag)
        window.toggleTheme = () => {
            const isDark = document.documentElement.classList.toggle('dark');
            document.documentElement.style.colorScheme = isDark ? 'dark' : 'light';
            try {
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            } catch (e) {}
            return isDark;
        };

        window.getTheme = () => {
            return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        };
    </script>
    
    <!-- JSZip for client-side ZIP creation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <link rel="stylesheet" href="/app.css" />
    <link rel="stylesheet" href="BunbunBroll.styles.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <HeadOutlet />
</head>

<body class="bg-background text-foreground antialiased font-sans">
    <Routes />
    <script src="/app.js"></script>
    <script src="_framework/blazor.web.js" autostart="false"></script>
    <script>
        // Robust Blazor Server reconnection handling for mobile
        (function() {
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 30;
            let isReconnecting = false;
            let reconnectTimer = null;

            // Calculate backoff delay: starts at 1s, maxes at 30s
            function getBackoffDelay(attempt) {
                return Math.min(1000 * Math.pow(1.5, attempt), 30000);
            }

            // Show subtle reconnecting indicator
            function showReconnectingUI() {
                let indicator = document.getElementById('reconnect-indicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'reconnect-indicator';
                    indicator.innerHTML = `
                        <div style="position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
                                    background:hsl(0 0% 10%);color:white;padding:8px 16px;
                                    border-radius:8px;font-size:12px;z-index:9999;
                                    display:flex;align-items:center;gap:8px;
                                    box-shadow:0 4px 12px rgba(0,0,0,0.3);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" 
                                 stroke-width="2" style="animation:spin 1s linear infinite">
                                <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.85.99 6.57 2.57L21 8"/>
                                <path d="M21 3v5h-5"/>
                            </svg>
                            <span>Reconnecting...</span>
                        </div>
                        <style>@@keyframes spin{to{transform:rotate(360deg)}}</style>
                    `;
                    document.body.appendChild(indicator);
                }
                indicator.style.display = 'block';
            }

            function hideReconnectingUI() {
                const indicator = document.getElementById('reconnect-indicator');
                if (indicator) indicator.style.display = 'none';
            }

            // Force page reload
            function forceReload() {
                console.log('Blazor: Forcing page reload...');
                hideReconnectingUI();
                window.location.reload();
            }

            // Start Blazor with custom reconnection handling
            Blazor.start({
                reconnectionOptions: {
                    maxRetries: maxReconnectAttempts,
                    retryIntervalMilliseconds: 2000
                }
            }).then(() => {
                console.log('Blazor: Connected successfully');
                hideReconnectingUI();
                reconnectAttempts = 0;
            }).catch(err => {
                console.warn('Blazor: Initial connection failed:', err);
                // Try to reload after a delay
                setTimeout(forceReload, 3000);
            });

            // Override the default reconnection handler
            Blazor.defaultReconnectionHandler._reconnectionDisplay = {
                show: () => {
                    isReconnecting = true;
                    showReconnectingUI();
                    console.log('Blazor: Connection lost, attempting to reconnect...');
                },
                hide: () => {
                    isReconnecting = false;
                    hideReconnectingUI();
                    reconnectAttempts = 0;
                    console.log('Blazor: Reconnected successfully');
                },
                failed: () => {
                    console.log('Blazor: Reconnection failed after all attempts');
                    hideReconnectingUI();
                    // Show reload button or auto-reload
                    showReloadPrompt();
                },
                update: (currentAttempt) => {
                    reconnectAttempts = currentAttempt;
                    console.log(`Blazor: Reconnection attempt ${currentAttempt}/${maxReconnectAttempts}`);
                }
            };

            // Show reload prompt with auto-reload countdown
            function showReloadPrompt() {
                let prompt = document.getElementById('reload-prompt');
                if (!prompt) {
                    prompt = document.createElement('div');
                    prompt.id = 'reload-prompt';
                    prompt.innerHTML = `
                        <div style="position:fixed;inset:0;background:rgba(0,0,0,0.8);
                                    display:flex;align-items:center;justify-content:center;z-index:9999;">
                            <div style="background:hsl(0 0% 7%);border:1px solid hsl(0 0% 18%);
                                        padding:24px;border-radius:12px;text-align:center;max-width:300px;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" 
                                     stroke-width="1.5" style="margin:0 auto 16px;color:#fbbf24">
                                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                    <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                                </svg>
                                <h3 style="color:white;margin:0 0 8px;font-size:16px;font-weight:600;">Connection Lost</h3>
                                <p style="color:#a1a1aa;margin:0 0 16px;font-size:13px;">
                                    Auto-reload in <span id="reload-countdown">5</span>s
                                </p>
                                <button onclick="window.location.reload()" 
                                        style="background:white;color:black;border:none;padding:10px 24px;
                                               border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;">
                                    Reload Now
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(prompt);
                    
                    // Auto-reload countdown
                    let countdown = 5;
                    const countdownEl = document.getElementById('reload-countdown');
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        if (countdownEl) countdownEl.textContent = countdown;
                        if (countdown <= 0) {
                            clearInterval(countdownInterval);
                            forceReload();
                        }
                    }, 1000);
                }
            }

            // Handle visibility change (user returns to tab/app)
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    console.log('Blazor: Tab became visible, checking connection...');
                    
                    // Clear any pending reconnect timer
                    if (reconnectTimer) {
                        clearTimeout(reconnectTimer);
                        reconnectTimer = null;
                    }

                    // If we're in a reconnecting state, try to speed things up
                    if (isReconnecting) {
                        console.log('Blazor: Forcing immediate reconnection attempt...');
                        // The Blazor reconnection handler will continue automatically
                    }
                    
                    // Check if the circuit is still alive by looking for Blazor's internal state
                    // If not reconnecting but connection seems dead, reload
                    reconnectTimer = setTimeout(() => {
                        // If still showing reconnect UI after 5 seconds, force reload
                        if (document.getElementById('reconnect-indicator')?.style.display === 'block') {
                            console.log('Blazor: Connection appears dead, forcing reload...');
                            forceReload();
                        }
                    }, 5000);
                }
            });

            // Handle online/offline events
            window.addEventListener('online', () => {
                console.log('Blazor: Network is back online');
                if (isReconnecting) {
                    // Will automatically continue reconnection attempts
                } else if (document.getElementById('reload-prompt')) {
                    forceReload();
                }
            });

            window.addEventListener('offline', () => {
                console.log('Blazor: Network went offline');
            });

            // Handle page show event (for back/forward cache)
            window.addEventListener('pageshow', (event) => {
                if (event.persisted) {
                    console.log('Blazor: Page restored from bfcache, reloading...');
                    forceReload();
                }
            });
        })();
    </script>
</body>

</html>
