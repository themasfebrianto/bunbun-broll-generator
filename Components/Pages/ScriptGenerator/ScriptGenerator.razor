@page "/"
@page "/script-generator"
@rendermode InteractiveServer
@using BunbunBroll.Services
@using BunbunBroll.Orchestration
@using BunbunBroll.Models
@using BunbunBroll.Components.Views.ScriptGenerator
@implements IDisposable
@inject IScriptGenerationService ScriptService
@inject IScriptOrchestrator Orchestrator
@inject IConfiguration Configuration
@inject NavigationManager Navigation
@inject ConfigBatchGenerator BatchGenerator
@inject IJSRuntime JS
@inject BackgroundGenerationService BgService
@inject ISrtService SrtService
@inject BunbunBroll.Services.ToastService ToastService
@inject GenerationEventBus EventBus
@inject IIntelligenceService IntelligenceService
@inject IAssetBroker AssetBroker
@inject WhiskImageGenerator WhiskGenerator
@inject KenBurnsService KenBurnsService
@inject IVideoComposer VideoComposer
@inject IDownloaderService DownloaderService
@inject VideoStyleSettings StyleSettings
@inject IScriptProcessor ScriptProcessor
@inject IBrollPersistenceService BrollPersistence
@inject IBrollVideoService BrollVideo
@inject IBrollImageService BrollImage

<div class="max-w-[90rem] mx-auto pt-6 pb-8 px-4">
    <nav class="breadcrumb mb-6 flex justify-between items-center text-sm">
        <div class="flex items-center gap-2">
            @if (_currentView == "list")
            {
                <span class="breadcrumb-current font-semibold text-lg">Script Dashboard</span>
            }
            else
            {
                <a href="javascript:void(0)" @onclick="HandleBackToList" class="text-muted-foreground hover:text-primary transition-colors">Script Dashboard</a>
                <span class="text-muted-foreground/30">/</span>
                <span class="breadcrumb-current font-medium">@GetBreadcrumbTitle()</span>
            }
        </div>
    </nav>

    @* ============ Project Stepper Navigation ============ *@
    @if (_currentView == "results" || _currentView == "broll-prompts" || _currentView == "audio-assembly")
    {
        <div class="mb-6">
            <div class="flex items-center gap-0 bg-muted/30 rounded-xl p-1.5 border border-border/50 w-fit">
                @* Step 1: Script Detail *@
                <button class="flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium transition-all duration-200
                        @(_currentView == "results"
                            ? "bg-primary/15 text-primary shadow-sm border border-primary/30"
                            : "text-muted-foreground hover:text-foreground hover:bg-muted/50")"
                        @onclick='() => _currentView = "results"'>
                    <span class="flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold
                            @(_currentView == "results"
                                ? "bg-primary text-primary-foreground"
                                : "bg-muted text-muted-foreground")">1</span>
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    <span>Script Detail</span>
                </button>

                @* Connector *@
                <div class="flex items-center px-1">
                    <svg class="h-4 w-4 text-muted-foreground/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </div>

                @* Step 2: B-Roll Prompts *@
                <button class="flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium transition-all duration-200
                        @(_currentView == "broll-prompts"
                            ? "bg-primary/15 text-primary shadow-sm border border-primary/30"
                            : "text-muted-foreground hover:text-foreground hover:bg-muted/50")"
                        @onclick='() => _currentView = "broll-prompts"'>
                    <span class="flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold
                            @(_currentView == "broll-prompts"
                                ? "bg-primary text-primary-foreground"
                                : "bg-muted text-muted-foreground")">2</span>
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                    <span>B-Roll Prompts</span>
                </button>
                @* Connector 2 *@
                <div class="flex items-center px-1">
                    <svg class="h-4 w-4 text-muted-foreground/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </div>

                @* Step 3: Audio & Assembly *@
                <button class="flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-medium transition-all duration-200
                        @(_currentView == "audio-assembly"
                            ? "bg-primary/15 text-primary shadow-sm border border-primary/30"
                            : "text-muted-foreground hover:text-foreground hover:bg-muted/50")"
                        @onclick="HandleGoToAudioAssembly">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold
                            @(_currentView == "audio-assembly"
                                ? "bg-primary text-primary-foreground"
                                : "bg-muted text-muted-foreground")">3</span>
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>
                    <span>Audio & Assembly</span>
                </button>
            </div>
        </div>
    }

    @* ============ VIEW 0: Session List ============ *@
    @if (_currentView == "list")
    {
        <SessionListView 
            Sessions="_sessions"
            BRollSummaries="_brollSummaries"
            IsLoading="_isLoadingSessions"
            IsSessionRunning="BgService.IsRunning"
            GetActiveJob="(id) => BgService.GetActiveJobs().GetValueOrDefault(id)"
            OnShowBatchForm="ShowBatchForm"
            OnShowConfigForm="ShowConfigForm"
            OnViewSession="HandleViewSession"
            OnDeleteSession="HandleDeleteSession" />
    }

    @* ============ VIEW 1: Config Form ============ *@
    @if (_currentView == "config")
    {
        <ConfigFormView 
            @bind-ChannelName="_channelName"
            @bind-SelectedPatternId="_selectedPatternId"
            @bind-Topic="_topic"
            @bind-Outline="_outline"
            @bind-SourceReferences="_sourceReferences"
            @bind-TargetDuration="_targetDuration"
            ChannelNames="_channelNames"
            AvailablePatterns="_availablePatterns"
            IsGenerating="_isGenerating"
            ErrorMessage="@_errorMessage"
            OnBack='() => _currentView = "list"'
            OnGenerate="HandleGenerate" />
    }

    @* ============ VIEW 2: Progress ============ *@
    @if (_currentView == "progress")
    {
        <GenerationProgressView 
            Topic="@_topic"
            SessionId="@_sessionId"
            ProgressMessage="@_progressMessage"
            Outline="@_outline"
            ProgressPercent="(int)_progressPercent"
            CompletedPhases="_completedPhases"
            TotalPhases="_totalPhases"
            PhaseStatuses="_phaseStatuses.Select(p => new GenerationProgressView.PhaseStatusInfo 
            { 
                Name = p.Name, 
                Status = p.Status, 
                DurationTarget = p.DurationTarget, 
                WordCount = p.WordCount,
                OutlinePoints = p.OutlinePoints 
            }).ToList()"
            ErrorMessage="@_errorMessage"
            CanCancel="_sessionId != null && BgService.IsRunning(_sessionId)"
            OnCancel="HandleCancelGeneration" />
    }

    @* ============ VIEW: Batch Gen-Configs ============ *@
    @if (_currentView == "batch")
    {
        <BatchConfigView 
            @bind-Theme="_batchTheme"
            @bind-ChannelName="_batchChannelName"
            @bind-Count="_batchCount"
            @bind-PatternId="_batchPatternId"
            @bind-Seed="_batchSeed"
            ChannelNames="_channelNames"
            AvailablePatterns="_availablePatterns"
            IsGenerating="_isBatchGenerating"
            ErrorMessage="@_batchError"
            Results="_batchResults"
            OnBack="HandleBackToList"
            OnGenerate="HandleBatchGenerate"
            OnUseAll="HandleUseAllConfigs"
            OnUseConfig="HandleUseConfig" />
    }

    @* ============ VIEW 3: Results ============ *@
    @if (_currentView == "results")
    {
        <ResultsView 
            Session="_resultSession"
            SessionId="@_sessionId"
            TotalWords="_totalWords"
            TotalMinutes="_totalMinutes"
            TotalPhases="_totalPhases"
            ValidatedCount="_validatedCount"
            Sections="_resultSections"
            IsRegeneratingAll="_isRegeneratingAll"
            IsExportingLrc="_isExportingLrc"
            ErrorMessage="@_errorMessage"
            LrcExportPath="@_lrcExportPath"
            OnBackToList="HandleBackToList"
            OnRegenerateAll="HandleRegenerateAll"
            OnEditConfig="HandleEditConfig"
            OnExportLrc="HandleExportLrc"
            OnSendToBroll="HandleSendToBroll"
            OnRegeneratePhase="HandleRegeneratePhase"
            OnCopyPhaseContent="HandleCopyPhaseContent"
            OnUpdatePhaseContent="HandleUpdatePhaseContent" />
    }

    @* ============ VIEW 4: B-Roll Prompts ============ *@
    @if (_currentView == "broll-prompts")
    {
        <BrollPromptsView 
            Session="_resultSession"
            SessionId="@_sessionId"
            TotalWords="_totalWords"
            TotalMinutes="_totalMinutes"
            TotalPhases="_totalPhases"
            PromptItems="_brollPromptItems"
            IsClassifying="_isClassifyingBroll"
            ClassifyTotalSegments="_classifyTotalSegments"
            ClassifyCompletedSegments="_classifyCompletedSegments"
            ClassifyError="@_classifyError"
            IsSearchingBroll="_isSearchingBroll"
            IsDownloadingAllVideos="_isDownloadingAllVideos"
            IsRegeneratingAllKeywords="_isRegeneratingAllKeywords"
            IsGeneratingWhisk="_isGeneratingWhisk"
            WhiskGeneratedCount="_whiskGeneratedCount"
            WhiskTotalCount="_whiskTotalCount"
            OnBackToResults="HandleBackToResults"
            OnReclassify='() => RequestConfirmation("Reclassify All Prompts", "âš ï¸ DESTRUCTIVE: Ini akan me-reset SEMUA prompt dan klasifikasi media type (Video/Image) yang sudah ada. Apakah Anda yakin?", HandleReclassifyBroll)'
            OnRegenAllVideoKeywords='() => RequestConfirmation("Regen All Video Keywords", "Ini akan me-regenerate semua keyword untuk segment B-Roll Video via LLM. Prompt yang sudah ada akan diganti. Lanjutkan?", HandleRegenAllVideoKeywords)'
            OnSearchAllVideos='() => RequestConfirmation("Search All Videos", "Ini akan melakukan pencarian ulang untuk SEMUA segment video. Video yang sudah dipilih mungkin terganti. Apakah Anda yakin?", SearchBrollForAllSegmentsAsync)'
            OnDownloadAllVideos="HandleDownloadAllVideos"
            OnGenerateAllWhiskImages="HandleGenerateAllWhiskImages"
            OnGenerateAllKenBurnsVideos="HandleGenerateAllKenBurnsVideos"
            OnResetAllImageStates='() => RequestConfirmation("Reset All Images", "ðŸ—‘ï¸ DESTRUCTIVE: Ini akan menghapus SEMUA image dan video. Anda harus men-generate ulang semuanya. Yakin?", HandleResetAllImageStates)'
            OnClearAllPrompts='() => RequestConfirmation("Clear All Prompts", "âš ï¸ Ini akan menghapus SEMUA prompt text untuk segment Image Gen. Anda bisa regenerate atau resume setelahnya. Lanjutkan?", HandleClearAllPrompts)'
            OnResetAllVideoStates='() => RequestConfirmation("Reset KB Videos", "âš ï¸ Ini akan menghapus semua video Ken Burns yang sudah jadi. Image asli tetap aman. Lanjutkan?", HandleResetAllVideoStates)'
            OnGeneratePrompts="RunClassifyOnly"
            OnGenerateImagePrompts='() => RequestConfirmation("Regenerate All Image Prompts", "âš ï¸ Ini akan me-regenerate SEMUA image prompt. Prompt yang sudah ada akan ditimpa. Lanjutkan?", RunGenerateImagePrompts)'
            OnResumeImagePrompts="RunResumeImagePrompts"
            OnGenerateKeywords='() => RequestConfirmation("Regenerate All Keywords", "âš ï¸ Ini akan me-regenerate semua keyword untuk segment B-Roll Video. Keyword yang sudah ada akan ditimpa. Lanjutkan?", RunGenerateKeywords)'
            IsGeneratingImagePrompts="_isGeneratingImagePrompts"
            ImagePromptGeneratedCount="_imagePromptGeneratedCount"
            ImagePromptTotalCount="_imagePromptTotalCount"
            IsGeneratingKeywords="_isGeneratingKeywords"
            KeywordGeneratedCount="_keywordGeneratedCount"
            KeywordTotalCount="_keywordTotalCount"
            OnToggleMediaType="HandleToggleMediaType"
            OnSearchSegment="HandleSearchSingleSegment"
            OnRegenSegmentKeywords="HandleRegenSegmentKeywords"
            OnRegenImageOnly="HandleRegenImageOnly"
            OnSelectVideo="HandleSelectVideo"
            OnDownloadVideo="HandleDownloadVideo"
            OnApplyFilter="HandleApplyFilterToVideo"
            OnApplyFilterAllVideos="HandleApplyFilterAllVideos"
            OnGenerateKenBurns="HandleGenerateKenBurnsVideo"
            OnResetSegmentVideo="HandleResetVideoStateForSegment"
            OnSave="SaveBrollPromptsToDisk"
            ResolveLocalPath="ResolveLocalPath"
            GetAssetUrl="GetAssetUrl"
            PromptConfig="_imagePromptConfig"
            GlobalContext="_globalContext"
            OnRegenerateContext="HandleRegenerateGlobalContext"
            OnCookieUpdateRequested="HandleCookieUpdateRequested" />
    }

    @* ============ VIEW 5: Audio & Assembly ============ *@
    @if (_currentView == "audio-assembly")
    {
        <AudioAssemblyView 
            SessionId="@_sessionId"
            PromptItems="_brollPromptItems"
            GetAssetUrl="GetAssetUrl"
            VoPath="@_voPath"
            SrtPath="@_srtPath"
            IsVoUploading="_isVoUploading"
            IsSrtUploading="_isSrtUploading"
            IsComposing="_isComposingVideo"
            ErrorMessage="@_assemblyError"
            CompositionProgress="@_compositionProgress"
            ResultVideoPath="@_finalVideoPath"
            OnVoUpload="HandleVoUpload"
            OnSrtUpload="HandleSrtUpload"
            OnRemoveVo="HandleRemoveVo"
            OnRemoveSrt="HandleRemoveSrt"
            OnBackToPrompts='() => _currentView = "broll-prompts"'
            OnComposeVideo="HandleComposeFinalVideo" />
    }
</div>

@* ============ Edit Config Modal ============ *@
<EditConfigModal 
    IsVisible="_showEditConfig"
    IsSaving="_isSavingConfig"
    ChannelNames="_channelNames"
    @bind-Topic="_editTopic"
    @bind-Outline="_editOutline"
    @bind-SourceReferences="_editSourceReferences"
    @bind-TargetDuration="_editTargetDuration"
    @bind-ChannelName="_editChannelName"
    OnClose="CancelEditConfig"
    OnSave="SaveAndRegenerateConfig" />

@* ============ Delete Confirmation Modal ============ *@
<DeleteConfirmModal 
    IsVisible="_showDeleteConfirm"
    IsDeleting="_isDeleting"
    Target="_deleteTarget"
    OnCancel="CancelDelete"
    OnConfirm="ConfirmDelete" />

@* ============ Global Confirmation Modal ============ *@
<ConfirmationModal 
    IsVisible="_showConfirmDialog"
    Title="@_confirmTitle"
    Message="@_confirmMessage"
    OnCancel="CancelConfirm"
    OnConfirm="ExecuteConfirm" />

@* ============ Update Whisk Cookie Modal ============ *@
<Modal IsVisible="_showCookieModal"
       Title="ðŸª Update Whisk Cookie"
       OnClose="CloseCookieModal">
    <ChildContent>
        <p class="text-sm text-muted-foreground">
            Your Google account cookie for Whisk image generation has expired or is invalid. 
            Please paste a new one below to resume generation.
        </p>
        <div class="space-y-2">
            <label class="text-xs font-semibold uppercase tracking-wider text-muted-foreground">New Cookie String</label>
            <textarea class="input w-full min-h-[100px] text-sm font-mono bg-muted/30" 
                      @bind="_newWhiskCookie"
                      placeholder="Paste the full cookie string here..."></textarea>
        </div>
    </ChildContent>
    <FooterContent>
        <button class="btn-ghost" @onclick="CloseCookieModal">Cancel</button>
        <button class="btn-primary" 
                disabled="@string.IsNullOrWhiteSpace(_newWhiskCookie)"
                @onclick="SubmitCookieUpdate">
            Update & Retry
        </button>
    </FooterContent>
</Modal>
