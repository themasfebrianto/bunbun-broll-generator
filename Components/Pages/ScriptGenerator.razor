@page "/"
@page "/script-generator"
@rendermode InteractiveServer
@using BunbunBroll.Services
@using BunbunBroll.Orchestration
@using BunbunBroll.Models
@implements IDisposable
@inject IScriptGenerationService ScriptService
@inject IScriptOrchestrator Orchestrator
@inject IConfiguration Configuration
@inject NavigationManager Navigation
@inject ConfigBatchGenerator BatchGenerator
@inject IJSRuntime JS
@inject BackgroundGenerationService BgService
@inject GenerationEventBus EventBus
@inject IIntelligenceService IntelligenceService
@inject IAssetBroker AssetBroker
@inject WhiskImageGenerator WhiskGenerator
@inject KenBurnsService KenBurnsService
@inject IShortVideoComposer VideoComposer
@inject IDownloaderService DownloaderService
@inject VideoStyleSettings StyleSettings

<div class="max-w-[90rem] mx-auto pt-6 pb-8 px-4">
    <nav class="breadcrumb mb-6 flex justify-between items-center">
        <span class="breadcrumb-current">Script Dashboard</span>
    </nav>

    @* ============ VIEW 0: Session List ============ *@
    @if (_currentView == "list")
    {
        <div class="max-w-[52rem] mx-auto space-y-4">
            <div class="flex justify-end gap-3">
                <button class="btn-secondary flex items-center gap-2" @onclick="ShowBatchForm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    Batch Generate
                </button>
                <button class="btn-primary flex items-center gap-2" @onclick="ShowConfigForm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Buat Script Baru
                </button>
            </div>

            @if (_isLoadingSessions)
            {
                <div class="card p-12 text-center text-muted-foreground">
                    <svg class="animate-spin h-6 w-6 mx-auto mb-3 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Memuat sesi...
                </div>
            }
            else if (_sessions.Count == 0)
            {
                <div class="card p-12 text-center">
                    <div class="text-muted-foreground space-y-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-lg font-medium">Belum ada script</p>
                        <p class="text-sm">Klik "Buat Script Baru" untuk memulai.</p>
                    </div>
                </div>
            }
            else
            {
                @foreach (var session in _sessions)
                {
                    <div class="card p-5 cursor-pointer hover:border-primary/40 transition-colors group"
                         @onclick="() => HandleViewSession(session)">
                        <div class="flex items-start justify-between gap-4">
                            <div class="min-w-0 flex-1 space-y-1">
                                <h3 class="font-semibold text-base truncate">@session.Topic</h3>
                                <div class="flex items-center gap-2 text-xs text-muted-foreground flex-wrap">
                                    <span class="badge badge-mono text-[10px]">@session.Id</span>
                                    @if (!string.IsNullOrEmpty(session.ChannelName))
                                    {
                                        <span class="px-1.5 py-0.5 rounded bg-primary/10 text-primary text-[10px] font-medium">@session.ChannelName</span>
                                    }
                                    <span>¬∑</span>
                                    <span>@FormatDate(session.CreatedAt)</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 shrink-0">
                                @if (BgService.IsRunning(session.Id))
                                {
                                    var job = BgService.GetActiveJobs().GetValueOrDefault(session.Id);
                                    var pct = job != null && job.TotalPhases > 0 ? (double)job.CompletedPhases / job.TotalPhases * 100 : 0;
                                    <div class="text-right text-xs text-muted-foreground space-y-1">
                                        <div class="flex items-center gap-1.5">
                                            <svg class="animate-spin h-3 w-3 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span class="font-medium text-primary">@($"{pct:F0}%")</span>
                                        </div>
                                        <div class="w-16 h-1 bg-muted rounded-full overflow-hidden">
                                            <div class="h-full bg-primary rounded-full transition-all duration-500" style="width: @($"{pct:F0}%")"></div>
                                        </div>
                                    </div>
                                }
                                else if (session.Status == SessionStatus.Completed)
                                {
                                    var totalWords = session.Phases.Sum(p => p.WordCount ?? 0);
                                    var totalMins = (int)(session.Phases.Sum(p => p.DurationSeconds ?? 0) / 60);
                                    <div class="text-right text-xs text-muted-foreground">
                                        <span class="font-medium text-foreground">@totalWords</span> kata
                                        <br />~@totalMins menit
                                    </div>
                                }
                                @StatusBadge(session.Status)
                                <button class="btn-ghost text-xs px-1.5 py-1 opacity-0 group-hover:opacity-100 transition-opacity text-destructive hover:bg-destructive/10"
                                        title="Hapus sesi"
                                        @onclick="() => HandleDeleteSession(session)"
                                        @onclick:stopPropagation="true">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        @if (session.Phases.Count > 0)
                        {
                            <div class="mt-3 flex gap-[3px]">
                                @foreach (var phase in session.Phases.OrderBy(p => p.Order))
                                {
                                    var bgClass = phase.Status switch
                                    {
                                        PhaseStatus.Completed => "bg-success",
                                        PhaseStatus.Failed => "bg-destructive",
                                        PhaseStatus.InProgress => "bg-primary animate-pulse",
                                        _ => "bg-muted-foreground/20"
                                    };
                                    <div class="h-1.5 flex-1 rounded-full @bgClass" title="@phase.PhaseName (@phase.Status)"></div>
                                }
                            </div>
                        }

                        @* B-Roll metadata preview *@
                        @if (_brollSummaries.TryGetValue(session.Id, out var broll))
                        {
                            <div class="mt-3 pt-3 border-t border-border/50">
                                <div class="flex items-center gap-3 text-xs text-muted-foreground flex-wrap">
                                    @if (broll.VideoCount > 0)
                                    {
                                        <span class="inline-flex items-center gap-1">
                                            <span>üé¨</span>
                                            <span>@broll.VideoCount broll</span>
                                        </span>
                                    }
                                    @if (broll.ImageGenCount > 0)
                                    {
                                        <span class="inline-flex items-center gap-1">
                                            <span>üé®</span>
                                            <span>@broll.ImageGenCount image gen</span>
                                        </span>
                                    }
                                    @{
                                        var readyCount = broll.VideosSelected + broll.ImagesReady;
                                    }
                                    @if (readyCount > 0)
                                    {
                                        <span class="inline-flex items-center gap-1 @(readyCount >= broll.TotalSegments ? "text-success" : "")">
                                            <span>‚úÖ</span>
                                            <span>@readyCount/@broll.TotalSegments ready</span>
                                        </span>
                                    }
                                </div>

                                @if (broll.ThumbnailPaths.Count > 0)
                                {
                                    <div class="flex gap-1.5 mt-2">
                                        @foreach (var thumbPath in broll.ThumbnailPaths)
                                        {
                                            <div class="w-12 h-12 rounded-md overflow-hidden bg-muted border border-border/50">
                                                <img src="@GetAssetUrl(thumbPath)" 
                                                     alt="B-Roll thumbnail" 
                                                     class="w-full h-full object-cover" 
                                                     loading="lazy" />
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            }
        </div>
    }

    @* ============ VIEW 1: Config Form ============ *@
    @if (_currentView == "config")
    {
        <div class="max-w-[52rem] mx-auto card p-8 space-y-6">
            <div class="flex items-center gap-3 mb-2">
                <button class="btn-ghost text-sm px-2 py-1" @onclick='() => _currentView = "list"'>‚Üê Kembali</button>
                <h2 class="text-lg font-semibold">Buat Script Baru</h2>
            </div>

            @* Channel Name *@
            <div class="space-y-2">
                <label class="block text-sm font-medium">Channel <span class="text-destructive">*</span></label>
                <select class="input" @bind="_channelName">
                    <option value="">Pilih channel...</option>
                    @foreach (var ch in _channelNames)
                    {
                        <option value="@ch">@ch</option>
                    }
                </select>
            </div>

            @* Pattern Selection *@
            <div class="space-y-2">
                <label class="block text-sm font-medium">Pattern</label>
                <select class="input" @bind="_selectedPatternId">
                    <option value="">Pilih pattern...</option>
                    @foreach (var p in _availablePatterns)
                    {
                        <option value="@p.Id">@p.Name (@p.PhaseCount fase)</option>
                    }
                </select>
                @if (_selectedPattern != null)
                {
                    <p class="text-xs text-muted-foreground mt-1">@_selectedPattern.Description</p>
                }
            </div>

            @* Topic *@
            <div class="space-y-2">
                <label class="block text-sm font-medium">Topik <span class="text-destructive">*</span></label>
                <input class="input" placeholder="Judul atau topik utama video essay" @bind="_topic" />
            </div>

            @* Outline *@
            <div class="space-y-2">
                <label class="block text-sm font-medium">Outline (opsional)</label>
                <textarea class="input min-h-[100px] resize-y" placeholder="Garis besar atau poin-poin yang ingin dibahas" @bind="_outline"></textarea>
            </div>

            @* Source References *@
            <div class="space-y-2">
                <label class="block text-sm font-medium">Referensi (opsional)</label>
                <textarea class="input min-h-[80px] resize-y" placeholder="Sumber referensi, data, atau kutipan" @bind="_sourceReferences"></textarea>
            </div>

            @* Target Duration *@
            <div class="space-y-2">
                <label class="block text-sm font-medium">Target Durasi (menit)</label>
                <input type="number" class="input w-32" min="5" max="60" @bind="_targetDuration" />
            </div>

            <div class="flex gap-3 pt-2">
                <button class="btn-primary flex-1" disabled="@(!CanGenerate)" @onclick="HandleGenerate">
                    @if (_isGenerating)
                    {
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Menulis Script...</span>
                    }
                    else
                    {
                        <span>Mulai Generate</span>
                    }
                </button>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="rounded-lg border border-destructive/30 bg-destructive/10 p-3 text-destructive text-sm">@_errorMessage</div>
            }
        </div>
    }

    @* ============ VIEW 2: Progress ============ *@
    @if (_currentView == "progress")
    {
        <div class="max-w-[52rem] mx-auto card p-8 space-y-6">
            <div class="space-y-2">
            <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold">Generating: @_topic</h2>
                    <div class="flex items-center gap-2">
                        <span class="badge badge-mono">@_sessionId</span>
                        @if (_sessionId != null && BgService.IsRunning(_sessionId))
                        {
                            <button class="px-3 py-1.5 bg-destructive/15 text-destructive hover:bg-destructive/25 rounded-md text-xs font-medium transition-colors flex items-center gap-1.5"
                                    @onclick="HandleCancelGeneration">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                Batalkan
                            </button>
                        }
                    </div>
                </div>
                <p class="text-sm text-muted-foreground">@_progressMessage</p>
                @if (!string.IsNullOrWhiteSpace(_outline))
                {
                    <details class="group bg-muted/40 rounded-lg overflow-hidden border border-border/50">
                        <summary class="flex items-center gap-2 px-4 py-2.5 cursor-pointer hover:bg-muted/60 transition-colors select-none">
                            <span class="p-1 rounded-md bg-primary/10 text-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
                            </span>
                            <span class="text-xs font-semibold uppercase tracking-wider text-muted-foreground flex-1">Script Outline</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-muted-foreground group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </summary>
                        <div class="px-4 pb-4 pt-1">
                             <div class="text-sm text-foreground/80 whitespace-pre-wrap leading-relaxed pl-8 border-l-2 border-primary/20">@_outline</div>
                        </div>
                    </details>
                }
            </div>
            <div class="space-y-2">
                <div class="h-2 rounded-full bg-muted overflow-hidden">
                    <div class="h-full bg-primary rounded-full transition-all duration-500" style="width: @(_progressPercent)%"></div>
                </div>
                <p class="text-xs text-muted-foreground text-right">@_completedPhases / @_totalPhases fase</p>
            </div>
            <div class="space-y-3">
                @foreach (var phase in _phaseStatuses)
                {
                    <div class="flex items-center gap-3 text-sm">
                        @if (phase.Status == "Completed")
                        {
                            <span class="text-success text-lg">‚úì</span>
                        }
                        else if (phase.Status == "InProgress")
                        {
                            <svg class="animate-spin h-4 w-4 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        }
                        else if (phase.Status == "Failed")
                        {
                            <span class="text-destructive text-lg">‚úó</span>
                        }
                        else
                        {
                            <span class="text-muted-foreground text-lg">‚óã</span>
                        }
                        <span class="@(phase.Status == "InProgress" ? "text-foreground font-medium" : phase.Status == "Completed" ? "text-muted-foreground" : "text-muted-foreground/60")">
                            @phase.Name
                        </span>
                        <div class="ml-auto flex items-center gap-2">
                            @if (!string.IsNullOrEmpty(phase.DurationTarget))
                            {
                                <span class="text-xs text-primary/80 font-mono bg-primary/5 px-2 py-0.5 rounded">Target: @phase.DurationTarget</span>
                            }
                            @if (phase.WordCount > 0)
                            {
                                <span class="text-xs text-muted-foreground">| @phase.WordCount kata</span>
                            }
                        </div>
                    </div>
                    @if (phase.OutlinePoints?.Count > 0)
                    {
                        <div class="ml-8 mt-1 mb-1 pl-3 border-l-2 border-primary/20">
                            @foreach (var point in phase.OutlinePoints)
                            {
                                <p class="text-xs text-muted-foreground leading-relaxed">‚Ä¢ @point</p>
                            }
                        </div>
                    }
                }
            </div>
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="rounded-lg border border-destructive/30 bg-destructive/10 p-3 text-destructive text-sm">@_errorMessage</div>
            }
        </div>
    }

    @* ============ VIEW: Batch Gen-Configs ============ *@
    @if (_currentView == "batch")
    {
        <div class="max-w-[52rem] mx-auto space-y-6">
            <div class="card p-6 space-y-5">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-bold">Batch Generate Configs</h2>
                    <button class="btn-ghost text-sm" @onclick="HandleBackToList">‚Üê Kembali</button>
                </div>
                <p class="text-sm text-muted-foreground">Generate beberapa config sekaligus berdasarkan tema menggunakan AI.</p>

                @* Theme *@
                <div>
                    <label class="block text-xs font-medium text-muted-foreground mb-1.5">Tema *</label>
                    <input type="text" class="input w-full" placeholder="e.g. eschatology, sahabat, ekonomi, nabi" @bind="_batchTheme" />
                </div>

                @* Channel *@
                <div>
                    <label class="block text-xs font-medium text-muted-foreground mb-1.5">Channel *</label>
                    @if (_channelNames.Count > 0)
                    {
                        <select class="input w-full" @bind="_batchChannelName">
                            <option value="">Pilih channel...</option>
                            @foreach (var ch in _channelNames)
                            {
                                <option value="@ch">@ch</option>
                            }
                        </select>
                    }
                    else
                    {
                        <input type="text" class="input w-full" placeholder="Nama channel" @bind="_batchChannelName" />
                    }
                </div>

                <div class="grid grid-cols-2 gap-4">
                    @* Count *@
                    <div>
                        <label class="block text-xs font-medium text-muted-foreground mb-1.5">Jumlah Config</label>
                        <input type="number" class="input w-full" min="1" max="20" @bind="_batchCount" />
                    </div>
                    @* Pattern *@
                    <div>
                        <label class="block text-xs font-medium text-muted-foreground mb-1.5">Pattern</label>
                        <select class="input w-full" @bind="_batchPatternId">
                            @foreach (var p in _availablePatterns)
                            {
                                <option value="@p.Id">@p.Name</option>
                            }
                        </select>
                    </div>
                </div>

                @* Seed (optional) *@
                <div>
                    <label class="block text-xs font-medium text-muted-foreground mb-1.5">Seed / Instruksi Tambahan <span class="text-muted-foreground/60">(opsional)</span></label>
                    <textarea class="input w-full" rows="2" placeholder="e.g. gunakan angle dari sisi budaya indonesia" @bind="_batchSeed"></textarea>
                </div>

                @if (!string.IsNullOrEmpty(_batchError))
                {
                    <div class="rounded-lg border border-destructive/30 bg-destructive/10 p-3 text-destructive text-sm">@_batchError</div>
                }

                <button class="btn-primary w-full" 
                        disabled="@(!CanBatchGenerate)"
                        @onclick="HandleBatchGenerate">
                    @if (_isBatchGenerating)
                    {
                        <svg class="animate-spin h-4 w-4 mr-2 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Generating @_batchCount configs...</span>
                    }
                    else
                    {
                        <span>üöÄ Generate @_batchCount Configs</span>
                    }
                </button>
            </div>

            @* === Batch Results === *@
            @if (_batchResults.Count > 0)
            {
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-semibold">Hasil: @_batchResults.Count configs</h3>
                        <button class="btn-ghost text-xs" @onclick="HandleUseAllConfigs">Gunakan Semua ‚Üí</button>
                    </div>
                    @foreach (var (config, idx) in _batchResults.Select((c, i) => (c, i)))
                    {
                        <div class="card p-4 hover:border-primary/40 transition-colors">
                            <div class="flex items-start justify-between gap-3">
                                <div class="space-y-1.5 min-w-0 flex-1">
                                    <div class="flex items-center gap-2">
                                        <span class="flex items-center justify-center w-6 h-6 rounded-full bg-primary/15 text-primary text-xs font-bold">@(idx + 1)</span>
                                        <h4 class="font-semibold text-sm truncate">@config.Topic</h4>
                                    </div>
                                    @if (!string.IsNullOrEmpty(config.Outline))
                                    {
                                        <p class="text-xs text-muted-foreground line-clamp-2 ml-8">@config.Outline</p>
                                    }
                                    <div class="flex items-center gap-3 text-[11px] text-muted-foreground ml-8">
                                        <span>~@config.TargetDurationMinutes menit</span>
                                        @if (config.MustHaveBeats?.Count > 0)
                                        {
                                            <span>¬∑</span>
                                            <span>@config.MustHaveBeats.Count beats</span>
                                        }
                                        @if (!string.IsNullOrEmpty(config.SourceReferences))
                                        {
                                            <span>¬∑</span>
                                            <span class="truncate max-w-[200px]">@config.SourceReferences</span>
                                        }
                                    </div>
                                </div>
                                <button class="btn-primary text-xs px-3 py-1.5 flex-shrink-0" @onclick="() => HandleUseConfig(config)">
                                    Gunakan ‚Üí
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }

    @* ============ VIEW 3: Results ‚Äî Horizontal Scrollable ============ *@
    @if (_currentView == "results")
    {
        <div class="space-y-6">
            @* Header Card *@
            <div class="card p-6">
                <div class="flex items-start justify-between gap-4 mb-4">
                    <div class="space-y-1 min-w-0">
                        <h2 class="text-xl font-bold truncate">@_resultSession?.Topic</h2>
                        <div class="flex items-center gap-2 text-xs text-muted-foreground flex-wrap">
                            @if (!string.IsNullOrEmpty(_resultSession?.ChannelName))
                            {
                                <span class="px-2 py-0.5 rounded-full bg-primary/15 text-primary text-[11px] font-semibold">@_resultSession.ChannelName</span>
                            }
                            <span class="badge badge-mono text-[10px]">@_sessionId</span>
                            <span>¬∑</span>
                            <span>@_resultSession?.PatternId</span>
                            @if (_resultSession?.CompletedAt != null)
                            {
                                <span>¬∑</span>
                                <span>@FormatDate(_resultSession.CompletedAt.Value)</span>
                            }
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        @StatusBadge(_resultSession?.Status ?? SessionStatus.Pending)
                    </div>
                </div>

                @* Outline (Collapsible) *@
                @if (!string.IsNullOrWhiteSpace(_resultSession?.Outline))
                {
                    <div class="mb-6">
                        <details class="group bg-muted/40 rounded-lg overflow-hidden border border-border/50">
                            <summary class="flex items-center gap-2 px-4 py-2.5 cursor-pointer hover:bg-muted/60 transition-colors select-none">
                                <span class="p-1 rounded-md bg-primary/10 text-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
                                </span>
                                <span class="text-xs font-semibold uppercase tracking-wider text-muted-foreground flex-1">Script Outline</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-muted-foreground group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </summary>
                            <div class="px-4 pb-4 pt-1">
                                 <div class="text-sm text-foreground/80 whitespace-pre-wrap leading-relaxed pl-8 border-l-2 border-primary/20">@_resultSession.Outline</div>
                            </div>
                        </details>
                    </div>
                }

                @* Stats Row *@
                <div class="grid grid-cols-4 gap-3 mb-4">
                    <div class="text-center p-3 rounded-lg bg-muted/60">
                        <p class="text-2xl font-bold">@_totalWords</p>
                        <p class="text-[10px] text-muted-foreground uppercase tracking-wide">kata</p>
                    </div>
                    <div class="text-center p-3 rounded-lg bg-muted/60">
                        <p class="text-2xl font-bold">~@_totalMinutes</p>
                        <p class="text-[10px] text-muted-foreground uppercase tracking-wide">menit</p>
                    </div>
                    <div class="text-center p-3 rounded-lg bg-muted/60">
                        <p class="text-2xl font-bold">@_totalPhases</p>
                        <p class="text-[10px] text-muted-foreground uppercase tracking-wide">fase</p>
                    </div>
                    <div class="text-center p-3 rounded-lg bg-muted/60">
                        <p class="text-2xl font-bold">@_validatedCount</p>
                        <p class="text-[10px] text-muted-foreground uppercase tracking-wide">valid</p>
                    </div>
                </div>

                @* Action buttons *@
                <div class="flex gap-3">
                    <button class="btn-secondary text-sm" @onclick="HandleBackToList">‚Üê Daftar Script</button>
                    <button class="btn-ghost text-sm flex items-center gap-1.5"
                            disabled="@(_isRegeneratingAll)"
                            @onclick="HandleRegenerateAll">
                        @if (_isRegeneratingAll)
                        {
                            <svg class="animate-spin h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Regenerating All...</span>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                            <span>Regenerate All</span>
                        }
                    </button>
                    <button class="btn-ghost text-sm flex items-center gap-1.5"
                            @onclick="HandleEditConfig">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                        <span>Edit Config</span>
                    </button>
                    <div class="flex-1"></div>
                    <button class="btn-secondary text-sm flex items-center gap-1.5"
                            disabled="@(_isExportingLrc)"
                            @onclick="HandleExportLrc">
                        @if (_isExportingLrc)
                        {
                            <svg class="animate-spin h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Exporting...</span>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            <span>Export LRC</span>
                        }
                    </button>
                    <button class="btn-primary text-sm" @onclick="HandleSendToBroll">Kirim ke B-Roll ‚Üí</button>
                </div>
            </div>

            @* Horizontal Scrollable Phase Cards ‚Äî Full Width Script View *@
            <div class="overflow-x-auto pb-4 -mx-4 px-4">
                <div class="flex gap-5" style="min-width: max-content;">
                    @foreach (var sec in _resultSections)
                    {
                        <div class="card overflow-hidden flex-shrink-0" style="width: 720px;">
                            @* Phase Header ‚Äî Sticky *@
                            <div class="flex items-center justify-between px-6 py-4 border-b border-border/50 bg-card/95 backdrop-blur-sm cursor-pointer sticky top-0 z-10"
                                 @onclick="() => ToggleSection(sec)">
                                <div class="flex items-center gap-3">
                                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-primary/15 text-primary text-sm font-bold">@sec.Order</span>
                                    <div>
                                        <h3 class="font-semibold text-base">@sec.PhaseName</h3>
                                        <span class="text-xs text-muted-foreground">@sec.WordCount kata ¬∑ ~@((int)(sec.DurationSeconds / 60)) menit</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    @if (sec.IsFileMissing)
                                    {
                                        <span class="text-[10px] font-semibold px-1.5 py-0.5 rounded bg-warning/15 text-warning border border-warning/30" title="File konten hilang">‚ö† File Hilang</span>
                                    }
                                    @if (sec.IsValidated)
                                    {
                                        <span class="text-success text-sm flex items-center gap-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                                        </span>
                                    }
                                    @* Outline Indicator *@
                                    @if (sec.OutlinePoints?.Count > 0)
                                    {
                                        <div class="badge badge-ghost badge-sm gap-1 text-muted-foreground/60 font-normal select-none">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                                            <span class="text-[10px]">Outline</span>
                                        </div>
                                    }

                                    @* Copy Button *@
                                    <button class="btn-ghost text-xs px-2 py-1.5 flex items-center gap-1"
                                            title="Copy script"
                                            @onclick="() => HandleCopyPhaseContent(sec)"
                                            @onclick:stopPropagation="true">
                                        @if (sec.CopyState == "copied")
                                        {
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                                        }
                                        else
                                        {
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                        }
                                    </button>
                                    @* Regenerate Button *@
                                    <button class="btn-ghost text-xs px-2 py-1.5 flex items-center gap-1"
                                            disabled="@(sec.IsRegenerating)"
                                            @onclick="() => HandleRegeneratePhase(sec)"
                                            @onclick:stopPropagation="true">
                                        @if (sec.IsRegenerating)
                                        {
                                            <svg class="animate-spin h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                        }
                                        else
                                        {
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                        }
                                    </button>
                                    <span class="text-sm text-muted-foreground select-none">
                                        @(sec.IsExpanded ? "‚ñ≤" : "‚ñº")
                                    </span>
                                </div>
                            </div>

                            @* Content ‚Äî expanded by default, large readable text *@
                            @if (sec.IsExpanded)
                            {
                                <div class="px-8 py-6 overflow-y-auto" style="max-height: 75vh;">
                                    
                                    @* Missing File Warning *@
                                    @if (sec.IsFileMissing)
                                    {
                                        <div class="mb-4 p-3 rounded-lg border border-warning/30 bg-warning/10 text-warning text-sm flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" /></svg>
                                            <span>File konten hilang. Regenerasi fase ini untuk membuat ulang.</span>
                                        </div>
                                    }

                                    @* Outline Block *@
                                    @if (sec.OutlinePoints?.Count > 0)
                                    {
                                        <div class="mb-6 p-4 rounded-lg bg-muted/40 border border-border/50">
                                            <div class="text-[10px] font-bold uppercase tracking-wider text-muted-foreground mb-2 flex items-center gap-2 select-none">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                                                Setup Outline
                                            </div>
                                            <ul class="list-disc list-outside ml-4 space-y-1.5 text-sm text-foreground/80 marker:text-muted-foreground">
                                                @foreach (var point in sec.OutlinePoints)
                                                {
                                                    <li>@point</li>
                                                }
                                            </ul>
                                        </div>
                                    }

                                    <div class="prose prose-invert prose-lg max-w-none whitespace-pre-wrap leading-[1.9]">@sec.Content</div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="rounded-lg border border-destructive/30 bg-destructive/10 p-3 text-destructive text-sm">@_errorMessage</div>
            }
            @if (!string.IsNullOrEmpty(_lrcExportPath))
            {
                <div class="rounded-lg border border-success/30 bg-success/10 p-3 text-success text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    <span>LRC exported: <code class="text-xs">@_lrcExportPath</code></span>
                </div>
            }
        </div>
    }

    @* ============ VIEW 4: B-Roll Prompts ‚Äî Vertical List with Side Prompts ============ *@
    @if (_currentView == "broll-prompts")
    {
        <div class="space-y-6">
            @* Header Card *@
            <div class="card p-6">
                <div class="flex items-start justify-between gap-4 mb-4">
                    <div class="space-y-1 min-w-0">
                        <h2 class="text-xl font-bold truncate">B-Roll Prompts: @_resultSession?.Topic</h2>
                        <div class="flex items-center gap-2 text-xs text-muted-foreground flex-wrap">
                            <span class="badge badge-mono text-[10px]">@_sessionId</span>
                            <span>¬∑</span>
                            <span>@_totalWords kata</span>
                            <span>¬∑</span>
                            <span>~@_totalMinutes menit</span>
                            <span>¬∑</span>
                            <span>@_totalPhases fase</span>
                            @if (_brollPromptItems.Count > 0)
                            {
                                <span>¬∑</span>
                                <span>@_brollPromptItems.Count segments</span>
                                <span>¬∑</span>
                                <span class="px-2 py-0.5 rounded-full bg-blue-500/15 text-blue-400 text-[11px] font-semibold">üé¨ @_brollPromptItems.Count(i => i.MediaType == BrollMediaType.BrollVideo) broll</span>
                                <span class="px-2 py-0.5 rounded-full bg-purple-500/15 text-purple-400 text-[11px] font-semibold">üé® @_brollPromptItems.Count(i => i.MediaType == BrollMediaType.ImageGeneration) image gen</span>
                            }
                        </div>
                    </div>
                </div>

                @* === Redesigned Action Toolbar === *@
                <div class="space-y-4">
                    @* Row 1: Navigation & Global Settings *@
                    <div class="flex flex-wrap items-center gap-2">
                        <button class="btn-secondary text-sm flex items-center gap-2" @onclick="HandleBackToResults">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                            <span>Kembali ke Script</span>
                        </button>
                        
                        <div class="h-6 w-px bg-border mx-1"></div>
                        
                        @* Vignette Toggle *@
                        <button class="@(StyleSettings.VignetteEnabled ? "btn-primary" : "btn-secondary") text-sm flex items-center gap-2 transition-all"
                                @onclick="ToggleVignette"
                                title="Toggle vignette effect on images">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                                <circle cx="12" cy="12" r="6" stroke-width="2" class="opacity-50"/>
                            </svg>
                            <span>Vignette @(StyleSettings.VignetteEnabled ? "ON" : "OFF")</span>
                        </button>

                        <div class="h-6 w-px bg-border mx-1"></div>

                        @* Reclassify All - Destructive Action *@
                        <button class="btn-ghost text-sm flex items-center gap-2 text-orange-500 hover:text-orange-400 hover:bg-orange-500/10 border border-transparent hover:border-orange-500/20"
                                disabled="@(_isClassifyingBroll)"
                                @onclick="@(() => RequestConfirmation("Reclassify All Prompts", "‚ö†Ô∏è DESTRUCTIVE: Ini akan me-reset SEMUA prompt dan klasifikasi media type (Video/Image) yang sudah ada. Apakah Anda yakin?", HandleReclassifyBroll))"
                                title="Analyze ulang semua prompt dengan AI">
                            @if (_isClassifyingBroll)
                            {
                                <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            }
                            else
                            {
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            }
                            <span>Re-Analisis Prompt</span>
                        </button>
                    </div>

                    @* Row 2: Video B-Roll Section *@
                    @if (_brollPromptItems.Any(i => i.MediaType == BrollMediaType.BrollVideo))
                    {
                        <div class="flex items-center gap-3 p-3 rounded-lg bg-blue-500/5 border border-blue-500/20">
                            <div class="flex items-center gap-2 text-blue-400">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                <span class="font-medium text-sm">Video B-Roll</span>
                                <span class="text-xs bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded-full">@_brollPromptItems.Count(i => i.MediaType == BrollMediaType.BrollVideo)</span>
                            </div>
                            
                            <div class="h-4 w-px bg-blue-500/30"></div>

                            <button class="btn-secondary text-xs h-8 px-3 flex items-center gap-1.5"
                                    disabled="@(_isRegeneratingAllKeywords || _isClassifyingBroll)"
                                    @onclick="@(() => RequestConfirmation("Regen All Video Keywords", "Ini akan me-regenerate semua keyword untuk segment B-Roll Video via LLM. Prompt yang sudah ada akan diganti. Lanjutkan?", HandleRegenAllVideoKeywords))"
                                    title="Generate ulang keyword pencarian video">
                                @if (_isRegeneratingAllKeywords)
                                {
                                    <svg class="animate-spin h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                }
                                else
                                {
                                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                }
                                <span>Generate Keywords</span>
                            </button>

                            <button class="btn-primary text-xs h-8 px-3 flex items-center gap-1.5"
                                    disabled="@(_isSearchingBroll)"
                                    @onclick="@(() => RequestConfirmation("Search All Videos", "Ini akan melakukan pencarian ulang untuk SEMUA segment video. Video yang sudah dipilih mungkin terganti. Apakah Anda yakin?", SearchBrollForAllSegmentsAsync))"
                                    title="Cari video di Pexels/Pixabay">
                                @if (_isSearchingBroll)
                                {
                                    <svg class="animate-spin h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                }
                                else
                                {
                                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                }
                                <span>Cari Video</span>
                            </button>
                        </div>
                    }

                    @* Row 3: Image Generation Section *@
                    @if (_brollPromptItems.Any(i => i.MediaType == BrollMediaType.ImageGeneration))
                    {
                        var missingImageCount = _brollPromptItems.Count(i => 
                            i.MediaType == BrollMediaType.ImageGeneration && 
                            (i.WhiskStatus != WhiskGenerationStatus.Done || string.IsNullOrEmpty(i.WhiskImagePath) || !System.IO.File.Exists(i.WhiskImagePath)));
                        
                        var pendingVideoCount = _brollPromptItems.Count(i => 
                            i.MediaType == BrollMediaType.ImageGeneration && 
                            i.WhiskStatus == WhiskGenerationStatus.Done && 
                            i.WhiskVideoStatus != WhiskGenerationStatus.Done);
                        
                        <div class="flex items-center gap-3 p-3 rounded-lg bg-purple-500/5 border border-purple-500/20">
                            <div class="flex items-center gap-2 text-purple-400">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                <span class="font-medium text-sm">AI Image Generation</span>
                                <span class="text-xs bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded-full">@_brollPromptItems.Count(i => i.MediaType == BrollMediaType.ImageGeneration)</span>
                            </div>
                            
                            <div class="h-4 w-px bg-purple-500/30"></div>

                            @if (missingImageCount > 0)
                            {
                                <button class="btn-primary text-xs h-8 px-3 flex items-center gap-1.5 bg-purple-600 hover:bg-purple-500 border-purple-500"
                                        disabled="@(_isGeneratingWhisk)"
                                        @onclick="HandleGenerateAllWhiskImages"
                                        title="Generate gambar AI untuk segment yang belum ada">
                                    @if (_isGeneratingWhisk)
                                    {
                                        <svg class="animate-spin h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Generating...</span>
                                    }
                                    else
                                    {
                                        <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                                        <span>Generate @missingImageCount Images</span>
                                    }
                                </button>
                            }

                            @if (pendingVideoCount > 0 || _brollPromptItems.Any(i => i.IsConvertingVideo))
                            {
                                <button class="btn-secondary text-xs h-8 px-3 flex items-center gap-1.5"
                                        disabled="@(_brollPromptItems.Any(i => i.IsConvertingVideo))"
                                        @onclick="HandleGenerateAllKenBurnsVideos"
                                        title="Convert image ke video dengan efek Ken Burns">
                                    @if (_brollPromptItems.Any(i => i.IsConvertingVideo))
                                    {
                                        <svg class="animate-spin h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Converting...</span>
                                    }
                                    else
                                    {
                                        <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        <span>Buat Video (@pendingVideoCount)</span>
                                    }
                                </button>
                            }

                            <div class="flex-1"></div>

                            @* Danger Zone *@
                            @if (_brollPromptItems.Any(i => i.MediaType == BrollMediaType.ImageGeneration && i.WhiskVideoStatus == WhiskGenerationStatus.Done))
                            {
                                <button class="btn-ghost text-xs h-8 px-3 flex items-center gap-1.5 text-amber-500 hover:text-amber-400 hover:bg-amber-500/10"
                                        disabled="@(_brollPromptItems.Any(i => i.IsConvertingVideo))"
                                        @onclick="@(() => RequestConfirmation("Reset KB Videos", "‚ö†Ô∏è Ini akan menghapus semua video Ken Burns yang sudah jadi. Image asli tetap aman. Lanjutkan?", HandleResetAllVideoStates))"
                                        title="Hapus semua video (image tetap ada)">
                                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                    <span>Hapus Video</span>
                                </button>
                            }

                            @if (_brollPromptItems.Any(i => i.MediaType == BrollMediaType.ImageGeneration && i.WhiskStatus == WhiskGenerationStatus.Done))
                            {
                                <button class="btn-ghost text-xs h-8 px-3 flex items-center gap-1.5 text-red-500 hover:text-red-400 hover:bg-red-500/10"
                                        disabled="@(_isGeneratingWhisk)"
                                        @onclick="@(() => RequestConfirmation("Reset All Images", "üóëÔ∏è DESTRUCTIVE: Ini akan menghapus SEMUA image dan video. Anda harus men-generate ulang semuanya. Yakin?", HandleResetAllImageStates))"
                                        title="Hapus SEMUA image dan video (destructive)">
                                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                    <span>Reset Semua</span>
                                </button>
                            }
                        </div>
                    }
                </div>

                @* === Progress Bar (for Whisk batch) === *@
                @if (_isGeneratingWhisk && _whiskTotalCount > 0)
                {
                    <div class="mt-3 max-w-sm">
                        <div class="w-full bg-muted/30 rounded-full h-1.5">
                            <div class="bg-purple-500 h-1.5 rounded-full transition-all duration-300" 
                                 style="width: @(_whiskTotalCount > 0 ? (int)((double)_whiskGeneratedCount / _whiskTotalCount * 100) : 0)%"></div>
                        </div>
                    </div>
                }
            </div>

            @if (_isClassifyingBroll)
            {
                <div class="card p-8 text-center">
                    <div class="flex items-center justify-center gap-3 mb-4">
                        <svg class="animate-spin h-6 w-6 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-lg font-medium text-foreground">Mengklasifikasi segments...</p>
                    </div>
                    <p class="text-sm text-muted-foreground mb-5">LLM sedang menentukan B-Roll vs Image Generation untuk setiap segment</p>

                    @if (_classifyTotalSegments > 0)
                    {
                        var pct = _classifyTotalSegments > 0 ? (int)((double)_classifyCompletedSegments / _classifyTotalSegments * 100) : 0;
                        <div class="max-w-md mx-auto">
                            <div class="flex justify-between text-xs text-muted-foreground mb-1.5">
                                <span>@_classifyCompletedSegments / @_classifyTotalSegments segments</span>
                                <span>@pct%</span>
                            </div>
                            <div class="w-full h-2.5 rounded-full bg-muted overflow-hidden">
                                <div class="h-full rounded-full bg-primary transition-all duration-300 ease-out"
                                     style="width: @(pct)%"></div>
                            </div>
                        </div>
                    }
                </div>
            }
            else if (!string.IsNullOrEmpty(_classifyError))
            {
                <div class="rounded-lg border border-destructive/30 bg-destructive/10 p-3 text-destructive text-sm">@_classifyError</div>
            }
            else if (_brollPromptItems.Count == 0)
            {
                @* Empty State ‚Äî prompt user to generate *@
                <div class="card p-12 text-center">
                    <div class="h-16 w-16 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <polygon points="23 7 16 12 23 17 23 7"></polygon>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold mb-2">Siap Generate Prompts</h3>
                    <p class="text-sm text-muted-foreground mb-6 max-w-md mx-auto">LLM akan menganalisis setiap segment script dan menentukan apakah perlu <span class="text-blue-400 font-medium">B-Roll video</span> atau <span class="text-purple-400 font-medium">Image Generation</span> prompt.</p>
                    <button class="btn-primary text-sm px-6 py-2.5" @onclick="HandleSendToBroll">
                        üöÄ Generate Prompts
                    </button>
                </div>
            }
            else
            {
                @* Segment List ‚Äî Redesigned Cards *@
                <div class="space-y-4">
                    @foreach (var item in _brollPromptItems)
                    {
                        var isBroll = item.MediaType == BrollMediaType.BrollVideo;
                        var accentColor = isBroll ? "blue" : "purple";
                        var borderAccent = isBroll ? "border-l-blue-500/50" : "border-l-purple-500/50";
                        var bgTint = isBroll ? "bg-blue-500/[0.02]" : "bg-purple-500/[0.02]";

                        <div class="card overflow-hidden border-l-4 @borderAccent @bgTint">
                            @* === HEADER: Timestamp, Index, Media Toggle === *@
                            <div class="flex items-center justify-between px-5 py-3 border-b border-border/30 bg-background/50">
                                <div class="flex items-center gap-3">
                                    <span class="font-mono text-sm font-bold text-foreground bg-muted px-2.5 py-1 rounded">@item.Timestamp</span>
                                    <span class="text-sm text-muted-foreground font-medium">#@(item.Index + 1)</span>
                                </div>
                                
                                @* Media Type Toggle *@
                                <div class="flex items-center bg-muted/50 rounded-lg p-1">
                                    <button class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @(isBroll ? "bg-background text-blue-400 shadow-sm" : "text-muted-foreground hover:text-foreground")"
                                            @onclick="async () => { if(!isBroll) await HandleToggleMediaType(item); }">
                                        <span class="flex items-center gap-1.5">
                                            <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                            Video
                                        </span>
                                    </button>
                                    <button class="px-3 py-1.5 text-xs font-medium rounded-md transition-all @(!isBroll ? "bg-background text-purple-400 shadow-sm" : "text-muted-foreground hover:text-foreground")"
                                            @onclick="async () => { if(isBroll) await HandleToggleMediaType(item); }">
                                        <span class="flex items-center gap-1.5">
                                            <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                            Image
                                        </span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 divide-y lg:divide-y-0 lg:divide-x divide-border/30">
                                @* === LEFT COLUMN: Script + Controls === *@
                                <div class="p-5 space-y-4">
                                    @* === Script Text === *@
                                    <p class="text-base leading-relaxed text-foreground">@item.ScriptText</p>

                                    @* === Prompt Section === *@
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between">
                                            <label class="text-xs font-semibold uppercase tracking-wider text-muted-foreground">Prompt</label>
                                            @if (isBroll)
                                            {
                                                <button class="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1.5 transition-colors"
                                                        disabled="@(item.IsSearching || item.IsGenerating || item.IsFilteringVideo)"
                                                        @onclick="() => HandleRegenSegmentKeywords(item)">
                                                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                                    Regen
                                                </button>
                                            }
                                        </div>
                                        <textarea class="input w-full min-h-[70px] text-sm bg-background/50 resize-y"
                                                  @bind="item.Prompt"
                                                  @bind:after="SaveBrollPromptsToDisk"
                                                  placeholder="Masukkan keyword pencarian..."></textarea>
                                    </div>

                                    @if (!string.IsNullOrEmpty(item.Reasoning))
                                    {
                                        <div class="mb-3">
                                            <span class="text-[10px] uppercase tracking-wider text-muted-foreground font-semibold">Alasan</span>
                                            <p class="text-xs text-muted-foreground mt-0.5 italic">@item.Reasoning</p>
                                        </div>
                                    }

                                    @* === Visual Effects Section === *@
                                    @if (isBroll)
                                    {
                                        <div class="space-y-3 p-3 rounded-lg bg-muted/30 border border-border/30">
                                            <div class="flex items-center justify-between">
                                                <label class="text-xs font-semibold uppercase tracking-wider text-muted-foreground">Visual Effects</label>
                                                @if (item.HasVisualEffect)
                                                {
                                                    <button class="text-xs text-blue-400 hover:text-blue-300 font-medium flex items-center gap-1.5 transition-colors"
                                                            disabled="@(item.IsSearching || item.IsFilteringVideo)"
                                                            @onclick="() => HandleApplyFilterToVideo(item)">
                                                        @if (item.IsFilteringVideo)
                                                        {
                                                            <svg class="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                            </svg>
                                                            <span>Applying...</span>
                                                        }
                                                        else
                                                        {
                                                            <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                                            <span>Preview</span>
                                                        }
                                                    </button>
                                                }
                                            </div>
                                            
                                            @* Effect Selection Grid *@
                                            <div class="grid grid-cols-2 gap-3">
                                                @* Filter *@
                                                <div class="space-y-1">
                                                    <label class="text-[10px] text-muted-foreground uppercase">Filter</label>
                                                    <select class="input w-full text-xs h-9"
                                                            @bind="item.Filter"
                                                            @bind:after="async () => { item.FilteredVideoPath = null; await SaveBrollPromptsToDisk(); }">
                                                        @foreach (var filter in Enum.GetValues<VideoFilter>())
                                                        {
                                                            <option value="@filter">@GetFilterDisplayName(filter)</option>
                                                        }
                                                    </select>
                                                </div>
                                                
                                                @* Texture *@
                                                <div class="space-y-1">
                                                    <label class="text-[10px] text-muted-foreground uppercase">Texture</label>
                                                    <select class="input w-full text-xs h-9"
                                                            @bind="item.Texture"
                                                            @bind:after="async () => { item.FilteredVideoPath = null; await SaveBrollPromptsToDisk(); }">
                                                        @foreach (var texture in Enum.GetValues<VideoTexture>())
                                                        {
                                                            <option value="@texture">@GetTextureDisplayName(texture)</option>
                                                        }
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            @* Selected Effect Badge *@
                                            @if (item.HasVisualEffect)
                                            {
                                                <div class="flex items-center gap-2 pt-2 border-t border-border/20">
                                                    <span class="text-[10px] text-muted-foreground">Active:</span>
                                                    <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-amber-500/10 text-amber-400 border border-amber-500/20">
                                                        @GetEffectDisplayName(item)
                                                    </span>
                                                </div>
                                            }
                                            
                                            @if (!string.IsNullOrEmpty(item.FilterError))
                                            {
                                                <p class="text-xs text-destructive">@item.FilterError</p>
                                            }
                                        </div>
                                    }

                                    @* === Action Buttons === *@
                                    <div class="flex flex-wrap gap-2 pt-3 border-t border-border/20">
                                        @if (isBroll)
                                        {
                                            <button class="btn-primary text-xs h-9 px-4 flex items-center gap-2"
                                                    disabled="@(item.IsSearching || item.IsFilteringVideo)"
                                                    @onclick="() => HandleSearchSingleSegment(item)">
                                                @if (item.IsSearching)
                                                {
                                                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                    <span>Mencari...</span>
                                                }
                                                else if (item.AllSearchResults.Count > 0)
                                                {
                                                    var totalPages = (int)Math.Ceiling((double)item.AllSearchResults.Count / 4);
                                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                                    <span>Cari Lagi (@(item.SearchPage + 1)/@totalPages)</span>
                                                }
                                                else
                                                {
                                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                                    <span>Cari Video</span>
                                                }
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="btn-primary text-xs h-9 px-4 flex items-center gap-2 bg-purple-600 hover:bg-purple-500 border-purple-500"
                                                    disabled="@(item.IsGenerating || item.IsConvertingVideo)"
                                                    @onclick="() => HandleRegenPromptAndImage(item)">
                                                @if (item.IsGenerating)
                                                {
                                                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                    <span>Generating...</span>
                                                }
                                                else if (item.WhiskStatus == WhiskGenerationStatus.Done)
                                                {
                                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                                    <span>Regenerate</span>
                                                }
                                                else
                                                {
                                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                                                    <span>Generate Image</span>
                                                }
                                            </button>
                                        }

                                        @if (!isBroll && item.IsGenerating)
                                        {
                                            <div class="space-y-1 mt-1">
                                                <div class="progress-container h-1.5 shimmer-effect">
                                                    <div class="progress-bar bg-primary" style="width: @(item.CombinedRegenProgress)%"></div>
                                                </div>
                                                <div class="flex justify-between items-center text-[9px] text-muted-foreground font-medium px-1">
                                                    <span>@(item.CombinedRegenProgress < 50 ? "AI Prompting..." : "Generating Image...")</span>
                                                    <span>@item.CombinedRegenProgress%</span>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>

                                @* === RIGHT COLUMN: Preview Panel === *@
                                <div class="lg:col-span-1 p-5 bg-muted/20">
                                    @if (isBroll)
                                    {
                                        @* BROLL: Video Preview *@
                                        @if (item.IsSearching)
                                        {
                                            <div class="flex flex-col items-center justify-center h-full gap-3 text-muted-foreground py-12">
                                                <svg class="animate-spin h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                <span class="text-sm">Mencari video...</span>
                                            </div>
                                        }
                                        else if (!string.IsNullOrEmpty(item.SearchError))
                                        {
                                            <div class="rounded-lg border border-destructive/30 bg-destructive/10 p-4 text-destructive text-sm">
                                                @item.SearchError
                                            </div>
                                        }
                                        else if (item.SearchResults.Count > 0)
                                        {
                                            var selectedVideo = item.SearchResults.FirstOrDefault(v => v.DownloadUrl == item.SelectedVideoUrl)
                                                                ?? item.SearchResults.First();
                                            var otherVideos = item.SearchResults.Where(v => v != selectedVideo).Take(3).ToList();
                                            
                                            @* Selected Video *@
                                            <div class="space-y-3">
                                                <div class="flex items-center justify-between">
                                                    <span class="text-xs font-semibold uppercase tracking-wider text-muted-foreground">Preview</span>
                                                    @if (!string.IsNullOrEmpty(item.FilteredVideoPath))
                                                    {
                                                        <span class="text-xs px-2 py-0.5 rounded-full bg-amber-500/10 text-amber-400 border border-amber-500/20">
                                                            @GetEffectDisplayName(item)
                                                        </span>
                                                    }
                                                </div>
                                                
                                                <div class="rounded-xl overflow-hidden border border-border/50 bg-black shadow-lg">
                                                    <div class="aspect-video relative">
                                                        @{
                                                            var previewSrc = !string.IsNullOrEmpty(item.FilteredVideoPath) 
                                                                ? $"{GetAssetUrl(item.FilteredVideoPath)}?v={DateTime.Now.Ticks}" 
                                                                : selectedVideo.DownloadUrl;
                                                        }
                                                        <video src="@previewSrc"
                                                               poster="@selectedVideo.ThumbnailUrl"
                                                               class="w-full h-full object-cover"
                                                               controls muted loop preload="metadata"
                                                               playsinline>
                                                        </video>
                                                        
                                                        @* Filter Progress Overlay *@
                                                        @if (item.IsFilteringVideo)
                                                        {
                                                            <div class="absolute inset-0 bg-background/80 backdrop-blur-sm flex flex-col items-center justify-center z-10 p-4">
                                                                <div class="text-xs font-semibold mb-2">@item.FilterStatus</div>
                                                                <div class="w-full h-1.5 bg-muted rounded-full overflow-hidden">
                                                                    <div class="h-full bg-primary transition-all duration-300" style="width: @(item.FilterProgress)%"></div>
                                                                </div>
                                                            </div>
                                                        }
                                                        
                                                        @if (!string.IsNullOrEmpty(item.FilteredVideoPath))
                                                        {
                                                            <div class="absolute top-1 left-1 bg-blue-500/80 text-white text-[9px] px-1.5 py-0.5 rounded font-bold pointer-events-none">
                                                                @GetEffectDisplayName(item)
                                                            </div>
                                                            <button class="absolute top-1 right-1 bg-black/60 hover:bg-black/80 text-white rounded-full p-1"
                                                                    title="Clear Filter"
                                                                    @onclick="() => { item.FilteredVideoPath = null; }">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                                            </button>
                                                        }
                                                        else
                                                        {
                                                            <div class="absolute top-1 left-1 bg-black/60 text-white text-[9px] px-1.5 py-0.5 rounded pointer-events-none">@selectedVideo.Provider</div>
                                                            <div class="absolute top-1 right-1 bg-primary/80 text-white text-[9px] px-1.5 py-0.5 rounded font-semibold pointer-events-none">‚úì Selected</div>
                                                        }
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(selectedVideo.Quality))
                                                    {
                                                        <div class="px-2 py-1 text-[10px] text-muted-foreground">@selectedVideo.Quality ¬∑ @(selectedVideo.Width)√ó@(selectedVideo.Height) ¬∑ @(selectedVideo.DurationSeconds)s</div>
                                                    }
                                                </div>
                                            </div>

                                            @* Suggestion Thumbnails *@
                                            @if (otherVideos.Count > 0)
                                            {
                                                <div>
                                                    <span class="text-[10px] uppercase tracking-wider text-muted-foreground font-semibold">Alternatif</span>
                                                    <div class="grid grid-cols-3 gap-1.5 mt-1">
                                                        @foreach (var video in otherVideos)
                                                        {
                                                            <div class="rounded-md overflow-hidden border border-border/30 bg-background/40 hover:border-primary/50 transition-colors cursor-pointer opacity-70 hover:opacity-100"
                                                                 @onclick="() => HandleSelectVideo(item, video)"
                                                                 title="Klik untuk memilih video ini">
                                                                <div class="aspect-video relative">
                                                                    <video src="@video.DownloadUrl"
                                                                           poster="@video.ThumbnailUrl"
                                                                           class="w-full h-full object-cover"
                                                                           muted loop preload="metadata" playsinline
                                                                           onmouseover="this.play()"
                                                                           onmouseout="this.pause();this.currentTime=0;">
                                                                    </video>
                                                                    <div class="absolute bottom-0.5 right-0.5 bg-black/70 text-white text-[8px] px-1 py-0.5 rounded font-mono pointer-events-none">@(video.DurationSeconds)s</div>
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="flex items-center justify-center h-full text-muted-foreground text-xs py-8">
                                                Belum ada hasil pencarian
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        @* IMAGE_GEN: Whisk Status *@
                                        @if (item.WhiskStatus == WhiskGenerationStatus.Pending)
                                        {
                                            <div class="flex flex-col items-center justify-center h-full gap-2 py-8">
                                                <div class="h-12 w-12 rounded-full bg-amber-500/10 flex items-center justify-center text-2xl">‚è≥</div>
                                                <span class="text-xs text-amber-400">Menunggu generate</span>
                                                <span class="text-[10px] text-muted-foreground">Klik "Generate Image" di bawah prompt</span>
                                            </div>
                                        }
                                        else if (item.WhiskStatus == WhiskGenerationStatus.Generating)
                                        {
                                            <div class="flex flex-col items-center justify-center h-full gap-2 py-8 text-purple-400">
                                                <svg class="animate-spin h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                <span class="text-xs">Generating via Whisk...</span>
                                            </div>
                                        }
                                        else if (item.WhiskStatus == WhiskGenerationStatus.Done && !string.IsNullOrEmpty(item.WhiskImagePath))
                                        {
                                            <div class="space-y-2">
                                                <div class="flex items-center justify-between py-1">
                                                    <div class="flex items-center gap-2 text-emerald-400 text-xs font-medium">
                                                        <span>‚úÖ Generated @(item.WhiskVideoStatus == WhiskGenerationStatus.Done ? "+ üé•" : "")</span>
                                                    </div>
                                                    @if (!item.IsConvertingVideo)
                                                    {
                                                        <button class="btn btn-ghost btn-xs text-primary hover:bg-primary/10 gap-1 p-1 h-6" 
                                                                title="@(item.WhiskVideoStatus == WhiskGenerationStatus.Done ? "Re-convert with current motion" : "Convert to Ken Burns Video")"
                                                                @onclick="() => HandleGenerateKenBurnsVideo(item)">
                                                            üé• @(item.WhiskVideoStatus == WhiskGenerationStatus.Done ? "Re-convert" : "Convert")
                                                        </button>
                                                    }
                                                </div>

                                                @if (item.WhiskVideoStatus == WhiskGenerationStatus.Done && !string.IsNullOrEmpty(item.WhiskVideoPath) && System.IO.File.Exists(ResolveLocalPath(item.WhiskVideoPath)))
                                                {
                                                    <div class="rounded-lg overflow-hidden border border-primary/30 bg-black aspect-video">
                                                        <video src="@GetAssetUrl(item.WhiskVideoPath)" 
                                                               class="w-full h-full object-cover" controls loop muted playsinline></video>
                                                    </div>
                                                }
                                                else if (item.IsConvertingVideo)
                                                {
                                                    <div class="rounded-lg border border-border/30 bg-muted/20 aspect-video flex flex-col items-center justify-center gap-3">
                                                        <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                        </svg>
                                                        <span class="text-[10px] text-muted-foreground animate-pulse">Converting to Ken Burns...</span>
                                                    </div>
                                                }
                                                else if (System.IO.File.Exists(ResolveLocalPath(item.WhiskImagePath)))
                                                {
                                                    <div class="rounded-lg overflow-hidden border border-border/30">
                                                        <img src="@GetAssetUrl(item.WhiskImagePath!)" alt="Generated image" class="w-full h-auto" />
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="text-xs text-yellow-500">‚ö†Ô∏è File not found (@ResolveLocalPath(item.WhiskImagePath))</div>
                                                }

                                                @if (item.WhiskVideoStatus == WhiskGenerationStatus.Failed)
                                                {
                                                    <div class="text-[9px] text-destructive bg-destructive/10 p-1.5 rounded border border-destructive/20 mt-1">
                                                        ‚ùå Error: @item.WhiskVideoError
                                                    </div>
                                                }

                                                <div class="flex items-center justify-between mt-1">
                                                    <div class="text-[10px] text-muted-foreground font-mono truncate flex-1">@System.IO.Path.GetFileName(item.WhiskImagePath)</div>
                                                    <div class="flex items-center gap-1.5">
                                                        <span class="text-[10px] text-muted-foreground">üé•</span>
                                                        <select class="bg-muted/50 border border-border/30 rounded px-1.5 py-0.5 text-[10px] focus:ring-1 focus:ring-primary cursor-pointer"
                                                                value="@item.KenBurnsMotion"
                                                                disabled="@item.IsConvertingVideo"
                                                                @onchange="async (e) => { if (Enum.TryParse<KenBurnsMotionType>(e.Value?.ToString(), out var m)) { item.KenBurnsMotion = m; await SaveBrollPromptsToDisk(); } }">
                                                            @foreach (var motion in Enum.GetValues<KenBurnsMotionType>().Where(m => m != KenBurnsMotionType.Random && m != KenBurnsMotionType.None))
                                                            {
                                                                <option value="@motion">@motion</option>
                                                            }
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                        else if (item.WhiskStatus == WhiskGenerationStatus.Failed)
                                        {
                                            <div class="rounded-md border border-destructive/30 bg-destructive/10 p-2 text-destructive text-xs">
                                                ‚ùå Gagal: @item.WhiskError
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@* ============ Edit Config Modal ============ *@
@if (_showEditConfig && _resultSession != null)
{
    <div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" @onclick="CancelEditConfig">
        <div class="card p-6 max-w-2xl w-full space-y-6 max-h-[90vh] overflow-y-auto" @onclick:stopPropagation="true">
            <h3 class="font-semibold text-lg border-b border-border/50 pb-3">Edit Script Config</h3>
            
            <div class="space-y-4">
                @* Topic *@
                <div class="space-y-2">
                    <label class="block text-sm font-medium">Topik</label>
                    <input class="input" @bind="_editTopic" />
                </div>

                @* Channel & Duration Row *@
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium">Channel</label>
                        @if (_channelNames.Count > 0)
                        {
                            <select class="input w-full" @bind="_editChannelName">
                                @foreach (var ch in _channelNames)
                                {
                                    <option value="@ch">@ch</option>
                                }
                            </select>
                        }
                        else
                        {
                            <input class="input" @bind="_editChannelName" />
                        }
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium">Target Durasi (menit)</label>
                        <input type="number" class="input" min="5" max="60" @bind="_editTargetDuration" />
                    </div>
                </div>

                @* Outline *@
                <div class="space-y-2">
                    <label class="block text-sm font-medium">Outline</label>
                    <textarea class="input min-h-[120px] resize-y font-mono text-sm" @bind="_editOutline"></textarea>
                    <p class="text-xs text-muted-foreground">Modify outline or add "### MUST HAVE BEATS" sections here.</p>
                </div>

                @* References *@
                <div class="space-y-2">
                    <label class="block text-sm font-medium">Referensi</label>
                    <textarea class="input min-h-[80px] resize-y text-sm" @bind="_editSourceReferences"></textarea>
                </div>
            </div>

            <div class="flex gap-3 pt-2">
                <button class="btn-secondary flex-1" @onclick="CancelEditConfig">Batal</button>
                <button class="btn-primary flex-1" 
                        disabled="@(_isSavingConfig)"
                        @onclick="SaveAndRegenerateConfig">
                    @if (_isSavingConfig)
                    {
                        <svg class="animate-spin h-4 w-4 mr-2 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Simpan & Regenerate</span>
                    }
                    else
                    {
                        <span>Simpan & Regenerate All</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@* ============ Delete Confirmation Modal ============ *@
@if (_showDeleteConfirm)
{
    <div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" @onclick="CancelDelete">
        <div class="card p-6 max-w-sm w-full space-y-4" @onclick:stopPropagation="true">
            <h3 class="font-semibold text-lg">Hapus Script?</h3>
            <p class="text-sm text-muted-foreground">
                Script "<span class="font-medium text-foreground">@_deleteTarget?.Topic</span>" akan dihapus beserta semua file-nya.
            </p>
            <div class="flex gap-3 pt-2">
                <button class="btn-secondary flex-1" @onclick="CancelDelete">Batal</button>
                <button class="btn-primary flex-1 !bg-destructive hover:!bg-destructive/90" 
                        disabled="@_isDeleting"
                        @onclick="ConfirmDelete">
                    @if (_isDeleting)
                    {
                        <svg class="animate-spin h-4 w-4 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    }
                    Hapus
                </button>
            </div>
        </div>
    </div>
}

@code {
    // Query parameters for deep linking (e.g. from /video page)
    [SupplyParameterFromQuery(Name = "sessionId")]
    public string? QuerySessionId { get; set; }

    [SupplyParameterFromQuery(Name = "view")]
    public string? QueryView { get; set; }

    // Views: list, config, progress, results, broll-prompts
    private string _currentView = "list";
    private List<ScriptGenerationSession> _sessions = new();
    private bool _isLoadingSessions = true;
    private Dictionary<string, BrollSessionSummary> _brollSummaries = new();

    // Event bus subscriptions
    private IDisposable? _progressSubscription;
    private IDisposable? _listSubscription;

    // Config
    private List<ScriptPattern> _availablePatterns = new();
    private List<string> _channelNames = new();
    private string _selectedPatternId = "";
    private ScriptPattern? _selectedPattern => _availablePatterns.FirstOrDefault(p => p.Id == _selectedPatternId);
    private string _channelName = "";
    private string _topic = "";
    private string? _outline;
    private string? _sourceReferences;
    private int _targetDuration = 30;
    private bool _isGenerating = false;
    private bool _isCancelling = false;
    private string? _errorMessage;
    private string? _saveError;

    // Progress
    private string? _sessionId;
    private string? _progressMessage;
    private double _progressPercent;
    private int _completedPhases;
    private int _totalPhases;
    private List<PhaseStatusItem> _phaseStatuses = new();

    // Results
    private ScriptGenerationSession? _resultSession;
    private List<ResultSection> _resultSections = new();
    private int _totalWords;
    private int _totalMinutes;
    private int _validatedCount;
    private bool _isRegeneratingAll;
    private bool _isExportingLrc;
    private string? _lrcExportPath;

    // Broll Prompts
    private List<BrollPromptItem> _brollPromptItems = new();
    private bool _isClassifyingBroll;
    private int _classifyTotalSegments;
    private int _classifyCompletedSegments;
    private string? _classifyError;
    private bool _isSearchingBroll; // Phase 1: auto-search all broll segments
    private bool _isRegeneratingAllKeywords; // Regen all video keywords
    private bool _isGeneratingWhisk; // Phase 2: generate all Whisk images
    private int _whiskGeneratedCount;
    private int _whiskTotalCount;

    // Delete
    private bool _showDeleteConfirm;
    private ScriptGenerationSession? _deleteTarget;

    // Batch Gen-Configs
    private string _batchTheme = "";
    private string _batchChannelName = "";
    private int _batchCount = 10;
    private string _batchPatternId = "";
    private string? _batchSeed;
    private bool _isBatchGenerating;
    private string? _batchError;
    private List<GeneratedConfig> _batchResults = new();
    private bool _isDeleting;

    // Edit Config
    private bool _showEditConfig;
    private bool _isSavingConfig;
    private string _editTopic = "";
    private string? _editOutline;
    private string? _editSourceReferences;
    private int _editTargetDuration;
    private string _editChannelName = "";

    private bool CanGenerate => !string.IsNullOrWhiteSpace(_topic)
        && !string.IsNullOrWhiteSpace(_selectedPatternId)
        && !string.IsNullOrWhiteSpace(_channelName)
        && !_isGenerating;

    protected override async Task OnInitializedAsync()
    {
        // Load channel names from config
        _channelNames = Configuration.GetSection("Channels").Get<List<string>>() ?? new List<string>();

        await LoadSessionsAsync();
        _availablePatterns = await ScriptService.GetAvailablePatternsAsync();
        if (_availablePatterns.Count == 1)
            _selectedPatternId = _availablePatterns[0].Id;
        if (_channelNames.Count == 1)
        {
            _channelName = _channelNames[0];
            _batchChannelName = _channelNames[0];
        }
        if (_availablePatterns.Count == 1)
            _batchPatternId = _availablePatterns[0].Id;

        // Handle deep link from Video page (e.g. ?sessionId=abc&view=broll-prompts)
        if (!string.IsNullOrEmpty(QuerySessionId))
        {
            var session = await ScriptService.GetSessionAsync(QuerySessionId);
            if (session != null && session.Status == SessionStatus.Completed)
            {
                _sessionId = session.Id;
                _resultSession = session;
                _totalPhases = session.Phases.Count;
                await LoadResultSections(session);

                if (QueryView == "broll-prompts")
                {
                    await LoadBrollPromptsFromDisk();
                    _currentView = "broll-prompts";
                    // Auto-search broll videos for segments that have no search results
                    if (_brollPromptItems.Any(i => i.MediaType == BrollMediaType.BrollVideo && i.SearchResults.Count == 0))
                    {
                        _ = Task.Run(async () =>
                        {
                            await InvokeAsync(async () =>
                            {
                                await SearchBrollForAllSegmentsAsync();
                                StateHasChanged();
                            });
                        });
                    }
                }
                else
                {
                    await LoadBrollPromptsFromDisk();
                    _currentView = "broll-prompts";
                    _ = AutoSearchMissingBrollSegments();
                }
                return;
            }
        }

        // Subscribe to event bus for all running sessions (for list view live updates)
        SubscribeToRunningSessionsForList();
    }

    private void SubscribeToRunningSessionsForList()
    {
        _listSubscription?.Dispose();
        foreach (var session in _sessions.Where(s => BgService.IsRunning(s.Id)))
        {
            SubscribeToSessionForList(session.Id);
        }
    }

    private void SubscribeToSessionForList(string sessionId)
    {
        var sub = EventBus.Subscribe(sessionId, evt =>
        {
            InvokeAsync(() =>
            {
                if (evt.Type == GenerationEventType.SessionCompleted ||
                    evt.Type == GenerationEventType.SessionFailed)
                {
                    // Reload session list to reflect final status
                    _ = InvokeAsync(async () =>
                    {
                        await LoadSessionsAsync();
                        StateHasChanged();
                    });
                }
                else if (_currentView == "list")
                {
                    StateHasChanged();
                }
            });
        });
        // Store for cleanup; we reuse _listSubscription as a composite
        _listSubscriptions.Add(sub);
    }

    private readonly List<IDisposable> _listSubscriptions = new();

    private async Task LoadSessionsAsync()
    {
        _isLoadingSessions = true;
        try
        {
            _sessions = await ScriptService.ListSessionsAsync();
            await LoadBrollSummariesAsync();
        }
        catch { _sessions = new(); }
        finally { _isLoadingSessions = false; }
    }

    private async Task LoadBrollSummariesAsync()
    {
        _brollSummaries.Clear();
        foreach (var session in _sessions.Where(s => s.Status == SessionStatus.Completed))
        {
            try
            {
                var filePath = Path.Combine(session.OutputDirectory, "broll-prompts.json");
                if (!File.Exists(filePath)) continue;

                var json = await File.ReadAllTextAsync(filePath);
                var items = System.Text.Json.JsonSerializer.Deserialize<List<BrollPromptSaveItem>>(json, new System.Text.Json.JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true,
                    Converters = { new System.Text.Json.Serialization.JsonStringEnumConverter() }
                });

                if (items == null || items.Count == 0) continue;

                var summary = new BrollSessionSummary
                {
                    TotalSegments = items.Count,
                    VideoCount = items.Count(i => i.MediaType == BrollMediaType.BrollVideo),
                    ImageGenCount = items.Count(i => i.MediaType == BrollMediaType.ImageGeneration),
                    VideosSelected = items.Count(i => !string.IsNullOrEmpty(i.SelectedVideoUrl)),
                    ImagesReady = items.Count(i => i.WhiskStatus == WhiskGenerationStatus.Done),
                    ThumbnailPaths = items
                        .Where(i => !string.IsNullOrEmpty(i.WhiskImagePath) && File.Exists(i.WhiskImagePath))
                        .Take(4)
                        .Select(i => i.WhiskImagePath!)
                        .ToList()
                };
                _brollSummaries[session.Id] = summary;
            }
            catch { /* skip sessions with unreadable broll data */ }
        }
    }

    private void ShowConfigForm()
    {
        _currentView = "config";
        _topic = "";
        _outline = null;
        _sourceReferences = null;
        _errorMessage = null;
    }

    // ===== Batch Gen-Configs =====

    private void ShowBatchForm()
    {
        _currentView = "batch";
        _batchTheme = "";
        _batchSeed = null;
        _batchError = null;
        _batchResults.Clear();
    }

    private bool CanBatchGenerate => !string.IsNullOrWhiteSpace(_batchTheme)
        && !string.IsNullOrWhiteSpace(_batchChannelName)
        && !_isBatchGenerating;

    private async Task HandleBatchGenerate()
    {
        if (!CanBatchGenerate) return;
        _isBatchGenerating = true;
        _batchError = null;
        _batchResults.Clear();
        StateHasChanged();

        try
        {
            var configs = await BatchGenerator.GenerateConfigsAsync(
                _batchTheme, _batchChannelName, _batchCount, _batchSeed);
            _batchResults = configs;
        }
        catch (Exception ex) { _batchError = $"Gagal: {ex.Message}"; }
        finally { _isBatchGenerating = false; StateHasChanged(); }
    }

    private void HandleUseConfig(GeneratedConfig config)
    {
        _topic = config.Topic;
        _outline = config.Outline;
        
        // Append must-have beats to outline to ensure they are distributed
        if (config.MustHaveBeats?.Count > 0)
        {
            var beats = string.Join("\n", config.MustHaveBeats.Select(b => $"- {b}"));
            if (!string.IsNullOrWhiteSpace(_outline))
                _outline += "\n\n### MUST HAVE BEATS:\n" + beats;
            else
                _outline = "### MUST HAVE BEATS:\n" + beats;
        }

        _sourceReferences = config.SourceReferences;
        _targetDuration = config.TargetDurationMinutes;
        _channelName = config.ChannelName;
        _selectedPatternId = !string.IsNullOrEmpty(_batchPatternId) ? _batchPatternId : _selectedPatternId;
        _errorMessage = null;
        _currentView = "config";
    }

    private void HandleUseAllConfigs()
    {
        if (_batchResults.Count > 0)
            HandleUseConfig(_batchResults[0]);
    }

    // ===== Edit Config =====

    private void HandleEditConfig()
    {
        if (_resultSession == null) return;
        _editTopic = _resultSession.Topic;
        _editOutline = _resultSession.Outline;
        _editSourceReferences = _resultSession.SourceReferences;
        _editTargetDuration = _resultSession.TargetDurationMinutes;
        _editChannelName = _resultSession.ChannelName;
        _showEditConfig = true;
    }

    private void CancelEditConfig()
    {
        _showEditConfig = false;
        _isSavingConfig = false;
    }

    private async Task SaveAndRegenerateConfig()
    {
        if (_resultSession == null) return;
        _isSavingConfig = true;
        _errorMessage = null;

        try
        {
            var config = new ScriptConfig
            {
                Topic = _editTopic,
                Outline = _editOutline,
                TargetDurationMinutes = _editTargetDuration,
                SourceReferences = _editSourceReferences,
                ChannelName = _editChannelName
            };

            await ScriptService.UpdateSessionAsync(_resultSession.Id, config);
            
            // Update local state
            _resultSession.Topic = config.Topic;
            _resultSession.Outline = config.Outline;
            _resultSession.TargetDurationMinutes = config.TargetDurationMinutes;
            _resultSession.SourceReferences = config.SourceReferences;
            _resultSession.ChannelName = config.ChannelName;
            
            _showEditConfig = false;
            
            // Trigger regeneration
            await HandleRegenerateAll();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Gagal menyimpan config: {ex.Message}";
        }
        finally
        {
            _isSavingConfig = false;
            StateHasChanged();
        }
    }

    // ===== Delete Session =====

    private void HandleDeleteSession(ScriptGenerationSession session)
    {
        _deleteTarget = session;
        _showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        _showDeleteConfirm = false;
        _deleteTarget = null;
    }

    private async Task ConfirmDelete()
    {
        if (_deleteTarget == null) return;
        _isDeleting = true;
        try
        {
            await ScriptService.DeleteSessionAsync(_deleteTarget.Id);
            _sessions.Remove(_deleteTarget);
        }
        catch (Exception ex) { _errorMessage = $"Gagal menghapus: {ex.Message}"; }
        finally
        {
            _isDeleting = false;
            _showDeleteConfirm = false;
            _deleteTarget = null;
            StateHasChanged();
        }
    }

    // ===== View Session =====

    private async Task HandleViewSession(ScriptGenerationSession session)
    {
        _sessionId = session.Id;
        _resultSession = session;
        _totalPhases = session.Phases.Count;

        if (session.Status == SessionStatus.Completed)
        {
            await LoadResultSections(session);
            await LoadBrollPromptsFromDisk();
            _currentView = "broll-prompts";
            _ = AutoSearchMissingBrollSegments();
        }
        else if (session.Status == SessionStatus.Running || session.Status == SessionStatus.Failed || BgService.IsRunning(session.Id))
        {
            _phaseStatuses = session.Phases.OrderBy(p => p.Order).Select(p => new PhaseStatusItem
            {
                PhaseId = p.PhaseId, Name = p.PhaseName, Order = p.Order,
                Status = p.Status.ToString(), WordCount = p.WordCount ?? 0
            }).ToList();
            _completedPhases = session.Phases.Count(p => p.Status == PhaseStatus.Completed);
            _progressPercent = _totalPhases > 0 ? (double)_completedPhases / _totalPhases * 100 : 0;
            _progressMessage = session.ErrorMessage ?? "Sedang berjalan...";
            _errorMessage = session.Status == SessionStatus.Failed ? session.ErrorMessage : null;
            _currentView = "progress";

            // Subscribe to event bus if still running
            if (BgService.IsRunning(session.Id))
            {
                SubscribeToProgress(session.Id);
            }
        }
    }

    private async Task LoadResultSections(ScriptGenerationSession session)
    {
        _resultSections.Clear();
        
        // Load outline distribution
        Dictionary<string, List<string>> outlineDist = new();
        if (!string.IsNullOrEmpty(session.OutlineDistributionJson))
        {
            try { outlineDist = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, List<string>>>(session.OutlineDistributionJson) ?? new(); }
            catch { /* ignore */ }
        }

        foreach (var phase in session.Phases.OrderBy(p => p.Order))
        {
            var content = "";
            var isMissing = false;
            var debugInfo = "";

            // Strategy 1: Load from DB path directly
            if (!string.IsNullOrEmpty(phase.ContentFilePath) && File.Exists(phase.ContentFilePath))
            {
                content = await File.ReadAllTextAsync(phase.ContentFilePath);
            }
            // Strategy 2: Load relative to CWD (if path is relative)
            else if (!string.IsNullOrEmpty(phase.ContentFilePath) && File.Exists(Path.Combine(Directory.GetCurrentDirectory(), phase.ContentFilePath)))
            {
                content = await File.ReadAllTextAsync(Path.Combine(Directory.GetCurrentDirectory(), phase.ContentFilePath));
            }
            // Strategy 3: Construct expected path manually
            else
            {
                var expectedPath = Path.Combine(Directory.GetCurrentDirectory(), "output", "scripts", session.Id, $"{phase.Order:D2}-{phase.PhaseId}.md");
                if (File.Exists(expectedPath))
                {
                    content = await File.ReadAllTextAsync(expectedPath);
                }
                else
                {
                    isMissing = true;
                    // Gather debug info to show user
                    debugInfo = $"DB Path: '{phase.ContentFilePath}'\n" +
                                $"CWD: '{Directory.GetCurrentDirectory()}'\n" +
                                $"Tried constructed: '{expectedPath}'";
                }
            }

            List<string>? points = null;
            if (outlineDist.TryGetValue(phase.PhaseId, out var pts)) points = pts;

            _resultSections.Add(new ResultSection
            {
                PhaseId = phase.PhaseId,
                PhaseName = phase.PhaseName,
                Order = phase.Order,
                Content = isMissing ? debugInfo : content, // Show debug info in content if missing, or handle in UI
                WordCount = phase.WordCount ?? 0,
                DurationSeconds = phase.DurationSeconds ?? 0,
                IsValidated = phase.IsValidated,
                IsExpanded = true,
                OutlinePoints = points,
                IsFileMissing = isMissing
            });
        }
        _totalWords = session.Phases.Sum(p => p.WordCount ?? 0);
        _totalMinutes = (int)(session.Phases.Sum(p => p.DurationSeconds ?? 0) / 60);
        _validatedCount = session.Phases.Count(p => p.IsValidated);
    }

    // ===== Generate =====

    private async Task HandleGenerate()
    {
        if (!CanGenerate) return;

        // #3: Guard against duplicate generation
        if (_sessionId != null && BgService.IsRunning(_sessionId))
        {
            _errorMessage = "Session ini sedang dalam proses generasi. Tunggu sampai selesai atau batalkan dulu.";
            return;
        }

        _isGenerating = true;
        _errorMessage = null;

        try
        {
            var session = await ScriptService.CreateSessionAsync(
                _selectedPatternId, _topic, _outline, _targetDuration, _sourceReferences, _channelName);
            _sessionId = session.Id;
            _totalPhases = session.Phases.Count;
            _completedPhases = 0;
            _progressPercent = 0;
            _progressMessage = "Mempersiapkan...";

            _phaseStatuses = session.Phases.OrderBy(p => p.Order).Select(p => new PhaseStatusItem
            {
                PhaseId = p.PhaseId, Name = p.PhaseName, Order = p.Order, Status = "Pending"
            }).ToList();

            _currentView = "progress";
            StateHasChanged();

            // Subscribe to event bus for progress updates
            SubscribeToProgress(session.Id);

            // Also subscribe in list view for live updates
            SubscribeToSessionForList(session.Id);

            // Fire-and-forget: generation runs in background
            BgService.EnqueueGeneration(session.Id);
        }
        catch (Exception ex) { _errorMessage = $"Error: {ex.Message}"; }
        finally { _isGenerating = false; StateHasChanged(); }
    }

    private void SubscribeToProgress(string sessionId)
    {
        _progressSubscription?.Dispose();
        _progressSubscription = EventBus.Subscribe(sessionId, evt =>
        {
            InvokeAsync(() =>
            {
                switch (evt.Type)
                {
                    case GenerationEventType.PhaseStarted:
                    case GenerationEventType.PhaseCompleted:
                    case GenerationEventType.PhaseFailed:
                        var phase = _phaseStatuses.FirstOrDefault(p => p.PhaseId == evt.PhaseId);
                        if (phase != null)
                        {
                            phase.Status = evt.PhaseStatus ?? evt.Type.ToString();
                            if (evt.OutlinePoints?.Count > 0)
                                phase.OutlinePoints = evt.OutlinePoints;
                            if (!string.IsNullOrEmpty(evt.DurationTarget))
                                phase.DurationTarget = evt.DurationTarget;
                        }
                        _progressMessage = evt.Message;
                        break;

                    case GenerationEventType.SessionProgress:
                        _completedPhases = evt.CompletedPhases;
                        _totalPhases = evt.TotalPhases;
                        _progressPercent = evt.ProgressPercent;
                        _progressMessage = evt.Message;
                        break;

                    case GenerationEventType.SessionCompleted:
                        _progressSubscription?.Dispose();
                        _ = InvokeAsync(async () =>
                        {
                            var completedSession = await ScriptService.GetSessionAsync(sessionId);
                            if (completedSession != null)
                            {
                                _resultSession = completedSession;
                                await LoadResultSections(completedSession);
                                await LoadBrollPromptsFromDisk();
                                _currentView = "broll-prompts";
                                _ = AutoSearchMissingBrollSegments();
                            }
                            StateHasChanged();
                        });
                        break;

                    case GenerationEventType.SessionFailed:
                        _progressSubscription?.Dispose();
                        _errorMessage = evt.Message;
                        break;
                }
                StateHasChanged();
            });
        });
    }

    // ===== Regenerate Phase =====

    private async Task HandleRegeneratePhase(ResultSection section)
    {
        if (section.IsRegenerating || _sessionId == null) return;
        section.IsRegenerating = true;
        StateHasChanged();

        try
        {
            var session = await ScriptService.RegeneratePhaseAsync(_sessionId, section.PhaseId);
            _resultSession = session;

            // Reload the content for this section
            var updatedPhase = session.Phases.FirstOrDefault(p => p.PhaseId == section.PhaseId);
            if (updatedPhase != null)
            {
                if (!string.IsNullOrEmpty(updatedPhase.ContentFilePath) && File.Exists(updatedPhase.ContentFilePath))
                    section.Content = await File.ReadAllTextAsync(updatedPhase.ContentFilePath);
                section.WordCount = updatedPhase.WordCount ?? 0;
                section.DurationSeconds = updatedPhase.DurationSeconds ?? 0;
                section.IsValidated = updatedPhase.IsValidated;
                section.IsExpanded = true;
            }

            // Recalculate totals
            _totalWords = session.Phases.Sum(p => p.WordCount ?? 0);
            _totalMinutes = (int)(session.Phases.Sum(p => p.DurationSeconds ?? 0) / 60);
            _validatedCount = session.Phases.Count(p => p.IsValidated);
        }
        catch (Exception ex) { _errorMessage = $"Regenerate gagal: {ex.Message}"; }
        finally { section.IsRegenerating = false; StateHasChanged(); }

        // Script changed ‚Äî invalidate old classification
        InvalidateBrollClassification();
    }

    // ===== Regenerate All =====

    private async Task HandleRegenerateAll()
    {
        if (_isRegeneratingAll || _sessionId == null) return;

        // #6: Guard against double-trigger
        if (BgService.IsRunning(_sessionId))
        {
            _errorMessage = "Generasi masih berjalan. Tunggu sampai selesai atau batalkan dulu.";
            StateHasChanged();
            return;
        }

        _isRegeneratingAll = true;
        _errorMessage = null;
        InvalidateBrollClassification();
        StateHasChanged();

        try
        {
            // Switch to progress view
            _progressMessage = "Regenerating semua fase...";
            _completedPhases = 0;
            _progressPercent = 0;

            _phaseStatuses = _resultSections.Select(s => new PhaseStatusItem
            {
                PhaseId = s.PhaseId, Name = s.PhaseName, Order = s.Order, Status = "Pending"
            }).ToList();

            _currentView = "progress";
            StateHasChanged();

            // Subscribe to progress via event bus
            SubscribeToProgress(_sessionId);

            // Fire-and-forget
            BgService.EnqueueGeneration(_sessionId);
        }
        catch (Exception ex) { _errorMessage = $"Regenerate All gagal: {ex.Message}"; }
        finally { _isRegeneratingAll = false; StateHasChanged(); }
    }

    private void ToggleSection(ResultSection section) { section.IsExpanded = !section.IsExpanded; }

    // ===== Copy Phase Content =====

    private async Task HandleCopyPhaseContent(ResultSection section)
    {
        try
        {
            await JS.InvokeVoidAsync("copyToClipboard", section.Content);
            section.CopyState = "copied";
            StateHasChanged();

            // #9: Reset after 2 seconds without unnecessary Task.Run
            _ = InvokeAsync(async () =>
            {
                await Task.Delay(2000);
                section.CopyState = "idle";
                StateHasChanged();
            });
        }
        catch { /* silently fail */ }
    }

    // Old per-instance event handlers replaced by SubscribeToProgress() event bus pattern

    private async Task HandleCancelGeneration()
    {
        if (_isCancelling || string.IsNullOrEmpty(_sessionId)) return;
        _isCancelling = true;
        StateHasChanged();

        if (BgService.CancelGeneration(_sessionId))
        {
            _progressMessage = "Membatalkan generasi...";
            // Wait briefly for UX, then check state
            await Task.Delay(500);
        }
        else
        {
            _errorMessage = "Tidak bisa membatalkan: generasi tidak sedang berjalan.";
        }

        _isCancelling = false;
        StateHasChanged();
    }

    public void Dispose()
    {
        _progressSubscription?.Dispose();
        _listSubscription?.Dispose();
        foreach (var sub in _listSubscriptions)
            sub.Dispose();
        _listSubscriptions.Clear();
    }

    private void OnVignetteToggleChanged(ChangeEventArgs e)
    {
        if (e.Value is bool enabled)
        {
            StyleSettings.VignetteEnabled = enabled;
            StateHasChanged();
        }
    }

    private void ToggleVignette()
    {
        StyleSettings.VignetteEnabled = !StyleSettings.VignetteEnabled;
        StateHasChanged();
    }

    private async Task HandleBackToList() { await LoadSessionsAsync(); _currentView = "list"; _errorMessage = null; }
    private async Task HandleSendToBroll()
    {
        if (_resultSession == null || _resultSections.Count == 0) return;

        // Guard: If classification results already exist (in memory or on disk), skip re-classification
        if (_brollPromptItems.Count == 0)
        {
            await LoadBrollPromptsFromDisk();
        }

        if (_brollPromptItems.Count > 0)
        {
            // Classification already done ‚Äî just show the results
            _currentView = "broll-prompts";
            StateHasChanged();
            return;
        }

        // No existing classification ‚Äî run it
        _isClassifyingBroll = true;
        _classifyError = null;
        _classifyTotalSegments = 0;
        _classifyCompletedSegments = 0;
        _brollPromptItems.Clear();
        _currentView = "broll-prompts";
        StateHasChanged();

        try
        {
            // Parse all timestamped entries from all sections
            var timestampPattern = new System.Text.RegularExpressions.Regex(
                @"\[(\d{1,3}):(\d{2})\]",
                System.Text.RegularExpressions.RegexOptions.Compiled);

            var segments = new List<(string Timestamp, string ScriptText)>();
            var globalOffset = TimeSpan.Zero;

            foreach (var section in _resultSections.OrderBy(s => s.Order))
            {
                if (string.IsNullOrWhiteSpace(section.Content)) continue;

                var entries = ParseTimestampedEntries(section.Content, timestampPattern);

                if (entries.Count > 0)
                {
                    // Normalize timestamps to zero-based (same fix as LRC export)
                    var phaseBase = entries[0].Timestamp;

                    foreach (var entry in entries)
                    {
                        var normalizedTime = entry.Timestamp - phaseBase;
                        if (normalizedTime < TimeSpan.Zero) normalizedTime = TimeSpan.Zero;
                        var absoluteTime = globalOffset.Add(normalizedTime);
                        var cleaned = CleanSubtitleText(entry.Text);
                        if (string.IsNullOrWhiteSpace(cleaned)) continue;

                        var mins = (int)absoluteTime.TotalMinutes;
                        var secs = absoluteTime.Seconds;
                        segments.Add(($"[{mins:D2}:{secs:D2}]", cleaned));
                    }

                    // Advance global offset using normalized last entry
                    var lastEntry = entries.Last();
                    var normalizedLastTime = lastEntry.Timestamp - phaseBase;
                    if (normalizedLastTime < TimeSpan.Zero) normalizedLastTime = TimeSpan.Zero;
                    var lastDuration = EstimateDuration(lastEntry.Text);
                    globalOffset = globalOffset.Add(normalizedLastTime).Add(TimeSpan.FromSeconds(lastDuration));
                }
                else
                {
                    // No timestamps ‚Äî treat whole content as one segment
                    var cleaned = CleanSubtitleText(section.Content);
                    if (!string.IsNullOrWhiteSpace(cleaned))
                    {
                        var mins = (int)globalOffset.TotalMinutes;
                        var secs = globalOffset.Seconds;
                        segments.Add(($"[{mins:D2}:{secs:D2}]", cleaned));
                        globalOffset = globalOffset.Add(TimeSpan.FromSeconds(EstimateDuration(cleaned)));
                    }
                }
            }

            if (segments.Count == 0)
            {
                _classifyError = "Tidak ada segment yang bisa diproses.";
                return;
            }

            _classifyTotalSegments = segments.Count;
            await InvokeAsync(StateHasChanged);

            _brollPromptItems = await IntelligenceService.ClassifyAndGeneratePromptsAsync(
                segments, _resultSession.Topic,
                onBatchComplete: async batchResults =>
                {
                    _brollPromptItems = batchResults.OrderBy(r => r.Index).ToList();
                    _classifyCompletedSegments = batchResults.Count;
                    await InvokeAsync(StateHasChanged);
                });
        }
        catch (Exception ex)
        {
            _classifyError = $"Gagal mengklasifikasi: {ex.Message}";
        }
        finally
        {
            _isClassifyingBroll = false;
            StateHasChanged();
        }

        // Save classification results to disk
        await SaveBrollPromptsToDisk();

        // Phase 1: Auto-search broll videos for all BROLL segments
        if (_brollPromptItems.Any(i => i.MediaType == BrollMediaType.BrollVideo))
        {
            await SearchBrollForAllSegmentsAsync();
        }
    }

    private void HandleBackToResults() { _currentView = "results"; _classifyError = null; }

    private async Task HandleReclassifyBroll()
    {
        // Force re-classification by clearing existing results first
        InvalidateBrollClassification();
        await HandleSendToBroll();
    }

    // ===== Video Selection =====

    private async Task HandleSelectVideo(BrollPromptItem item, VideoAsset video)
    {
        item.SelectedVideoUrl = video.DownloadUrl;
        await SaveBrollPromptsToDisk();
        StateHasChanged();
    }

    // ===== Phase 1: Broll Search =====

    private async Task SearchBrollForAllSegmentsAsync()
    {
        _isSearchingBroll = true;
        StateHasChanged();

        var brollItems = _brollPromptItems.Where(i => i.MediaType == BrollMediaType.BrollVideo).ToList();
        foreach (var item in brollItems)
        {
            await SearchBrollForSegmentAsync(item, forceRefresh: true);
            StateHasChanged();
        }

        _isSearchingBroll = false;
        StateHasChanged();
    }

    private async Task AutoSearchMissingBrollSegments()
    {
        // Find segments that are B-Roll Video but have NO search results (and aren't currently searching)
        var missingItems = _brollPromptItems
            .Where(i => i.MediaType == BrollMediaType.BrollVideo 
                     && (i.AllSearchResults == null || i.AllSearchResults.Count == 0)
                     && !i.IsSearching)
            .ToList();

        if (missingItems.Count == 0) return;

        // Show global searching state
        await InvokeAsync(() =>
        {
            _isSearchingBroll = true;
            StateHasChanged();
        });

        // Search one by one to avoid rate limits
        foreach (var item in missingItems)
        {
            await InvokeAsync(async () =>
            {
                await SearchBrollForSegmentAsync(item, forceRefresh: true);
                StateHasChanged();
            });
            // Small delay to be nice to the API
            await Task.Delay(500); 
        }

        // Hide global searching state
        await InvokeAsync(() =>
        {
            _isSearchingBroll = false;
            StateHasChanged();
        });
    }

    private async Task SearchBrollForSegmentAsync(BrollPromptItem item, bool forceRefresh = false)
    {
        item.IsSearching = true;
        item.SearchError = null;
        
        try
        {
            const int pageSize = 4;
            
            // If we have cached results and not forcing refresh, just cycle the page
            if (!forceRefresh && item.AllSearchResults.Count > 0)
            {
                var totalPages = (int)Math.Ceiling((double)item.AllSearchResults.Count / pageSize);
                item.SearchPage = (item.SearchPage + 1) % totalPages;
            }
            else
            {
                // Fresh search: fetch many results and cache them
                item.SearchPage = 0;
                var keywords = new List<string> { item.Prompt };
                var results = await AssetBroker.SearchVideosAsync(keywords, maxResults: 12);
                item.AllSearchResults = results;
            }
            
            // Slice the current page window
            item.SearchResults = item.AllSearchResults
                .Skip(item.SearchPage * pageSize)
                .Take(pageSize)
                .ToList();
        }
        catch (Exception ex)
        {
            item.SearchError = $"Search gagal: {ex.Message}";
        }
        finally
        {
            item.IsSearching = false;
        }
    }

    private async Task HandleSearchSingleSegment(BrollPromptItem item)
    {
        await SearchBrollForSegmentAsync(item);
        StateHasChanged();
    }
    private async Task HandleToggleMediaType(BrollPromptItem item)
    {
        if (_resultSession == null) return;

        // Toggle the media type
        var newType = item.MediaType == BrollMediaType.BrollVideo
            ? BrollMediaType.ImageGeneration
            : BrollMediaType.BrollVideo;

        // Clear old state
        item.MediaType = newType;
        item.SearchResults.Clear();
        item.SearchError = null;
        item.SelectedVideoUrl = null;
        item.WhiskStatus = WhiskGenerationStatus.Pending;
        item.WhiskImagePath = null;
        item.WhiskError = null;
        item.IsSearching = true;
        StateHasChanged();

        try
        {
            // Re-classify this single segment via LLM to get the right prompt
            var singleResult = await IntelligenceService.ClassifyAndGeneratePromptsAsync(
                new List<(string, string)> { (item.Timestamp, item.ScriptText) },
                _resultSession.Topic);

            if (singleResult.Count > 0)
            {
                // Keep user's forced type, take the prompt from the result
                // If LLM returned the same type ‚Üí use its prompt directly
                // If LLM returned different type ‚Üí still use LLM prompt but override media type
                item.Prompt = singleResult[0].Prompt;
                item.Reasoning = singleResult[0].Reasoning;
                item.MediaType = newType; // Force override to user's choice
            }

            // If toggled to broll, auto-search
            if (newType == BrollMediaType.BrollVideo)
            {
                await SearchBrollForSegmentAsync(item, forceRefresh: true);
            }
        }
        catch (Exception ex)
        {
            item.SearchError = $"Gagal generate prompt: {ex.Message}";
        }
        finally
        {
            item.IsSearching = false;
            await SaveBrollPromptsToDisk();
            StateHasChanged();
        }
    }

    private async Task HandleRegenSegmentKeywords(BrollPromptItem item)
    {
        if (_resultSession == null) return;

        item.IsSearching = true;
        StateHasChanged();

        try
        {
            // NEW: Force generation of B-Roll keywords (prevents switching to Image Gen)
            var brollKeywords = await IntelligenceService.GeneratePromptForTypeAsync(
                item.ScriptText, 
                BrollMediaType.BrollVideo, 
                _resultSession.Topic);

            if (!string.IsNullOrWhiteSpace(brollKeywords))
            {
                item.Prompt = brollKeywords;
                // Keep existing reasoning or set a generic one
                item.Reasoning = "Regenerated keywords";
            }

            // Re-search if still broll
            if (item.MediaType == BrollMediaType.BrollVideo)
            {
                await SearchBrollForSegmentAsync(item, forceRefresh: true);
            }
        }
        catch (Exception ex)
        {
            item.SearchError = $"Regen gagal: {ex.Message}";
        }
        finally
        {
            item.IsSearching = false;
            StateHasChanged();
        }
    }

    private async Task HandleRegenAllVideoKeywords()
    {
        if (_resultSession == null) return;

        var brollItems = _brollPromptItems.Where(i => i.MediaType == BrollMediaType.BrollVideo).ToList();
        if (brollItems.Count == 0) return;

        _isRegeneratingAllKeywords = true;
        StateHasChanged();

        try
        {
            // Build all segments for batch classification
            var segments = brollItems.Select(i => (i.Timestamp, i.ScriptText)).ToList();

            var results = await IntelligenceService.ClassifyAndGeneratePromptsAsync(
                segments, _resultSession.Topic,
                onBatchComplete: async batchResults =>
                {
                    // Update items as batches complete
                    foreach (var result in batchResults)
                    {
                        var matchingItem = brollItems.ElementAtOrDefault(result.Index);
                        if (matchingItem != null)
                        {
                            matchingItem.Prompt = result.Prompt;
                            matchingItem.Reasoning = result.Reasoning;
                            // Clear old search results since prompt changed
                            matchingItem.AllSearchResults.Clear();
                            matchingItem.SearchResults.Clear();
                        }
                    }
                    await InvokeAsync(StateHasChanged);
                });

            // Final update pass
            // Final update pass
            for (int i = 0; i < results.Count && i < brollItems.Count; i++)
            {
                var item = brollItems[i];
                var result = results[i];
                
                item.Prompt = result.Prompt;
                item.Reasoning = result.Reasoning;
                
                // Fix: Respect logic from AI if it changes type (Video -> Image)
                if (item.MediaType != result.MediaType)
                {
                    item.MediaType = result.MediaType;
                    
                    if (item.MediaType == BrollMediaType.ImageGeneration)
                    {
                        // Reset image generation state to avoid stale data
                        item.WhiskStatus = WhiskGenerationStatus.Pending;
                        item.WhiskImagePath = null;
                        item.WhiskError = null;
                        item.WhiskVideoStatus = WhiskGenerationStatus.Pending;
                        item.WhiskVideoPath = null;
                        item.WhiskVideoError = null;
                        item.IsGenerating = false;
                        item.IsConvertingVideo = false;
                        
                        // Randomize Ken Burns motion since it's a new image item
                        item.KenBurnsMotion = BrollPromptItem.GetRandomMotion();
                    }
                }

                item.AllSearchResults.Clear();
                item.SearchResults.Clear();
            }

            await SaveBrollPromptsToDisk();

            // Auto-search all with new keywords
            await SearchBrollForAllSegmentsAsync();
        }
        catch (Exception ex)
        {
            _classifyError = $"Regen all keywords gagal: {ex.Message}";
        }
        finally
        {
            _isRegeneratingAllKeywords = false;
            StateHasChanged();
        }
    }

    private async Task HandleRegenPromptAndImage(BrollPromptItem item)
    {
        if (_resultSession == null) return;

        item.IsGenerating = true;
        item.CombinedRegenProgress = 10;
        item.WhiskError = null;
        // Reset Ken Burns video state so stale video doesn't persist
        item.WhiskVideoStatus = WhiskGenerationStatus.Pending;
        item.WhiskVideoPath = null;
        item.WhiskVideoError = null;
        StateHasChanged();

        try
        {
            // Step 1: Regen Prompt (Forced Image Gen)
            item.CombinedRegenProgress = 20;
            StateHasChanged();

            var imagePrompt = await IntelligenceService.GeneratePromptForTypeAsync(
                item.ScriptText, 
                BrollMediaType.ImageGeneration, 
                _resultSession.Topic);

            if (!string.IsNullOrWhiteSpace(imagePrompt))
            {
                item.Prompt = imagePrompt;
                item.Reasoning = "Regenerated image prompt";
                // Fix: Randomize motion type on regeneration
                item.KenBurnsMotion = BrollPromptItem.GetRandomMotion();
            }

            item.CombinedRegenProgress = 50;
            StateHasChanged();

            // Step 2: Regen Image (Whisk) ‚Äî uses shared helper
            item.CombinedRegenProgress = 70;
            StateHasChanged();

            await GenerateWhiskImageForItem(item);
            item.CombinedRegenProgress = 100;
        }
        catch (Exception ex)
        {
            item.WhiskStatus = WhiskGenerationStatus.Failed;
            item.WhiskError = ex.Message;
        }
        finally
        {
            item.IsGenerating = false;
            await SaveBrollPromptsToDisk();
            StateHasChanged();
        }
    }

    // ===== Phase 2: Whisk Image Generation =====

    private async Task HandleGenerateAllWhiskImages()
    {
        var imageGenItems = _brollPromptItems
            .Where(i => i.MediaType == BrollMediaType.ImageGeneration && i.WhiskStatus != WhiskGenerationStatus.Done)
            .ToList();

        if (imageGenItems.Count == 0) return;

        _isGeneratingWhisk = true;
        _whiskTotalCount = imageGenItems.Count;
        _whiskGeneratedCount = 0;
        StateHasChanged();

        foreach (var item in imageGenItems)
        {
            item.IsGenerating = true;
            StateHasChanged();

            try
            {
                await GenerateWhiskImageForItem(item);
            }
            finally
            {
                item.IsGenerating = false;
                _whiskGeneratedCount++;
                StateHasChanged();
            }
        }

        _isGeneratingWhisk = false;
        await SaveBrollPromptsToDisk();
        StateHasChanged();
    }

    private async Task HandleGenerateKenBurnsVideo(BrollPromptItem item)
    {
        if (string.IsNullOrEmpty(item.WhiskImagePath) || !File.Exists(item.WhiskImagePath)) return;

        item.IsConvertingVideo = true;
        item.WhiskVideoError = null;
        item.WhiskVideoStatus = WhiskGenerationStatus.Generating;
        StateHasChanged();

        try
        {
            var duration = EstimateDuration(item.ScriptText);
            var outputDir = Path.GetDirectoryName(item.WhiskImagePath)!;
            var fileName = Path.GetFileNameWithoutExtension(item.WhiskImagePath) + "_kb.mp4";
            var outputPath = Path.Combine(outputDir, fileName);

            // Service writes directly to outputPath with -movflags +faststart
            var success = await KenBurnsService.ConvertImageToVideoAsync(
                item.WhiskImagePath,
                outputPath,
                duration,
                1920, 1080,
                item.KenBurnsMotion);

            if (success)
            {
                item.WhiskVideoPath = outputPath;
                item.WhiskVideoStatus = WhiskGenerationStatus.Done;
            }
            else
            {
                item.WhiskVideoStatus = WhiskGenerationStatus.Failed;
                item.WhiskVideoError = "FFmpeg conversion failed ‚Äî check logs";
            }
        }
        catch (Exception ex)
        {
            item.WhiskVideoStatus = WhiskGenerationStatus.Failed;
            item.WhiskVideoError = ex.Message;
        }
        finally
        {
            item.IsConvertingVideo = false;
            await SaveBrollPromptsToDisk();
            StateHasChanged();
        }
    }

    private async Task HandleResetAllImageStates()
    {
        foreach (var item in _brollPromptItems.Where(i => i.MediaType == BrollMediaType.ImageGeneration))
        {
            // Delete physical files if they exist
            if (!string.IsNullOrEmpty(item.WhiskImagePath) && System.IO.File.Exists(item.WhiskImagePath))
            {
                try { System.IO.File.Delete(item.WhiskImagePath); } catch { /* Ignore delete errors */ }
            }
            if (!string.IsNullOrEmpty(item.WhiskVideoPath) && System.IO.File.Exists(item.WhiskVideoPath))
            {
                try { System.IO.File.Delete(item.WhiskVideoPath); } catch { /* Ignore delete errors */ }
            }

            item.WhiskStatus = WhiskGenerationStatus.Pending;
            item.WhiskImagePath = null;
            item.WhiskError = null;
            item.WhiskVideoStatus = WhiskGenerationStatus.Pending;
            item.WhiskVideoPath = null;
            item.WhiskVideoError = null;
            item.IsGenerating = false;
            item.IsConvertingVideo = false;
        }

        await SaveBrollPromptsToDisk();
        StateHasChanged();
    }

    private async Task HandleResetAllVideoStates()
    {
        foreach (var item in _brollPromptItems.Where(i => i.MediaType == BrollMediaType.ImageGeneration))
        {
            if (!string.IsNullOrEmpty(item.WhiskVideoPath) && System.IO.File.Exists(item.WhiskVideoPath))
            {
                try { System.IO.File.Delete(item.WhiskVideoPath); } catch { /* Ignore delete errors */ }
            }

            item.WhiskVideoStatus = WhiskGenerationStatus.Pending;
            item.WhiskVideoPath = null;
            item.WhiskVideoError = null;
            item.IsConvertingVideo = false;
        }

        await SaveBrollPromptsToDisk();
        StateHasChanged();
    }

    private async Task HandleGenerateAllKenBurnsVideos()
    {
        var pending = _brollPromptItems
            .Where(i => i.MediaType == BrollMediaType.ImageGeneration && 
                        i.WhiskStatus == WhiskGenerationStatus.Done && 
                        i.WhiskVideoStatus != WhiskGenerationStatus.Done &&
                        !i.IsConvertingVideo)
            .ToList();

        if (pending.Count == 0) return;

        foreach (var item in pending)
        {
            await HandleGenerateKenBurnsVideo(item);
        }
    }

    private async Task HandleGenerateSingleWhisk(BrollPromptItem item)
    {
        item.IsGenerating = true;
        StateHasChanged();

        try
        {
            await GenerateWhiskImageForItem(item);
        }
        finally
        {
            item.IsGenerating = false;
            await SaveBrollPromptsToDisk();
            StateHasChanged();
        }
    }

    /// <summary>Shared helper: generate a Whisk image for one item. Sets status/path/error. Includes 120s timeout.</summary>
    private async Task GenerateWhiskImageForItem(BrollPromptItem item)
    {
        item.WhiskStatus = WhiskGenerationStatus.Generating;
        item.WhiskError = null;
        // Reset video state since image is changing
        item.WhiskVideoStatus = WhiskGenerationStatus.Pending;
        item.WhiskVideoPath = null;
        item.WhiskVideoError = null;
        StateHasChanged();

        try
        {
            var outputDir = Path.Combine(
                Directory.GetCurrentDirectory(),
                "output", _sessionId, "whisk_images");
            Directory.CreateDirectory(outputDir);

            // #7: Add 120s timeout to prevent infinite hangs
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(120));
            var result = await WhiskGenerator.GenerateImageAsync(item.Prompt, outputDir, cancellationToken: cts.Token);
            if (result.Success)
            {
                item.WhiskStatus = WhiskGenerationStatus.Done;
                item.WhiskImagePath = result.ImagePath;
            }
            else
            {
                item.WhiskStatus = WhiskGenerationStatus.Failed;
                item.WhiskError = result.Error ?? "Unknown error";
            }
        }
        catch (OperationCanceledException)
        {
            item.WhiskStatus = WhiskGenerationStatus.Failed;
            item.WhiskError = "Timeout: generasi gambar melebihi 120 detik";
        }
        catch (Exception ex)
        {
            item.WhiskStatus = WhiskGenerationStatus.Failed;
            item.WhiskError = ex.Message;
        }
    }

    // ===== Broll Prompts Persistence =====

    private string? GetBrollPromptsFilePath()
    {
        if (_resultSession == null) return null;

        // Strategy 1: OutputDirectory as is (if valid absolute path on this OS)
        if (!string.IsNullOrEmpty(_resultSession.OutputDirectory))
        {
            var directPath = Path.Combine(_resultSession.OutputDirectory, "broll-prompts.json");
            if (File.Exists(directPath)) return directPath;
        }

        // Strategy 2: Relative to CWD (if OutputDirectory is relative or we can resolve it)
        if (!string.IsNullOrEmpty(_resultSession.OutputDirectory))
        {
             var relativePath = Path.Combine(Directory.GetCurrentDirectory(), _resultSession.OutputDirectory, "broll-prompts.json");
             if (File.Exists(relativePath)) return relativePath;
        }
        
        // Strategy 3: Construct expected path manually (fallback for cross-platform/absolute paths)
        var constructedPath = Path.Combine(Directory.GetCurrentDirectory(), "output", "scripts", _resultSession.Id, "broll-prompts.json");
        if (File.Exists(constructedPath)) return constructedPath;

        // Default to constructed path for saving if none exist
        return constructedPath;
    }

    private void InvalidateBrollClassification()
    {
        _brollPromptItems.Clear();
        _classifyTotalSegments = 0;
        _classifyCompletedSegments = 0;

        // Delete persisted file
        var filePath = GetBrollPromptsFilePath();
        if (filePath != null && File.Exists(filePath))
        {
            try { File.Delete(filePath); }
            catch { /* ignore */ }
        }
    }

    private async Task SaveBrollPromptsToDisk()
    {
        var filePath = GetBrollPromptsFilePath();
        if (filePath == null || _brollPromptItems.Count == 0) return;

        try
        {
            // Serialize only the classification data and Whisk status (not transient search results)
            var saveData = _brollPromptItems.Select(i => new BrollPromptSaveItem
            {
                Index = i.Index,
                Timestamp = i.Timestamp,
                ScriptText = i.ScriptText,
                MediaType = i.MediaType,
                Prompt = i.Prompt,
                Reasoning = i.Reasoning,
                WhiskStatus = i.WhiskStatus,
                WhiskImagePath = i.WhiskImagePath,
                WhiskError = i.WhiskError,
                SelectedVideoUrl = i.SelectedVideoUrl,
                KenBurnsMotion = i.KenBurnsMotion,
                WhiskVideoStatus = i.WhiskVideoStatus,
                WhiskVideoPath = i.WhiskVideoPath,
                WhiskVideoError = i.WhiskVideoError,
                Style = i.Style,
                Filter = i.Filter,
                Texture = i.Texture,
                FilteredVideoPath = i.FilteredVideoPath
            }).ToList();

            var json = System.Text.Json.JsonSerializer.Serialize(saveData, new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true,
                Converters = { new System.Text.Json.Serialization.JsonStringEnumConverter() }
            });
            await File.WriteAllTextAsync(filePath, json);
        }
        catch (Exception ex)
        {
            // #10: Surface save failure to user instead of silent log
            _saveError = $"Gagal menyimpan broll prompts: {ex.Message}";
            Console.Error.WriteLine($"Failed to save broll prompts: {ex.Message}");
        }
    }

    private async Task LoadBrollPromptsFromDisk()
    {
        var filePath = GetBrollPromptsFilePath();
        if (filePath == null || !File.Exists(filePath)) return;

        try
        {
            var json = await File.ReadAllTextAsync(filePath);
            var saveItems = System.Text.Json.JsonSerializer.Deserialize<List<BrollPromptSaveItem>>(json, new System.Text.Json.JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true,
                Converters = { new System.Text.Json.Serialization.JsonStringEnumConverter() }
            });

            if (saveItems != null)
            {
                _brollPromptItems = saveItems.Select(s => new BrollPromptItem
                {
                    Index = s.Index,
                    Timestamp = s.Timestamp,
                    ScriptText = s.ScriptText,
                    MediaType = s.MediaType,
                    Prompt = s.Prompt,
                    Reasoning = s.Reasoning,
                    WhiskStatus = s.WhiskStatus,
                    WhiskImagePath = s.WhiskImagePath,
                    WhiskError = s.WhiskError,
                    SelectedVideoUrl = s.SelectedVideoUrl,
                    // If motion is None (legacy data), assign a random one. Only use None if explicitly intended (but we assume legacy for now)
                    KenBurnsMotion = (s.MediaType == BrollMediaType.ImageGeneration && s.KenBurnsMotion == KenBurnsMotionType.None)
                        ? BrollPromptItem.GetRandomMotion()
                        : s.KenBurnsMotion,
                    WhiskVideoStatus = s.WhiskVideoStatus,
                    WhiskVideoPath = s.WhiskVideoPath,
                    WhiskVideoError = s.WhiskVideoError,
                    Style = s.Style,
                    Filter = s.Filter,
                    Texture = s.Texture,
                    FilteredVideoPath = s.FilteredVideoPath
                }).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to load broll prompts: {ex.Message}");
        }
    }

    private async Task HandleApplyStyleToVideo(BrollPromptItem item)
    {
        if (item.IsFilteringVideo) return;
        
        try
        {
            item.IsFilteringVideo = true;
            item.FilterError = null;
            item.IsFilteringVideo = true;
            item.FilterError = null;
            item.FilterProgress = 0;
            item.FilterStatus = "Initializing...";
            StateHasChanged();

            // 1. Identify source video
            string videoUrl;
            string? localPath = null;
            VideoAsset? selectedVideo = null;

            if (item.SearchResults.Count > 0)
            {
                selectedVideo = item.SearchResults.FirstOrDefault(v => v.DownloadUrl == item.SelectedVideoUrl)
                                    ?? item.SearchResults.First();
                videoUrl = selectedVideo.DownloadUrl;
                
                // If we have a local path in the video asset, use it
                if (!string.IsNullOrEmpty(selectedVideo.LocalPath) && File.Exists(selectedVideo.LocalPath))
                {
                    localPath = selectedVideo.LocalPath;
                }
            }
            else
            {
                throw new InvalidOperationException("No video selected to filter.");
            }

            // 2. Download if not local
            if (string.IsNullOrEmpty(localPath) || !File.Exists(localPath))
            {
                item.FilterProgress = 10;
                item.FilterStatus = "Downloading source...";
                StateHasChanged();

                // Download to project assets
                var projectSlug = _resultSession?.Topic != null 
                    ? System.Text.RegularExpressions.Regex.Replace(_resultSession.Topic, @"[^\w\s\-]", "").Trim().Replace(" ", "-")
                    : "temp-preview";
                    
                localPath = await DownloaderService.DownloadVideoAsync(
                    selectedVideo, 
                    projectSlug, 
                    item.Index, 
                    "preview-source", 
                    CancellationToken.None);
                
                // Update local path in transient object so next time we skip download
                selectedVideo.LocalPath = localPath;
            }

            if (string.IsNullOrEmpty(localPath) || !File.Exists(localPath))
            {
                throw new Exception("Could not download source video.");
            }

            // 3. Apply Style
            item.FilterProgress = 40;
            item.FilterStatus = $"Applying {item.Style}...";
            StateHasChanged();

            var videoConfig = new ShortVideoConfig 
            { 
                Ratio = AspectRatio.Landscape_16x9,
                Style = item.Style 
            };

            var filteredPath = await VideoComposer.ApplyStyleToVideoAsync(localPath, item.Style, videoConfig, CancellationToken.None, isPreview: true);

            if (!string.IsNullOrEmpty(filteredPath))
            {
                // Move to output folder ‚Äî static files map /project-assets ‚Üí output/
                var outputDir = Path.Combine(Directory.GetCurrentDirectory(), "output");
                Directory.CreateDirectory(outputDir);
                var finalFileName = $"filtered_{Guid.NewGuid():N}.mp4";
                var finalPath = Path.Combine(outputDir, finalFileName);
                
                File.Move(filteredPath, finalPath, overwrite: true);
                item.FilteredVideoPath = finalPath;
                
                item.FilterProgress = 100;
                item.FilterStatus = "Done!";
                StateHasChanged();
                await Task.Delay(500); // Show 100% briefly
            }
            else
            {
                throw new Exception("Filter application returned null path.");
            }

            await SaveBrollPromptsToDisk();
        }
        catch (Exception ex)
        {
            item.FilterError = $"Filter failed: {ex.Message}";
            Console.Error.WriteLine($"Filter error: {ex}");
        }
        finally
        {
            item.IsFilteringVideo = false;
            StateHasChanged();
        }
    }

    // ===== Filter & Texture Helpers =====

    private async Task HandleApplyFilterToVideo(BrollPromptItem item)
    {
        if (item.IsFilteringVideo) return;
        
        try
        {
            item.IsFilteringVideo = true;
            item.FilterError = null;
            item.FilterProgress = 0;
            item.FilterStatus = "Initializing...";
            StateHasChanged();

            // 1. Identify source video
            string videoUrl;
            string? localPath = null;
            VideoAsset? selectedVideo = null;

            if (item.SearchResults.Count > 0)
            {
                selectedVideo = item.SearchResults.FirstOrDefault(v => v.DownloadUrl == item.SelectedVideoUrl)
                                    ?? item.SearchResults.First();
                videoUrl = selectedVideo.DownloadUrl;
                
                if (!string.IsNullOrEmpty(selectedVideo.LocalPath) && File.Exists(selectedVideo.LocalPath))
                {
                    localPath = selectedVideo.LocalPath;
                }
            }
            else
            {
                throw new InvalidOperationException("No video selected to filter.");
            }

            // 2. Download if not local
            if (string.IsNullOrEmpty(localPath) || !File.Exists(localPath))
            {
                item.FilterProgress = 10;
                item.FilterStatus = "Downloading source...";
                StateHasChanged();

                var projectSlug = _resultSession?.Topic != null 
                    ? System.Text.RegularExpressions.Regex.Replace(_resultSession.Topic, @"[^\w\s\-]", "").Trim().Replace(" ", "-")
                    : "temp-preview";
                    
                localPath = await DownloaderService.DownloadVideoAsync(
                    selectedVideo, 
                    projectSlug, 
                    item.Index, 
                    "preview-source", 
                    CancellationToken.None);
                
                selectedVideo.LocalPath = localPath;
            }

            if (string.IsNullOrEmpty(localPath) || !File.Exists(localPath))
            {
                throw new Exception("Could not download source video.");
            }

            // 3. Apply Filter + Texture
            item.FilterProgress = 40;
            item.FilterStatus = $"Applying {item.EffectiveFilter} + {item.EffectiveTexture}...";
            StateHasChanged();

            var videoConfig = new ShortVideoConfig 
            { 
                Ratio = AspectRatio.Landscape_16x9
            };

            var filteredPath = await VideoComposer.ApplyFilterAndTextureToVideoAsync(
                localPath, 
                item.EffectiveFilter, 
                item.EffectiveTexture, 
                videoConfig, 
                CancellationToken.None, 
                isPreview: true);

            if (!string.IsNullOrEmpty(filteredPath))
            {
                var outputDir = Path.Combine(Directory.GetCurrentDirectory(), "output");
                Directory.CreateDirectory(outputDir);
                var finalFileName = $"filtered_{Guid.NewGuid():N}.mp4";
                var finalPath = Path.Combine(outputDir, finalFileName);
                
                File.Move(filteredPath, finalPath, overwrite: true);
                item.FilteredVideoPath = finalPath;
                
                item.FilterProgress = 100;
                item.FilterStatus = "Done!";
                StateHasChanged();
                await Task.Delay(500);
            }
            else
            {
                throw new Exception("Filter application returned null path.");
            }

            await SaveBrollPromptsToDisk();
        }
        catch (Exception ex)
        {
            item.FilterError = $"Filter failed: {ex.Message}";
            Console.Error.WriteLine($"Filter error: {ex}");
        }
        finally
        {
            item.IsFilteringVideo = false;
            StateHasChanged();
        }
    }

    private string GetFilterDisplayName(VideoFilter filter) => filter switch
    {
        VideoFilter.None => "None (No Filter)",
        VideoFilter.Painting => "üé® Painting",
        VideoFilter.Sepia => "üìú Sepia",
        VideoFilter.Vintage => "üì∑ Vintage",
        VideoFilter.Cinematic => "üé¨ Cinematic",
        VideoFilter.Warm => "‚òÄÔ∏è Warm",
        VideoFilter.Cool => "‚ùÑÔ∏è Cool",
        VideoFilter.Noir => "üïµÔ∏è Noir",
        _ => filter.ToString()
    };

    private string GetTextureDisplayName(VideoTexture texture) => texture switch
    {
        VideoTexture.None => "None (No Texture)",
        VideoTexture.Canvas => "üñºÔ∏è Canvas (surreal.mp4)",
        VideoTexture.Paper => "üìÑ Paper (harsh/grain)",
        VideoTexture.Grunge => "üß± Grunge (grunge.mp4)",
        VideoTexture.FilmGrain => "üéûÔ∏è Film Grain (filmgrain*.mp4)",
        VideoTexture.Dust => "üí® Dust (fire.mp4)",
        VideoTexture.Scratches => "‚ú® Scratches (scratches.mp4)",
        _ => texture.ToString()
    };

    private string GetEraDisplayName(VideoEra era) => era switch
    {
        VideoEra.Ancient => "üèõÔ∏è Ancient",
        VideoEra.Apocalyptic => "üî• Apocalyptic", 
        VideoEra.Modern => "üèôÔ∏è Modern",
        VideoEra.Abstract => "‚ú® Abstract",
        VideoEra.Nature => "üåø Nature",
        _ => "‚ùì Unknown"
    };

    private string GetEffectDisplayName(BrollPromptItem item)
    {
        var parts = new List<string>();
        
        if (item.EffectiveFilter != VideoFilter.None)
            parts.Add(item.EffectiveFilter.ToString().ToUpper());
        
        if (item.EffectiveTexture != VideoTexture.None)
            parts.Add(item.EffectiveTexture.ToString().ToUpper());
        
        return parts.Count > 0 ? string.Join(" + ", parts) : "FILTERED";
    }

    /// <summary>Lightweight DTO for JSON persistence (excludes transient VideoAsset search results)</summary>
    private class BrollPromptSaveItem
    {
        public int Index { get; set; }
        public string Timestamp { get; set; } = "";
        public string ScriptText { get; set; } = "";
        public BrollMediaType MediaType { get; set; }
        public string Prompt { get; set; } = "";
        public string Reasoning { get; set; } = "";
        public WhiskGenerationStatus WhiskStatus { get; set; }
        public string? WhiskImagePath { get; set; }
        public string? WhiskError { get; set; }
        public string? SelectedVideoUrl { get; set; }
        public KenBurnsMotionType KenBurnsMotion { get; set; }
        public WhiskGenerationStatus WhiskVideoStatus { get; set; }
        public string? WhiskVideoPath { get; set; }
        public string? WhiskVideoError { get; set; }
        public VideoStyle Style { get; set; }
        public VideoFilter Filter { get; set; }
        public VideoTexture Texture { get; set; }
        public string? FilteredVideoPath { get; set; }
    }

    /// <summary>Lightweight summary of broll data for session list cards</summary>
    private class BrollSessionSummary
    {
        public int TotalSegments { get; set; }
        public int VideoCount { get; set; }
        public int ImageGenCount { get; set; }
        public int ImagesReady { get; set; }
        public int VideosSelected { get; set; }
        public List<string> ThumbnailPaths { get; set; } = new();
    }

    // ===== Export LRC =====

    private async Task HandleExportLrc()
    {
        if (_isExportingLrc || _resultSession == null) return;
        _isExportingLrc = true;
        _errorMessage = null;
        _lrcExportPath = null;
        StateHasChanged();

        try
        {
            var lrcContent = GenerateLrcContent();
            var outputDir = _resultSession.OutputDirectory;
            if (string.IsNullOrEmpty(outputDir))
                throw new InvalidOperationException("Output directory not set on session");
            Directory.CreateDirectory(outputDir);
            var safeFilename = System.Text.RegularExpressions.Regex.Replace(
                _resultSession.Topic ?? "script", @"[^\w\s\-]", "").Trim().Replace(" ", "-");
            var lrcPath = Path.Combine(outputDir, $"{safeFilename}.lrc");
            await File.WriteAllTextAsync(lrcPath, lrcContent, System.Text.Encoding.UTF8);
            var bytes = System.Text.Encoding.UTF8.GetBytes(lrcContent);
            var base64 = Convert.ToBase64String(bytes);
            await JS.InvokeVoidAsync("downloadFile", $"{safeFilename}.lrc", base64, "text/plain");

            _lrcExportPath = lrcPath;
        }
        catch (Exception ex) { _errorMessage = $"Export LRC gagal: {ex.Message}"; }
        finally { _isExportingLrc = false; StateHasChanged(); }
    }

    /// <summary>
    /// Generate LRC content by parsing [MM:SS] timestamps from source markdown.
    /// Each phase has relative timestamps; we accumulate a global offset across phases.
    /// </summary>
    private string GenerateLrcContent()
    {
        var sb = new System.Text.StringBuilder();
        var globalOffset = TimeSpan.Zero;

        // Regex to match [MM:SS] or [MMM:SS] timestamps at start of text segments
        var timestampPattern = new System.Text.RegularExpressions.Regex(
            @"\[(\d{1,3}):(\d{2})\]",
            System.Text.RegularExpressions.RegexOptions.Compiled);

        foreach (var section in _resultSections.OrderBy(s => s.Order))
        {
            if (string.IsNullOrWhiteSpace(section.Content)) continue;

            var entries = ParseTimestampedEntries(section.Content, timestampPattern);

            if (entries.Count == 0)
            {
                // Fallback: no timestamps found, use estimation approach
                var cleaned = CleanSubtitleText(section.Content);
                if (!string.IsNullOrWhiteSpace(cleaned))
                {
                    var singleLine = System.Text.RegularExpressions.Regex.Replace(
                        cleaned.Replace("\r\n", " ").Replace("\n", " ").Replace("\r", " "),
                        @"\s+", " ").Trim();
                    var minutes = (int)globalOffset.TotalMinutes;
                    var seconds = globalOffset.Seconds;
                    sb.AppendLine($"[{minutes:D2}:{seconds:D2}.00]{singleLine}");
                    globalOffset = globalOffset.Add(TimeSpan.FromSeconds(EstimateDuration(cleaned)));
                }
                continue;
            }

            // Normalize: subtract the first entry's timestamp so all entries are zero-based
            // This handles cases where LLM generates non-zero-starting timestamps per phase
            var phaseBase = entries[0].Timestamp;

            foreach (var entry in entries)
            {
                var normalizedTime = entry.Timestamp - phaseBase;
                if (normalizedTime < TimeSpan.Zero) normalizedTime = TimeSpan.Zero;
                var absoluteTime = globalOffset.Add(normalizedTime);
                var cleaned = CleanSubtitleText(entry.Text);
                if (string.IsNullOrWhiteSpace(cleaned)) continue;

                var singleLine = System.Text.RegularExpressions.Regex.Replace(
                    cleaned.Replace("\r\n", " ").Replace("\n", " ").Replace("\r", " "),
                    @"\s+", " ").Trim();

                var minutes = (int)absoluteTime.TotalMinutes;
                var seconds = absoluteTime.Seconds;
                var centiseconds = absoluteTime.Milliseconds / 10;
                sb.AppendLine($"[{minutes:D2}:{seconds:D2}.{centiseconds:D2}]{singleLine}");
            }

            // Advance global offset by this phase's normalized duration
            if (entries.Count > 0)
            {
                var lastEntry = entries.Last();
                var normalizedLastTime = lastEntry.Timestamp - phaseBase;
                if (normalizedLastTime < TimeSpan.Zero) normalizedLastTime = TimeSpan.Zero;
                var lastDuration = EstimateDuration(lastEntry.Text);
                globalOffset = globalOffset.Add(normalizedLastTime).Add(TimeSpan.FromSeconds(lastDuration));
            }
            else if (section.DurationSeconds > 0)
            {
                // Fallback: no entries/text found, advance by metadata duration
                globalOffset = globalOffset.Add(TimeSpan.FromSeconds(section.DurationSeconds));
            }
        }

        return sb.ToString();
    }

    /// <summary>
    /// Parse timestamped entries from markdown content.
    /// Returns list of (timestamp, text) pairs.
    /// </summary>
    private static List<(TimeSpan Timestamp, string Text)> ParseTimestampedEntries(
        string content, System.Text.RegularExpressions.Regex timestampPattern)
    {
        var entries = new List<(TimeSpan Timestamp, string Text)>();
        var matches = timestampPattern.Matches(content);

        if (matches.Count == 0) return entries;

        // Collect text before first timestamp (if any)
        var firstMatch = matches[0];
        if (firstMatch.Index > 0)
        {
            var beforeText = content[..firstMatch.Index].Trim();
            if (!string.IsNullOrWhiteSpace(beforeText) && !IsOnlyHeader(beforeText))
            {
                entries.Add((TimeSpan.Zero, beforeText));
            }
        }

        for (int i = 0; i < matches.Count; i++)
        {
            var match = matches[i];
            var mins = int.Parse(match.Groups[1].Value);
            var secs = int.Parse(match.Groups[2].Value);
            var timestamp = new TimeSpan(0, mins, secs);

            // Text runs from end of this match to start of next match (or end of content)
            var textStart = match.Index + match.Length;
            var textEnd = i + 1 < matches.Count ? matches[i + 1].Index : content.Length;
            var text = content[textStart..textEnd].Trim();

            if (!string.IsNullOrWhiteSpace(text))
            {
                entries.Add((timestamp, text));
            }
        }

        return entries;
    }

    /// <summary>Check if text is only a markdown header line</summary>
    private static bool IsOnlyHeader(string text)
    {
        var trimmed = text.Trim();
        return trimmed.StartsWith('#') ||
               System.Text.RegularExpressions.Regex.IsMatch(trimmed,
                   @"^\s*(?:Opening Hook|Kontekstualisasi|Multi-Dimensi|Climax|Eschatology|Contextualization|Content|Refleksi)\s*$",
                   System.Text.RegularExpressions.RegexOptions.IgnoreCase);
    }

    private string GetAssetUrl(string absolutePath)
    {
        if (string.IsNullOrEmpty(absolutePath)) return "";
        if (absolutePath.StartsWith("http", StringComparison.OrdinalIgnoreCase)) return absolutePath;

        // Normalize slashes
        var normalized = absolutePath.Replace("\\", "/");
        
        // Check for "output/" marker to handle cross-platform/absolute paths
        var markerIndex = normalized.IndexOf("output/", StringComparison.OrdinalIgnoreCase);
        if (markerIndex >= 0)
        {
            var relative = normalized.Substring(markerIndex + "output/".Length);
            return $"/project-assets/{relative}";
        }

        // Fallback for same-system absolute paths
        try
        {
            var baseDir = Path.Combine(Directory.GetCurrentDirectory(), "output");
            var relative = Path.GetRelativePath(baseDir, absolutePath).Replace("\\", "/");
            return $"/project-assets/{relative}";
        }
        catch
        {
            return absolutePath; // Give up and return original
        }
    }

    private string ResolveLocalPath(string? absolutePath)
    {
        if (string.IsNullOrEmpty(absolutePath)) return "";
        
        // Normalize slashes
        var normalized = absolutePath.Replace("\\", "/");

        // Check for "output/" marker
        var markerIndex = normalized.IndexOf("output/", StringComparison.OrdinalIgnoreCase);
        if (markerIndex >= 0)
        {
            var relative = normalized.Substring(markerIndex + "output/".Length);
            // Construct local path using current OS directory separator
            return Path.Combine(Directory.GetCurrentDirectory(), "output", relative.Replace("/", Path.DirectorySeparatorChar.ToString()));
        }

        return absolutePath;
    }

    private static int EstimateDuration(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return 1;
        var words = text.Split(new[] { ' ', '\t', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries);
        var baseDuration = words.Length / 2.5; // 150 wpm = 2.5 wps
        var ellipsisCount = System.Text.RegularExpressions.Regex.Matches(text, @"\.\.\.").Count;
        var totalDuration = baseDuration + (ellipsisCount * 0.5);
        return (int)Math.Ceiling(Math.Max(3, totalDuration));
    }

    private static string CleanSubtitleText(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return string.Empty;
        var result = text;

        // 1. Remove markdown headers (e.g., ## Opening Hook)
        result = System.Text.RegularExpressions.Regex.Replace(result, @"^#+\s+.*$", "", System.Text.RegularExpressions.RegexOptions.Multiline);
        
        // 2. Remove common phase headers (without hashes) at start of lines
        result = System.Text.RegularExpressions.Regex.Replace(result, @"^\s*(?:Opening Hook|Kontekstualisasi|Multi-Dimensi|Climax|Eschatology|Contextualization|Content|Segment \d+):?\s*$", "", System.Text.RegularExpressions.RegexOptions.Multiline | System.Text.RegularExpressions.RegexOptions.IgnoreCase);

        // 3. Remove embedded timestamps like 00:00, 01:25, 000:58, or [00:15]
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\[\d{1,3}:\d{2}(?::\d{2})?\]", "");
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\b\d{1,3}:\d{2}(?::\d{2})?\b", "");

        // 4. Remove visual/production markers in brackets
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\[(?:Visual|Musik|Music|Efek|Effect|SFX|Audio|PAUSE)[^\]]*\]", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);

        // 5. Remove stage directions in parentheses
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\([^)]*\)", "");

        // 6. Basic formatting and symbols
        result = result.Replace("\"", "").Replace("'", "");
        result = result.Replace("*", "").Replace("_", "");
        result = System.Text.RegularExpressions.Regex.Replace(result, @"#\S+", "");
        result = result.Replace("[", "").Replace("]", "");
        result = result.Replace(".. .", "").Replace("...", "");
        result = result.Replace("‚Äî", " - ").Replace("‚Äì", " - ");

        // 7. Cleanup multiple spaces and newlines
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+", " ");

        // 8. Specific typos/fixes
        result = result.Replace("Wallahuam bissawab", "Wallahu a'lam bish-shawab");
        result = result.Replace("Wallahualam bissawab", "Wallahu a'lam bish-shawab");
        
        return result.Trim();
    }


    private string FormatDate(DateTime date)
    {
        var elapsed = DateTime.UtcNow - date;
        if (elapsed.TotalMinutes < 1) return "baru saja";
        if (elapsed.TotalHours < 1) return $"{(int)elapsed.TotalMinutes}m lalu";
        if (elapsed.TotalDays < 1) return $"{(int)elapsed.TotalHours}j lalu";
        if (elapsed.TotalDays < 7) return $"{(int)elapsed.TotalDays}h lalu";
        return date.ToString("dd MMM yyyy");
    }

    private static RenderFragment StatusBadge(SessionStatus status) => status switch
    {
        SessionStatus.Completed => @<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium bg-success/15 text-success"><span>‚óè</span> Selesai</span>,
        SessionStatus.Running => @<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium bg-primary/15 text-primary"><span class="animate-pulse">‚óè</span> Berjalan</span>,
        SessionStatus.Failed => @<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium bg-destructive/15 text-destructive"><span>‚óè</span> Gagal</span>,
        _ => @<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium bg-muted-foreground/15 text-muted-foreground"><span>‚óè</span> Pending</span>
    };

    private class PhaseStatusItem
    {
        public string PhaseId { get; set; } = "";
        public string Name { get; set; } = "";
        public int Order { get; set; }
        public string Status { get; set; } = "Pending";
        public int WordCount { get; set; }
        public List<string>? OutlinePoints { get; set; }
        public string DurationTarget { get; set; } = "";
    }

    private class ResultSection
    {
        public string PhaseId { get; set; } = "";
        public string PhaseName { get; set; } = "";
        public int Order { get; set; }
        public string Content { get; set; } = "";
        public int WordCount { get; set; }
        public double DurationSeconds { get; set; }
        public bool IsValidated { get; set; }
        public bool IsExpanded { get; set; }
        public bool IsRegenerating { get; set; }
        public List<string>? OutlinePoints { get; set; }
        public string CopyState { get; set; } = "idle";
        public bool IsFileMissing { get; set; }
    }

    // ===== Confirmation Modal State =====
    private bool _showConfirmDialog;
    private string _confirmTitle = "";
    private string _confirmMessage = "";
    private Func<Task>? _pendingConfirmAction;

    private void RequestConfirmation(string title, string message, Func<Task> action)
    {
        _confirmTitle = title;
        _confirmMessage = message;
        _pendingConfirmAction = action;
        _showConfirmDialog = true;
        StateHasChanged();
    }

    private void CancelConfirm()
    {
        _showConfirmDialog = false;
        _pendingConfirmAction = null;
    }

    private async Task ExecuteConfirm()
    {
        _showConfirmDialog = false;
        if (_pendingConfirmAction != null)
        {
            await _pendingConfirmAction();
        }
        _pendingConfirmAction = null;
        StateHasChanged();
    }
}

@* ===== Global Confirmation Modal ===== *@
@if (_showConfirmDialog)
{
    <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-background/80 backdrop-blur-sm animate-in fade-in-0" 
         @onclick="CancelConfirm">
        <div class="w-full max-w-sm bg-background border border-border rounded-lg shadow-lg p-6 space-y-4 animate-in zoom-in-95" 
             @onclick:stopPropagation="true">
            <div class="flex flex-col gap-1">
                <h3 class="text-lg font-semibold">@_confirmTitle</h3>
                <p class="text-sm text-muted-foreground">@_confirmMessage</p>
            </div>
            <div class="flex justify-end gap-2 pt-2">
                <button class="btn-ghost text-sm px-4" @onclick="CancelConfirm">Batal</button>
                <button class="px-4 py-2 bg-destructive text-destructive-foreground hover:bg-destructive/90 rounded-md text-sm font-medium transition-colors" 
                        @onclick="ExecuteConfirm">
                    Ya, Lanjutkan
                </button>
            </div>
        </div>
    </div>
}
