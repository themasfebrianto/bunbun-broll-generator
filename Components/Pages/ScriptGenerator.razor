@page "/script-generator"
@rendermode InteractiveServer
@using BunbunBroll.Services
@using BunbunBroll.Orchestration
@using BunbunBroll.Models
@inject IScriptGenerationService ScriptService
@inject IScriptOrchestrator Orchestrator
@inject IConfiguration Configuration
@inject NavigationManager Navigation
@inject ConfigBatchGenerator BatchGenerator
@inject IJSRuntime JS

<div class="max-w-[90rem] mx-auto py-20 px-4">
    <div class="space-y-3 mb-10 text-center">
        <h1 class="text-4xl font-bold tracking-tight">Script Generator</h1>
        <p class="text-muted-foreground text-lg">Buat script video essay dari pattern.</p>
    </div>

    @* ============ VIEW 0: Session List ============ *@
    @if (_currentView == "list")
    {
        <div class="max-w-[52rem] mx-auto space-y-4">
            <div class="flex justify-end gap-3">
                <button class="btn-secondary flex items-center gap-2" @onclick="ShowBatchForm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    Batch Generate
                </button>
                <button class="btn-primary flex items-center gap-2" @onclick="ShowConfigForm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Buat Script Baru
                </button>
            </div>

            @if (_isLoadingSessions)
            {
                <div class="card p-12 text-center text-muted-foreground">
                    <svg class="animate-spin h-6 w-6 mx-auto mb-3 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Memuat sesi...
                </div>
            }
            else if (_sessions.Count == 0)
            {
                <div class="card p-12 text-center">
                    <div class="text-muted-foreground space-y-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-lg font-medium">Belum ada script</p>
                        <p class="text-sm">Klik "Buat Script Baru" untuk memulai.</p>
                    </div>
                </div>
            }
            else
            {
                @foreach (var session in _sessions)
                {
                    <div class="card p-5 cursor-pointer hover:border-primary/40 transition-colors group"
                         @onclick="() => HandleViewSession(session)">
                        <div class="flex items-start justify-between gap-4">
                            <div class="min-w-0 flex-1 space-y-1">
                                <h3 class="font-semibold text-base truncate">@session.Topic</h3>
                                <div class="flex items-center gap-2 text-xs text-muted-foreground flex-wrap">
                                    <span class="badge badge-mono text-[10px]">@session.Id</span>
                                    @if (!string.IsNullOrEmpty(session.ChannelName))
                                    {
                                        <span class="px-1.5 py-0.5 rounded bg-primary/10 text-primary text-[10px] font-medium">@session.ChannelName</span>
                                    }
                                    <span>¬∑</span>
                                    <span>@FormatDate(session.CreatedAt)</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 shrink-0">
                                @if (session.Status == SessionStatus.Completed)
                                {
                                    var totalWords = session.Phases.Sum(p => p.WordCount ?? 0);
                                    var totalMins = (int)(session.Phases.Sum(p => p.DurationSeconds ?? 0) / 60);
                                    <div class="text-right text-xs text-muted-foreground">
                                        <span class="font-medium text-foreground">@totalWords</span> kata
                                        <br />~@totalMins menit
                                    </div>
                                }
                                @StatusBadge(session.Status)
                                <button class="btn-ghost text-xs px-1.5 py-1 opacity-0 group-hover:opacity-100 transition-opacity text-destructive hover:bg-destructive/10"
                                        title="Hapus sesi"
                                        @onclick="() => HandleDeleteSession(session)"
                                        @onclick:stopPropagation="true">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        @if (session.Phases.Count > 0)
                        {
                            <div class="mt-3 flex gap-[3px]">
                                @foreach (var phase in session.Phases.OrderBy(p => p.Order))
                                {
                                    var bgClass = phase.Status switch
                                    {
                                        PhaseStatus.Completed => "bg-success",
                                        PhaseStatus.Failed => "bg-destructive",
                                        PhaseStatus.InProgress => "bg-primary animate-pulse",
                                        _ => "bg-muted-foreground/20"
                                    };
                                    <div class="h-1.5 flex-1 rounded-full @bgClass" title="@phase.PhaseName (@phase.Status)"></div>
                                }
                            </div>
                        }
                    </div>
                }
            }
        </div>
    }

    @* ============ VIEW 1: Config Form ============ *@
    @if (_currentView == "config")
    {
        <div class="max-w-[52rem] mx-auto card p-8 space-y-6">
            <div class="flex items-center gap-3 mb-2">
                <button class="btn-ghost text-sm px-2 py-1" @onclick='() => _currentView = "list"'>‚Üê Kembali</button>
                <h2 class="text-lg font-semibold">Buat Script Baru</h2>
            </div>

            @* Channel Name *@
            <div class="space-y-2">
                <label class="block text-sm font-medium">Channel <span class="text-destructive">*</span></label>
                <select class="input" @bind="_channelName">
                    <option value="">Pilih channel...</option>
                    @foreach (var ch in _channelNames)
                    {
                        <option value="@ch">@ch</option>
                    }
                </select>
            </div>

            @* Pattern Selection *@
            <div class="space-y-2">
                <label class="block text-sm font-medium">Pattern</label>
                <select class="input" @bind="_selectedPatternId">
                    <option value="">Pilih pattern...</option>
                    @foreach (var p in _availablePatterns)
                    {
                        <option value="@p.Id">@p.Name (@p.PhaseCount fase)</option>
                    }
                </select>
                @if (_selectedPattern != null)
                {
                    <p class="text-xs text-muted-foreground mt-1">@_selectedPattern.Description</p>
                }
            </div>

            @* Topic *@
            <div class="space-y-2">
                <label class="block text-sm font-medium">Topik <span class="text-destructive">*</span></label>
                <input class="input" placeholder="Judul atau topik utama video essay" @bind="_topic" />
            </div>

            @* Outline *@
            <div class="space-y-2">
                <label class="block text-sm font-medium">Outline (opsional)</label>
                <textarea class="input min-h-[100px] resize-y" placeholder="Garis besar atau poin-poin yang ingin dibahas" @bind="_outline"></textarea>
            </div>

            @* Source References *@
            <div class="space-y-2">
                <label class="block text-sm font-medium">Referensi (opsional)</label>
                <textarea class="input min-h-[80px] resize-y" placeholder="Sumber referensi, data, atau kutipan" @bind="_sourceReferences"></textarea>
            </div>

            @* Target Duration *@
            <div class="space-y-2">
                <label class="block text-sm font-medium">Target Durasi (menit)</label>
                <input type="number" class="input w-32" min="5" max="60" @bind="_targetDuration" />
            </div>

            <div class="flex gap-3 pt-2">
                <button class="btn-primary flex-1" disabled="@(!CanGenerate)" @onclick="HandleGenerate">
                    @if (_isGenerating)
                    {
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Menulis Script...</span>
                    }
                    else
                    {
                        <span>Mulai Generate</span>
                    }
                </button>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="rounded-lg border border-destructive/30 bg-destructive/10 p-3 text-destructive text-sm">@_errorMessage</div>
            }
        </div>
    }

    @* ============ VIEW 2: Progress ============ *@
    @if (_currentView == "progress")
    {
        <div class="max-w-[52rem] mx-auto card p-8 space-y-6">
            <div class="space-y-2">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold">Generating: @_topic</h2>
                    <span class="badge badge-mono">@_sessionId</span>
                </div>
                <p class="text-sm text-muted-foreground">@_progressMessage</p>
                @if (!string.IsNullOrWhiteSpace(_outline))
                {
                    <details class="group bg-muted/40 rounded-lg overflow-hidden border border-border/50">
                        <summary class="flex items-center gap-2 px-4 py-2.5 cursor-pointer hover:bg-muted/60 transition-colors select-none">
                            <span class="p-1 rounded-md bg-primary/10 text-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
                            </span>
                            <span class="text-xs font-semibold uppercase tracking-wider text-muted-foreground flex-1">Script Outline</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-muted-foreground group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </summary>
                        <div class="px-4 pb-4 pt-1">
                             <div class="text-sm text-foreground/80 whitespace-pre-wrap leading-relaxed pl-8 border-l-2 border-primary/20">@_outline</div>
                        </div>
                    </details>
                }
            </div>
            <div class="space-y-2">
                <div class="h-2 rounded-full bg-muted overflow-hidden">
                    <div class="h-full bg-primary rounded-full transition-all duration-500" style="width: @(_progressPercent)%"></div>
                </div>
                <p class="text-xs text-muted-foreground text-right">@_completedPhases / @_totalPhases fase</p>
            </div>
            <div class="space-y-3">
                @foreach (var phase in _phaseStatuses)
                {
                    <div class="flex items-center gap-3 text-sm">
                        @if (phase.Status == "Completed")
                        {
                            <span class="text-success text-lg">‚úì</span>
                        }
                        else if (phase.Status == "InProgress")
                        {
                            <svg class="animate-spin h-4 w-4 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        }
                        else if (phase.Status == "Failed")
                        {
                            <span class="text-destructive text-lg">‚úó</span>
                        }
                        else
                        {
                            <span class="text-muted-foreground text-lg">‚óã</span>
                        }
                        <span class="@(phase.Status == "InProgress" ? "text-foreground font-medium" : phase.Status == "Completed" ? "text-muted-foreground" : "text-muted-foreground/60")">
                            @phase.Name
                        </span>
                        @if (phase.WordCount > 0)
                        {
                            <span class="text-xs text-muted-foreground ml-auto">@phase.WordCount kata</span>
                        }
                        else if (!string.IsNullOrEmpty(phase.DurationTarget) && phase.Status == "InProgress")
                        {
                            <span class="text-xs text-primary ml-auto font-mono bg-primary/10 px-2 py-0.5 rounded">Target: @phase.DurationTarget</span>
                        }
                    </div>
                    @if (phase.OutlinePoints?.Count > 0)
                    {
                        <div class="ml-8 mt-1 mb-1 pl-3 border-l-2 border-primary/20">
                            @foreach (var point in phase.OutlinePoints)
                            {
                                <p class="text-xs text-muted-foreground leading-relaxed">‚Ä¢ @point</p>
                            }
                        </div>
                    }
                }
            </div>
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="rounded-lg border border-destructive/30 bg-destructive/10 p-3 text-destructive text-sm">@_errorMessage</div>
            }
        </div>
    }

    @* ============ VIEW: Batch Gen-Configs ============ *@
    @if (_currentView == "batch")
    {
        <div class="max-w-[52rem] mx-auto space-y-6">
            <div class="card p-6 space-y-5">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-bold">Batch Generate Configs</h2>
                    <button class="btn-ghost text-sm" @onclick="HandleBackToList">‚Üê Kembali</button>
                </div>
                <p class="text-sm text-muted-foreground">Generate beberapa config sekaligus berdasarkan tema menggunakan AI.</p>

                @* Theme *@
                <div>
                    <label class="block text-xs font-medium text-muted-foreground mb-1.5">Tema *</label>
                    <input type="text" class="input w-full" placeholder="e.g. eschatology, sahabat, ekonomi, nabi" @bind="_batchTheme" />
                </div>

                @* Channel *@
                <div>
                    <label class="block text-xs font-medium text-muted-foreground mb-1.5">Channel *</label>
                    @if (_channelNames.Count > 0)
                    {
                        <select class="input w-full" @bind="_batchChannelName">
                            <option value="">Pilih channel...</option>
                            @foreach (var ch in _channelNames)
                            {
                                <option value="@ch">@ch</option>
                            }
                        </select>
                    }
                    else
                    {
                        <input type="text" class="input w-full" placeholder="Nama channel" @bind="_batchChannelName" />
                    }
                </div>

                <div class="grid grid-cols-2 gap-4">
                    @* Count *@
                    <div>
                        <label class="block text-xs font-medium text-muted-foreground mb-1.5">Jumlah Config</label>
                        <input type="number" class="input w-full" min="1" max="20" @bind="_batchCount" />
                    </div>
                    @* Pattern *@
                    <div>
                        <label class="block text-xs font-medium text-muted-foreground mb-1.5">Pattern</label>
                        <select class="input w-full" @bind="_batchPatternId">
                            @foreach (var p in _availablePatterns)
                            {
                                <option value="@p.Id">@p.Name</option>
                            }
                        </select>
                    </div>
                </div>

                @* Seed (optional) *@
                <div>
                    <label class="block text-xs font-medium text-muted-foreground mb-1.5">Seed / Instruksi Tambahan <span class="text-muted-foreground/60">(opsional)</span></label>
                    <textarea class="input w-full" rows="2" placeholder="e.g. gunakan angle dari sisi budaya indonesia" @bind="_batchSeed"></textarea>
                </div>

                @if (!string.IsNullOrEmpty(_batchError))
                {
                    <div class="rounded-lg border border-destructive/30 bg-destructive/10 p-3 text-destructive text-sm">@_batchError</div>
                }

                <button class="btn-primary w-full" 
                        disabled="@(!CanBatchGenerate)"
                        @onclick="HandleBatchGenerate">
                    @if (_isBatchGenerating)
                    {
                        <svg class="animate-spin h-4 w-4 mr-2 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Generating @_batchCount configs...</span>
                    }
                    else
                    {
                        <span>üöÄ Generate @_batchCount Configs</span>
                    }
                </button>
            </div>

            @* === Batch Results === *@
            @if (_batchResults.Count > 0)
            {
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-semibold">Hasil: @_batchResults.Count configs</h3>
                        <button class="btn-ghost text-xs" @onclick="HandleUseAllConfigs">Gunakan Semua ‚Üí</button>
                    </div>
                    @foreach (var (config, idx) in _batchResults.Select((c, i) => (c, i)))
                    {
                        <div class="card p-4 hover:border-primary/40 transition-colors">
                            <div class="flex items-start justify-between gap-3">
                                <div class="space-y-1.5 min-w-0 flex-1">
                                    <div class="flex items-center gap-2">
                                        <span class="flex items-center justify-center w-6 h-6 rounded-full bg-primary/15 text-primary text-xs font-bold">@(idx + 1)</span>
                                        <h4 class="font-semibold text-sm truncate">@config.Topic</h4>
                                    </div>
                                    @if (!string.IsNullOrEmpty(config.Outline))
                                    {
                                        <p class="text-xs text-muted-foreground line-clamp-2 ml-8">@config.Outline</p>
                                    }
                                    <div class="flex items-center gap-3 text-[11px] text-muted-foreground ml-8">
                                        <span>~@config.TargetDurationMinutes menit</span>
                                        @if (config.MustHaveBeats?.Count > 0)
                                        {
                                            <span>¬∑</span>
                                            <span>@config.MustHaveBeats.Count beats</span>
                                        }
                                        @if (!string.IsNullOrEmpty(config.SourceReferences))
                                        {
                                            <span>¬∑</span>
                                            <span class="truncate max-w-[200px]">@config.SourceReferences</span>
                                        }
                                    </div>
                                </div>
                                <button class="btn-primary text-xs px-3 py-1.5 flex-shrink-0" @onclick="() => HandleUseConfig(config)">
                                    Gunakan ‚Üí
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }

    @* ============ VIEW 3: Results ‚Äî Horizontal Scrollable ============ *@
    @if (_currentView == "results")
    {
        <div class="space-y-6">
            @* Header Card *@
            <div class="card p-6">
                <div class="flex items-start justify-between gap-4 mb-4">
                    <div class="space-y-1 min-w-0">
                        <h2 class="text-xl font-bold truncate">@_resultSession?.Topic</h2>
                        <div class="flex items-center gap-2 text-xs text-muted-foreground flex-wrap">
                            @if (!string.IsNullOrEmpty(_resultSession?.ChannelName))
                            {
                                <span class="px-2 py-0.5 rounded-full bg-primary/15 text-primary text-[11px] font-semibold">@_resultSession.ChannelName</span>
                            }
                            <span class="badge badge-mono text-[10px]">@_sessionId</span>
                            <span>¬∑</span>
                            <span>@_resultSession?.PatternId</span>
                            @if (_resultSession?.CompletedAt != null)
                            {
                                <span>¬∑</span>
                                <span>@FormatDate(_resultSession.CompletedAt.Value)</span>
                            }
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        @StatusBadge(_resultSession?.Status ?? SessionStatus.Pending)
                    </div>
                </div>

                @* Outline (Collapsible) *@
                @if (!string.IsNullOrWhiteSpace(_resultSession?.Outline))
                {
                    <div class="mb-6">
                        <details class="group bg-muted/40 rounded-lg overflow-hidden border border-border/50">
                            <summary class="flex items-center gap-2 px-4 py-2.5 cursor-pointer hover:bg-muted/60 transition-colors select-none">
                                <span class="p-1 rounded-md bg-primary/10 text-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
                                </span>
                                <span class="text-xs font-semibold uppercase tracking-wider text-muted-foreground flex-1">Script Outline</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-muted-foreground group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </summary>
                            <div class="px-4 pb-4 pt-1">
                                 <div class="text-sm text-foreground/80 whitespace-pre-wrap leading-relaxed pl-8 border-l-2 border-primary/20">@_resultSession.Outline</div>
                            </div>
                        </details>
                    </div>
                }

                @* Stats Row *@
                <div class="grid grid-cols-4 gap-3 mb-4">
                    <div class="text-center p-3 rounded-lg bg-muted/60">
                        <p class="text-2xl font-bold">@_totalWords</p>
                        <p class="text-[10px] text-muted-foreground uppercase tracking-wide">kata</p>
                    </div>
                    <div class="text-center p-3 rounded-lg bg-muted/60">
                        <p class="text-2xl font-bold">~@_totalMinutes</p>
                        <p class="text-[10px] text-muted-foreground uppercase tracking-wide">menit</p>
                    </div>
                    <div class="text-center p-3 rounded-lg bg-muted/60">
                        <p class="text-2xl font-bold">@_totalPhases</p>
                        <p class="text-[10px] text-muted-foreground uppercase tracking-wide">fase</p>
                    </div>
                    <div class="text-center p-3 rounded-lg bg-muted/60">
                        <p class="text-2xl font-bold">@_validatedCount</p>
                        <p class="text-[10px] text-muted-foreground uppercase tracking-wide">valid</p>
                    </div>
                </div>

                @* Action buttons *@
                <div class="flex gap-3">
                    <button class="btn-secondary text-sm" @onclick="HandleBackToList">‚Üê Daftar Script</button>
                    <button class="btn-ghost text-sm flex items-center gap-1.5"
                            disabled="@(_isRegeneratingAll)"
                            @onclick="HandleRegenerateAll">
                        @if (_isRegeneratingAll)
                        {
                            <svg class="animate-spin h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Regenerating All...</span>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                            <span>Regenerate All</span>
                        }
                    </button>
                    <div class="flex-1"></div>
                    <button class="btn-secondary text-sm flex items-center gap-1.5"
                            disabled="@(_isExportingLrc)"
                            @onclick="HandleExportLrc">
                        @if (_isExportingLrc)
                        {
                            <svg class="animate-spin h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Exporting...</span>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            <span>Export LRC</span>
                        }
                    </button>
                    <button class="btn-primary text-sm" @onclick="HandleSendToBroll">Kirim ke B-Roll ‚Üí</button>
                </div>
            </div>

            @* Horizontal Scrollable Phase Cards ‚Äî Full Width Script View *@
            <div class="overflow-x-auto pb-4 -mx-4 px-4">
                <div class="flex gap-5" style="min-width: max-content;">
                    @foreach (var sec in _resultSections)
                    {
                        <div class="card overflow-hidden flex-shrink-0" style="width: 720px;">
                            @* Phase Header ‚Äî Sticky *@
                            <div class="flex items-center justify-between px-6 py-4 border-b border-border/50 bg-card/95 backdrop-blur-sm cursor-pointer sticky top-0 z-10"
                                 @onclick="() => ToggleSection(sec)">
                                <div class="flex items-center gap-3">
                                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-primary/15 text-primary text-sm font-bold">@sec.Order</span>
                                    <div>
                                        <h3 class="font-semibold text-base">@sec.PhaseName</h3>
                                        <span class="text-xs text-muted-foreground">@sec.WordCount kata ¬∑ ~@((int)(sec.DurationSeconds / 60)) menit</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    @if (sec.IsValidated)
                                    {
                                        <span class="text-success text-sm flex items-center gap-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                                        </span>
                                    }
                                    @* Outline Indicator *@
                                    @if (sec.OutlinePoints?.Count > 0)
                                    {
                                        <div class="badge badge-ghost badge-sm gap-1 text-muted-foreground/60 font-normal select-none">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                                            <span class="text-[10px]">Outline</span>
                                        </div>
                                    }

                                    @* Copy Button *@
                                    <button class="btn-ghost text-xs px-2 py-1.5 flex items-center gap-1"
                                            title="Copy script"
                                            @onclick="() => HandleCopyPhaseContent(sec)"
                                            @onclick:stopPropagation="true">
                                        @if (sec.CopyState == "copied")
                                        {
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                                        }
                                        else
                                        {
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                        }
                                    </button>
                                    @* Regenerate Button *@
                                    <button class="btn-ghost text-xs px-2 py-1.5 flex items-center gap-1"
                                            disabled="@(sec.IsRegenerating)"
                                            @onclick="() => HandleRegeneratePhase(sec)"
                                            @onclick:stopPropagation="true">
                                        @if (sec.IsRegenerating)
                                        {
                                            <svg class="animate-spin h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                        }
                                        else
                                        {
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                        }
                                    </button>
                                    <span class="text-sm text-muted-foreground select-none">
                                        @(sec.IsExpanded ? "‚ñ≤" : "‚ñº")
                                    </span>
                                </div>
                            </div>

                            @* Content ‚Äî expanded by default, large readable text *@
                            @if (sec.IsExpanded)
                            {
                                <div class="px-8 py-6 overflow-y-auto" style="max-height: 75vh;">
                                    
                                    @* Outline Block *@
                                    @if (sec.OutlinePoints?.Count > 0)
                                    {
                                        <div class="mb-6 p-4 rounded-lg bg-muted/40 border border-border/50">
                                            <div class="text-[10px] font-bold uppercase tracking-wider text-muted-foreground mb-2 flex items-center gap-2 select-none">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                                                Setup Outline
                                            </div>
                                            <ul class="list-disc list-outside ml-4 space-y-1.5 text-sm text-foreground/80 marker:text-muted-foreground">
                                                @foreach (var point in sec.OutlinePoints)
                                                {
                                                    <li>@point</li>
                                                }
                                            </ul>
                                        </div>
                                    }

                                    <div class="prose prose-invert prose-lg max-w-none whitespace-pre-wrap leading-[1.9]">@NormalizeTimestamps(sec.Content)</div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="rounded-lg border border-destructive/30 bg-destructive/10 p-3 text-destructive text-sm">@_errorMessage</div>
            }
            @if (!string.IsNullOrEmpty(_lrcExportPath))
            {
                <div class="rounded-lg border border-success/30 bg-success/10 p-3 text-success text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    <span>LRC exported: <code class="text-xs">@_lrcExportPath</code></span>
                </div>
            }
        </div>
    }
</div>

@* ============ Delete Confirmation Modal ============ *@
@if (_showDeleteConfirm)
{
    <div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" @onclick="CancelDelete">
        <div class="card p-6 max-w-sm w-full space-y-4" @onclick:stopPropagation="true">
            <h3 class="font-semibold text-lg">Hapus Script?</h3>
            <p class="text-sm text-muted-foreground">
                Script "<span class="font-medium text-foreground">@_deleteTarget?.Topic</span>" akan dihapus beserta semua file-nya.
            </p>
            <div class="flex gap-3 pt-2">
                <button class="btn-secondary flex-1" @onclick="CancelDelete">Batal</button>
                <button class="btn-primary flex-1 !bg-destructive hover:!bg-destructive/90" 
                        disabled="@_isDeleting"
                        @onclick="ConfirmDelete">
                    @if (_isDeleting)
                    {
                        <svg class="animate-spin h-4 w-4 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    }
                    Hapus
                </button>
            </div>
        </div>
    </div>
}

@code {
    // Views: list, config, progress, results
    private string _currentView = "list";
    private List<ScriptGenerationSession> _sessions = new();
    private bool _isLoadingSessions = true;

    // Config
    private List<ScriptPattern> _availablePatterns = new();
    private List<string> _channelNames = new();
    private string _selectedPatternId = "";
    private ScriptPattern? _selectedPattern => _availablePatterns.FirstOrDefault(p => p.Id == _selectedPatternId);
    private string _channelName = "";
    private string _topic = "";
    private string? _outline;
    private string? _sourceReferences;
    private int _targetDuration = 30;
    private bool _isGenerating = false;
    private string? _errorMessage;

    // Progress
    private string? _sessionId;
    private string? _progressMessage;
    private double _progressPercent;
    private int _completedPhases;
    private int _totalPhases;
    private List<PhaseStatusItem> _phaseStatuses = new();

    // Results
    private ScriptGenerationSession? _resultSession;
    private List<ResultSection> _resultSections = new();
    private int _totalWords;
    private int _totalMinutes;
    private int _validatedCount;
    private bool _isRegeneratingAll;
    private bool _isExportingLrc;
    private string? _lrcExportPath;

    // Delete
    private bool _showDeleteConfirm;
    private ScriptGenerationSession? _deleteTarget;

    // Batch Gen-Configs
    private string _batchTheme = "";
    private string _batchChannelName = "";
    private int _batchCount = 10;
    private string _batchPatternId = "";
    private string? _batchSeed;
    private bool _isBatchGenerating;
    private string? _batchError;
    private List<GeneratedConfig> _batchResults = new();
    private bool _isDeleting;

    private bool CanGenerate => !string.IsNullOrWhiteSpace(_topic)
        && !string.IsNullOrWhiteSpace(_selectedPatternId)
        && !string.IsNullOrWhiteSpace(_channelName)
        && !_isGenerating;

    protected override async Task OnInitializedAsync()
    {
        // Load channel names from config
        _channelNames = Configuration.GetSection("Channels").Get<List<string>>() ?? new List<string>();

        await LoadSessionsAsync();
        _availablePatterns = await ScriptService.GetAvailablePatternsAsync();
        if (_availablePatterns.Count == 1)
            _selectedPatternId = _availablePatterns[0].Id;
        if (_channelNames.Count == 1)
        {
            _channelName = _channelNames[0];
            _batchChannelName = _channelNames[0];
        }
        if (_availablePatterns.Count == 1)
            _batchPatternId = _availablePatterns[0].Id;
    }

    private async Task LoadSessionsAsync()
    {
        _isLoadingSessions = true;
        try { _sessions = await ScriptService.ListSessionsAsync(); }
        catch { _sessions = new(); }
        finally { _isLoadingSessions = false; }
    }

    private void ShowConfigForm()
    {
        _currentView = "config";
        _topic = "";
        _outline = null;
        _sourceReferences = null;
        _errorMessage = null;
    }

    // ===== Batch Gen-Configs =====

    private void ShowBatchForm()
    {
        _currentView = "batch";
        _batchTheme = "";
        _batchSeed = null;
        _batchError = null;
        _batchResults.Clear();
    }

    private bool CanBatchGenerate => !string.IsNullOrWhiteSpace(_batchTheme)
        && !string.IsNullOrWhiteSpace(_batchChannelName)
        && !_isBatchGenerating;

    private async Task HandleBatchGenerate()
    {
        if (!CanBatchGenerate) return;
        _isBatchGenerating = true;
        _batchError = null;
        _batchResults.Clear();
        StateHasChanged();

        try
        {
            var configs = await BatchGenerator.GenerateConfigsAsync(
                _batchTheme, _batchChannelName, _batchCount, _batchSeed);
            _batchResults = configs;
        }
        catch (Exception ex) { _batchError = $"Gagal: {ex.Message}"; }
        finally { _isBatchGenerating = false; StateHasChanged(); }
    }

    private void HandleUseConfig(GeneratedConfig config)
    {
        _topic = config.Topic;
        _outline = config.Outline;
        _sourceReferences = config.SourceReferences;
        _targetDuration = config.TargetDurationMinutes;
        _channelName = config.ChannelName;
        _selectedPatternId = !string.IsNullOrEmpty(_batchPatternId) ? _batchPatternId : _selectedPatternId;
        _errorMessage = null;
        _currentView = "config";
    }

    private void HandleUseAllConfigs()
    {
        if (_batchResults.Count > 0)
            HandleUseConfig(_batchResults[0]);
    }

    // ===== Delete Session =====

    private void HandleDeleteSession(ScriptGenerationSession session)
    {
        _deleteTarget = session;
        _showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        _showDeleteConfirm = false;
        _deleteTarget = null;
    }

    private async Task ConfirmDelete()
    {
        if (_deleteTarget == null) return;
        _isDeleting = true;
        try
        {
            await ScriptService.DeleteSessionAsync(_deleteTarget.Id);
            _sessions.Remove(_deleteTarget);
        }
        catch (Exception ex) { _errorMessage = $"Gagal menghapus: {ex.Message}"; }
        finally
        {
            _isDeleting = false;
            _showDeleteConfirm = false;
            _deleteTarget = null;
            StateHasChanged();
        }
    }

    // ===== View Session =====

    private async Task HandleViewSession(ScriptGenerationSession session)
    {
        _sessionId = session.Id;
        _resultSession = session;
        _totalPhases = session.Phases.Count;

        if (session.Status == SessionStatus.Completed)
        {
            await LoadResultSections(session);
            _currentView = "results";
        }
        else if (session.Status == SessionStatus.Running || session.Status == SessionStatus.Failed)
        {
            _phaseStatuses = session.Phases.OrderBy(p => p.Order).Select(p => new PhaseStatusItem
            {
                PhaseId = p.PhaseId, Name = p.PhaseName, Order = p.Order,
                Status = p.Status.ToString(), WordCount = p.WordCount ?? 0
            }).ToList();
            _completedPhases = session.Phases.Count(p => p.Status == PhaseStatus.Completed);
            _progressPercent = _totalPhases > 0 ? (double)_completedPhases / _totalPhases * 100 : 0;
            _progressMessage = session.ErrorMessage ?? "Sedang berjalan...";
            _errorMessage = session.Status == SessionStatus.Failed ? session.ErrorMessage : null;
            _currentView = "progress";
        }
    }

    private async Task LoadResultSections(ScriptGenerationSession session)
    {
        _resultSections.Clear();
        
        // Load outline distribution
        Dictionary<string, List<string>> outlineDist = new();
        if (!string.IsNullOrEmpty(session.OutlineDistributionJson))
        {
            try { outlineDist = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, List<string>>>(session.OutlineDistributionJson) ?? new(); }
            catch { /* ignore */ }
        }

        foreach (var phase in session.Phases.OrderBy(p => p.Order))
        {
            var content = "";
            if (!string.IsNullOrEmpty(phase.ContentFilePath) && File.Exists(phase.ContentFilePath))
                content = await File.ReadAllTextAsync(phase.ContentFilePath);

            List<string>? points = null;
            if (outlineDist.TryGetValue(phase.PhaseId, out var pts)) points = pts;

            _resultSections.Add(new ResultSection
            {
                PhaseId = phase.PhaseId,
                PhaseName = phase.PhaseName,
                Order = phase.Order,
                Content = content,
                WordCount = phase.WordCount ?? 0,
                DurationSeconds = phase.DurationSeconds ?? 0,
                IsValidated = phase.IsValidated,
                IsExpanded = true,
                OutlinePoints = points
            });
        }
        _totalWords = session.Phases.Sum(p => p.WordCount ?? 0);
        _totalMinutes = (int)(session.Phases.Sum(p => p.DurationSeconds ?? 0) / 60);
        _validatedCount = session.Phases.Count(p => p.IsValidated);
    }

    // ===== Generate =====

    private async Task HandleGenerate()
    {
        if (!CanGenerate) return;
        _isGenerating = true;
        _errorMessage = null;

        try
        {
            var session = await ScriptService.CreateSessionAsync(
                _selectedPatternId, _topic, _outline, _targetDuration, _sourceReferences, _channelName);
            _sessionId = session.Id;
            _totalPhases = session.Phases.Count;
            _completedPhases = 0;
            _progressPercent = 0;
            _progressMessage = "Mempersiapkan...";

            _phaseStatuses = session.Phases.OrderBy(p => p.Order).Select(p => new PhaseStatusItem
            {
                PhaseId = p.PhaseId, Name = p.PhaseName, Order = p.Order, Status = "Pending"
            }).ToList();

            _currentView = "progress";
            StateHasChanged();

            Orchestrator.OnPhaseProgress += HandlePhaseProgress;
            Orchestrator.OnSessionProgress += HandleSessionProgress;

            try
            {
                session = await ScriptService.GenerateAsync(_sessionId);
                if (session.Status == SessionStatus.Completed)
                {
                    _resultSession = session;
                    await LoadResultSections(session);
                    _currentView = "results";
                }
                else
                {
                    _errorMessage = session.ErrorMessage ?? "Generasi gagal.";
                }
            }
            finally
            {
                Orchestrator.OnPhaseProgress -= HandlePhaseProgress;
                Orchestrator.OnSessionProgress -= HandleSessionProgress;
            }
        }
        catch (Exception ex) { _errorMessage = $"Error: {ex.Message}"; }
        finally { _isGenerating = false; StateHasChanged(); }
    }

    // ===== Regenerate Phase =====

    private async Task HandleRegeneratePhase(ResultSection section)
    {
        if (section.IsRegenerating || _sessionId == null) return;
        section.IsRegenerating = true;
        StateHasChanged();

        try
        {
            var session = await ScriptService.RegeneratePhaseAsync(_sessionId, section.PhaseId);
            _resultSession = session;

            // Reload the content for this section
            var updatedPhase = session.Phases.FirstOrDefault(p => p.PhaseId == section.PhaseId);
            if (updatedPhase != null)
            {
                if (!string.IsNullOrEmpty(updatedPhase.ContentFilePath) && File.Exists(updatedPhase.ContentFilePath))
                    section.Content = await File.ReadAllTextAsync(updatedPhase.ContentFilePath);
                section.WordCount = updatedPhase.WordCount ?? 0;
                section.DurationSeconds = updatedPhase.DurationSeconds ?? 0;
                section.IsValidated = updatedPhase.IsValidated;
                section.IsExpanded = true;
            }

            // Recalculate totals
            _totalWords = session.Phases.Sum(p => p.WordCount ?? 0);
            _totalMinutes = (int)(session.Phases.Sum(p => p.DurationSeconds ?? 0) / 60);
            _validatedCount = session.Phases.Count(p => p.IsValidated);
        }
        catch (Exception ex) { _errorMessage = $"Regenerate gagal: {ex.Message}"; }
        finally { section.IsRegenerating = false; StateHasChanged(); }
    }

    // ===== Regenerate All =====

    private async Task HandleRegenerateAll()
    {
        if (_isRegeneratingAll || _sessionId == null) return;
        _isRegeneratingAll = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            // Switch to progress view
            _progressMessage = "Regenerating semua fase...";
            _completedPhases = 0;
            _progressPercent = 0;

            _phaseStatuses = _resultSections.Select(s => new PhaseStatusItem
            {
                PhaseId = s.PhaseId, Name = s.PhaseName, Order = s.Order, Status = "Pending"
            }).ToList();

            _currentView = "progress";
            StateHasChanged();

            Orchestrator.OnPhaseProgress += HandlePhaseProgress;
            Orchestrator.OnSessionProgress += HandleSessionProgress;

            try
            {
                var session = await ScriptService.GenerateAsync(_sessionId);
                _resultSession = session;

                if (session.Status == SessionStatus.Completed)
                {
                    await LoadResultSections(session);
                    _currentView = "results";
                }
                else
                {
                    _errorMessage = session.ErrorMessage ?? "Regenerasi gagal.";
                }
            }
            finally
            {
                Orchestrator.OnPhaseProgress -= HandlePhaseProgress;
                Orchestrator.OnSessionProgress -= HandleSessionProgress;
            }
        }
        catch (Exception ex) { _errorMessage = $"Regenerate All gagal: {ex.Message}"; }
        finally { _isRegeneratingAll = false; StateHasChanged(); }
    }

    private void ToggleSection(ResultSection section) { section.IsExpanded = !section.IsExpanded; }

    // ===== Copy Phase Content =====

    private async Task HandleCopyPhaseContent(ResultSection section)
    {
        try
        {
            await JS.InvokeVoidAsync("copyToClipboard", section.Content);
            section.CopyState = "copied";
            StateHasChanged();

            // Reset after 2 seconds
            _ = Task.Run(async () =>
            {
                await Task.Delay(2000);
                await InvokeAsync(() =>
                {
                    section.CopyState = "idle";
                    StateHasChanged();
                });
            });
        }
        catch { /* silently fail */ }
    }

    private void HandlePhaseProgress(object? sender, Orchestration.Events.PhaseProgressEventArgs e)
    {
        InvokeAsync(() =>
        {
            var phase = _phaseStatuses.FirstOrDefault(p => p.PhaseId == e.PhaseId);
            if (phase != null)
            {
                phase.Status = e.Status;
                if (e.OutlinePoints?.Count > 0)
                    phase.OutlinePoints = e.OutlinePoints;
                if (!string.IsNullOrEmpty(e.DurationTarget))
                    phase.DurationTarget = e.DurationTarget;
            }
            _progressMessage = e.Message;
            StateHasChanged();
        });
    }

    private void HandleSessionProgress(object? sender, Orchestration.Events.SessionProgressEventArgs e)
    {
        InvokeAsync(() =>
        {
            _completedPhases = e.CompletedPhases;
            _totalPhases = e.TotalPhases;
            _progressPercent = e.ProgressPercent;
            _progressMessage = e.Message;
            StateHasChanged();
        });
    }

    private async Task HandleBackToList() { await LoadSessionsAsync(); _currentView = "list"; _errorMessage = null; }
    private void HandleSendToBroll() { Navigation.NavigateTo("/"); }

    // ===== Export LRC =====

    private async Task HandleExportLrc()
    {
        if (_isExportingLrc || _resultSession == null) return;
        _isExportingLrc = true;
        _errorMessage = null;
        _lrcExportPath = null;
        StateHasChanged();

        try
        {
            var lrcContent = GenerateLrcContent();
            var outputDir = _resultSession.OutputDirectory;
            if (string.IsNullOrEmpty(outputDir))
                throw new InvalidOperationException("Output directory not set on session");
            Directory.CreateDirectory(outputDir);
            var safeFilename = System.Text.RegularExpressions.Regex.Replace(
                _resultSession.Topic ?? "script", @"[^\w\s\-]", "").Trim().Replace(" ", "-");
            var lrcPath = Path.Combine(outputDir, $"{safeFilename}.lrc");
            await File.WriteAllTextAsync(lrcPath, lrcContent, System.Text.Encoding.UTF8);
            var bytes = System.Text.Encoding.UTF8.GetBytes(lrcContent);
            var base64 = Convert.ToBase64String(bytes);
            await JS.InvokeVoidAsync("downloadFile", $"{safeFilename}.lrc", base64, "text/plain");

            _lrcExportPath = lrcPath;
        }
        catch (Exception ex) { _errorMessage = $"Export LRC gagal: {ex.Message}"; }
        finally { _isExportingLrc = false; StateHasChanged(); }
    }

    private string GenerateLrcContent()
    {
        const int MinChars = 400;
        const int MaxChars = 500;

        var sb = new System.Text.StringBuilder();
        var startTime = TimeSpan.Zero;

        foreach (var section in _resultSections.OrderBy(s => s.Order))
        {
            if (string.IsNullOrWhiteSpace(section.Content)) continue;

            var segments = SplitContentForCapCut(section.Content, MinChars, MaxChars);

            foreach (var segment in segments)
            {
                // Clean the text first (while it still has newlines for Multiline regexes)
                var cleaned = CleanSubtitleText(segment);
                if (string.IsNullOrWhiteSpace(cleaned)) continue;

                var duration = EstimateDuration(segment);
                var endTime = startTime.Add(TimeSpan.FromSeconds(duration));

                // Flatten to single line for LRC output
                var singleLine = cleaned.Replace("\r\n", " ").Replace("\n", " ").Replace("\r", " ");
                singleLine = System.Text.RegularExpressions.Regex.Replace(singleLine, @"\s+", " ").Trim();

                var minutes = (int)startTime.TotalMinutes;
                var seconds = startTime.Seconds;
                var centiseconds = startTime.Milliseconds / 10;
                sb.AppendLine($"[{minutes:D2}:{seconds:D2}.{centiseconds:D2}]{singleLine}");

                startTime = endTime;
            }
        }

        return sb.ToString();
    }

    private static List<string> SplitContentForCapCut(string content, int minChars, int maxChars)
    {
        var segments = new List<string>();
        if (string.IsNullOrWhiteSpace(content)) return segments;

        content = content.Trim();

        // Normalize orphan quotes
        content = System.Text.RegularExpressions.Regex.Replace(content, @"""\s*\n\s*""", "\"");
        content = System.Text.RegularExpressions.Regex.Replace(content, @"\n\s*""", " \"");
        content = System.Text.RegularExpressions.Regex.Replace(content, @"""\s*\n", "\" ");

        // Split into sentences keeping punctuation with the sentence
        var sentenceMatches = System.Text.RegularExpressions.Regex.Matches(content, @"[^.!?]*[.!?]+");

        var sentences = new List<string>();
        foreach (System.Text.RegularExpressions.Match match in sentenceMatches)
        {
            if (match.Length > 0) sentences.Add(match.Value.Trim());
        }

        // Fallback: word-based split if no punctuation found
        if (sentences.Count == 0)
        {
            var words = content.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
            var currentSeg = new System.Text.StringBuilder();
            foreach (var word in words)
            {
                if (currentSeg.Length + word.Length + 1 > maxChars && currentSeg.Length >= minChars)
                {
                    segments.Add(currentSeg.ToString().Trim());
                    currentSeg.Clear();
                }
                if (currentSeg.Length > 0) currentSeg.Append(' ');
                currentSeg.Append(word);
            }
            if (currentSeg.Length > 0) segments.Add(currentSeg.ToString().Trim());
            return segments;
        }

        // Build segments from sentences
        var current = new System.Text.StringBuilder();
        var currentLength = 0;

        foreach (var sentence in sentences)
        {
            var sentenceLength = sentence.Length;

            // If single sentence exceeds max, split by words
            if (sentenceLength > maxChars)
            {
                if (currentLength > 0)
                {
                    segments.Add(current.ToString().Trim());
                    current.Clear();
                    currentLength = 0;
                }
                var words = sentence.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
                var wordBuf = new System.Text.StringBuilder();
                foreach (var word in words)
                {
                    if (wordBuf.Length + word.Length + 1 > maxChars && wordBuf.Length > 0)
                    {
                        segments.Add(wordBuf.ToString().Trim());
                        wordBuf.Clear();
                    }
                    if (wordBuf.Length > 0) wordBuf.Append(' ');
                    wordBuf.Append(word);
                }
                if (wordBuf.Length > 0) segments.Add(wordBuf.ToString().Trim());
                continue;
            }

            // If adding this sentence would exceed max and we're past min, flush
            if (currentLength + sentenceLength > maxChars && currentLength >= minChars)
            {
                segments.Add(current.ToString().Trim());
                current.Clear();
                currentLength = 0;
            }

            if (current.Length > 0) current.Append(' ');
            current.Append(sentence);
            currentLength += sentenceLength + 1;
        }

        if (currentLength > 0) segments.Add(current.ToString().Trim());
        return segments;
    }

    private static int EstimateDuration(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return 1;
        var words = text.Split(new[] { ' ', '\t', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries);
        var baseDuration = words.Length / 2.5; // 150 wpm = 2.5 wps
        var ellipsisCount = System.Text.RegularExpressions.Regex.Matches(text, @"\.\.\.").Count;
        var totalDuration = baseDuration + (ellipsisCount * 0.5);
        return (int)Math.Ceiling(Math.Max(3, Math.Min(15, totalDuration)));
    }

    private static string CleanSubtitleText(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return string.Empty;
        var result = text;

        // 1. Remove markdown headers (e.g., ## Opening Hook)
        result = System.Text.RegularExpressions.Regex.Replace(result, @"^#+\s+.*$", "", System.Text.RegularExpressions.RegexOptions.Multiline);
        
        // 2. Remove common phase headers (without hashes) at start of lines
        result = System.Text.RegularExpressions.Regex.Replace(result, @"^\s*(?:Opening Hook|Kontekstualisasi|Multi-Dimensi|Climax|Eschatology|Contextualization|Content|Segment \d+):?\s*$", "", System.Text.RegularExpressions.RegexOptions.Multiline | System.Text.RegularExpressions.RegexOptions.IgnoreCase);

        // 3. Remove embedded timestamps like 00:00, 01:25, or [00:15]
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\b\d{1,2}:\d{2}(?::\d{2})?\b", "");
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\[\d{1,2}:\d{2}(?::\d{2})?\]", "");

        // 4. Remove visual/production markers in brackets
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\[(?:Visual|Musik|Music|Efek|Effect|SFX|Audio|PAUSE)[^\]]*\]", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);

        // 5. Remove stage directions in parentheses
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\([^)]*\)", "");

        // 6. Basic formatting and symbols
        result = result.Replace("\"", "").Replace("'", "");
        result = result.Replace("*", "").Replace("_", "");
        result = System.Text.RegularExpressions.Regex.Replace(result, @"#\S+", "");
        result = result.Replace("[", "").Replace("]", "");
        result = result.Replace(".. .", "").Replace("...", "");
        result = result.Replace("‚Äî", " - ").Replace("‚Äì", " - ");

        // 7. Cleanup multiple spaces and newlines
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\s+", " ");
        return result.Trim();
    }

    /// <summary>
    /// Normalize timestamps so they always appear at the START of sentences/paragraphs.
    /// Moves trailing [MM:SS] or MM:SS timestamps to the beginning of the next line/sentence.
    /// </summary>
    private static string NormalizeTimestamps(string content)
    {
        if (string.IsNullOrWhiteSpace(content)) return content;

        // Pattern: text followed by a timestamp at the end of line ‚Üí move timestamp to next line start
        // e.g. "some text. [01:25]\n\nNext paragraph" ‚Üí "some text.\n\n[01:25] Next paragraph"
        var result = content;

        // 1. Remove timestamps that appear at end of a line/paragraph and re-attach to the start of next content
        //    Match: [MM:SS] at end of line (possibly before newlines)
        result = System.Text.RegularExpressions.Regex.Replace(
            result,
            @"\s*\[(\d{1,2}:\d{2})\]\s*\n",
            m => $"\n\n[{m.Groups[1].Value}] ",
            System.Text.RegularExpressions.RegexOptions.Multiline);

        // 2. Handle mid-sentence timestamps: "text [01:25] more text" ‚Üí newline before timestamp
        //    Only if preceded by sentence-ending punctuation
        result = System.Text.RegularExpressions.Regex.Replace(
            result,
            @"([.!?])\s*\[(\d{1,2}:\d{2})\]\s*",
            m => $"{m.Groups[1].Value}\n\n[{m.Groups[2].Value}] ");

        // 3. Clean up excessive newlines
        result = System.Text.RegularExpressions.Regex.Replace(result, @"\n{3,}", "\n\n");

        return result.Trim();
    }

    private string FormatDate(DateTime date)
    {
        var elapsed = DateTime.UtcNow - date;
        if (elapsed.TotalMinutes < 1) return "baru saja";
        if (elapsed.TotalHours < 1) return $"{(int)elapsed.TotalMinutes}m lalu";
        if (elapsed.TotalDays < 1) return $"{(int)elapsed.TotalHours}j lalu";
        if (elapsed.TotalDays < 7) return $"{(int)elapsed.TotalDays}h lalu";
        return date.ToString("dd MMM yyyy");
    }

    private static RenderFragment StatusBadge(SessionStatus status) => status switch
    {
        SessionStatus.Completed => @<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium bg-success/15 text-success"><span>‚óè</span> Selesai</span>,
        SessionStatus.Running => @<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium bg-primary/15 text-primary"><span class="animate-pulse">‚óè</span> Berjalan</span>,
        SessionStatus.Failed => @<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium bg-destructive/15 text-destructive"><span>‚óè</span> Gagal</span>,
        _ => @<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium bg-muted-foreground/15 text-muted-foreground"><span>‚óè</span> Pending</span>
    };

    private class PhaseStatusItem
    {
        public string PhaseId { get; set; } = "";
        public string Name { get; set; } = "";
        public int Order { get; set; }
        public string Status { get; set; } = "Pending";
        public int WordCount { get; set; }
        public List<string>? OutlinePoints { get; set; }
        public string DurationTarget { get; set; } = "";
    }

    private class ResultSection
    {
        public string PhaseId { get; set; } = "";
        public string PhaseName { get; set; } = "";
        public int Order { get; set; }
        public string Content { get; set; } = "";
        public int WordCount { get; set; }
        public double DurationSeconds { get; set; }
        public bool IsValidated { get; set; }
        public bool IsExpanded { get; set; }
        public bool IsRegenerating { get; set; }
        public List<string>? OutlinePoints { get; set; }
        public string CopyState { get; set; } = "idle";
    }
}
