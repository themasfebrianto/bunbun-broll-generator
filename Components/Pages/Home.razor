@page "/generator"
@page "/editor/{ProjectId}"
@rendermode InteractiveServer
@inject BunbunBroll.Services.IProjectService ProjectService
@inject NavigationManager NavigationManager
@inject BunbunBroll.Services.ToastService ToastService

<PageTitle>@(string.IsNullOrEmpty(ProjectId) ? "New Project" : "Edit Project")</PageTitle>

<div class="animate-in max-w-2xl mx-auto mt-12 px-4">
    <BunbunBroll.Components.Views.Broll.BrollInputForm 
        FormTitle="@(string.IsNullOrEmpty(ProjectId) ? "Generate B-Roll" : "Edit Project")"
        @bind-ProjectName="_projectName"
        @bind-ScriptText="_scriptText"
        @bind-SelectedMood="_selectedMood"
        IsLoading="_isLoading"
        OnSubmit="HandleSubmit" />
</div>

@code {
    [Parameter] public string? ProjectId { get; set; }

    private string _projectName = "";
    private string _scriptText = "";
    private string _selectedMood = "";
    private bool _isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(ProjectId))
        {
            var saved = await ProjectService.GetProjectAsync(ProjectId);
            if (saved != null)
            {
                _projectName = saved.Name;
                _scriptText = saved.RawScript;
                _selectedMood = saved.Mood ?? "";
            }
        }
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(_projectName) || string.IsNullOrWhiteSpace(_scriptText))
        {
            ToastService.ShowError("Isi nama dan script dulu bos!");
            return;
        }
        
        _isLoading = true;
        try
        {
            // If editing an existing project, just update the basic info.
            if (!string.IsNullOrEmpty(ProjectId))
            {
                var existing = await ProjectService.GetProjectAsync(ProjectId);
                if (existing != null)
                {
                    existing.Name = _projectName;
                    existing.RawScript = _scriptText;
                    existing.Mood = _selectedMood;
                    // Note: changing the script text here does not currently delete old segments, 
                    // To do that, we'll need a "regenerate" flow, but for now we just redirect.
                    NavigationManager.NavigateTo($"/workspace/{ProjectId}/script");
                    return;
                }
            }

            // Create new project
            var job = new BunbunBroll.Models.ProcessingJob
            {
                Id = Guid.NewGuid().ToString("N")[..8],
                ProjectName = _projectName,
                RawScript = _scriptText,
                Mood = _selectedMood,
                Status = BunbunBroll.Models.JobStatus.Created
            };
            
            await ProjectService.SaveJobAsProjectAsync(job);
            NavigationManager.NavigateTo($"/workspace/{job.Id}/script");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Gagal: {ex.Message}");
            _isLoading = false;
        }
    }
}
