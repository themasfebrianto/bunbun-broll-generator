@page "/"
@page "/editor/{ProjectId}"
@rendermode InteractiveServer
@inject IPipelineOrchestrator Orchestrator
@inject IHalalVideoFilter HalalFilter
@inject IProjectService ProjectService
@inject ILogger<Home> Logger
@implements IDisposable

<PageTitle>Sequence Generator</PageTitle>

<div class="animate-in">
    @if (_currentJob == null)
    {
        <!-- COMPOSER VIEW -->
        <div class="max-w-[42rem] mx-auto py-16 px-4">
            <div class="space-y-2 mb-8 text-center">
                <h1 class="text-3xl font-bold tracking-tight">Create New Sequence</h1>
                <p class="text-muted-foreground">Transform your script into a professional cinematic B-roll sequence.</p>
            </div>

            <div class="rounded-xl border bg-card text-card-foreground shadow p-8 space-y-6">
                <!-- Project Name -->
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                        Project Title
                    </label>
                    <input type="text" 
                           class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                           @bind="_projectName" 
                           placeholder="e.g. Morning Routine Intro" />
                </div>

                <!-- Script Body -->
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none">
                        Script Body
                    </label>
                    <textarea class="flex min-h-[160px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                              @bind="_scriptText" 
                              placeholder="Paste your script text here..."></textarea>
                    <p class="text-[0.8rem] text-muted-foreground">Each sentence triggers a unique metadata-driven footage search.</p>
                </div>

                <!-- Settings Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Visual Mood</label>
                        <select class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                                @bind="_selectedMood">
                            <option value="" class="bg-background text-foreground">Sequence Default</option>
                            <option value="Cinematic" class="bg-background text-foreground">Cinematic High-Contrast</option>
                            <option value="Moody" class="bg-background text-foreground">Moody / Desaturated</option>
                            <option value="Bright" class="bg-background text-foreground">Bright / High-Key</option>
                        </select>
                    </div>

                    <div class="flex items-center space-x-2 pb-2">
                        <button type="button" 
                                role="switch"
                                aria-checked="@_halalFilterEnabled"
                                class="peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 @(_halalFilterEnabled ? "bg-primary" : "bg-input")"
                                @onclick="ToggleHalalFilter">
                            <span class="pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform @(_halalFilterEnabled ? "translate-x-4" : "translate-x-0")"></span>
                        </button>
                        <label class="text-sm font-medium leading-none">Halal Mode</label>
                    </div>
                </div>

                <!-- Action -->
                <div class="pt-4">
                    <button class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-11 px-8 w-full"
                            @onclick="StartSearch" 
                            disabled="@(!CanGenerate || _isSearching)">
                        @if (_isSearching)
                        {
                            <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-primary-foreground" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Synthesizing...</span>
                        }
                        else
                        {
                            <span>Generate Previews</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- RESULTS VIEW -->
        <div class="max-w-[1200px] mx-auto py-8 lg:px-8 px-4">
            <div class="flex flex-col lg:flex-row gap-12 items-start">
                
                <!-- Sticky Sidebar -->
                <div class="lg:w-[260px] w-full shrink-0 lg:sticky lg:top-24 space-y-6">
                    <button class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2 w-full lg:w-auto"
                            @onclick="ResetJob">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"></path></svg>
                        Back to Editor
                    </button>

                    <div class="rounded-xl border bg-card text-card-foreground shadow p-6 space-y-4">
                        <div class="space-y-1">
                            <h3 class="text-sm font-semibold tracking-tight uppercase text-muted-foreground/60 text-[10px]">Project</h3>
                            <p class="text-sm font-medium truncate">@_currentJob.ProjectName</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <h3 class="text-[10px] font-semibold tracking-tight uppercase text-muted-foreground/60">Ready</h3>
                                <p class="text-lg font-bold">@_currentJob.PreviewReadySentences</p>
                            </div>
                            <div class="space-y-1">
                                <h3 class="text-[10px] font-semibold tracking-tight uppercase text-muted-foreground/60">Total</h3>
                                <p class="text-lg font-bold">@_currentJob.TotalSentences</p>
                            </div>
                        </div>
                    </div>

                    <button class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-11 px-8 w-full"
                            @onclick="DownloadAll" 
                            disabled="@(_isDownloading || _currentJob.PreviewReadySentences == 0)">
                        @if (_isDownloading)
                        {
                            <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        }
                        Process Assets
                    </button>
                    
                    <button class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2 w-full"
                            @onclick="SaveCurrentProject">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                        Save Project
                    </button>

                    <p class="text-center text-[10px] text-muted-foreground">@_currentJob.DownloadedSentences / @_currentJob.TotalSentences download complete</p>
                </div>

                <!-- Feed Content -->
                <div class="flex-1 min-w-0">
                    @if (!string.IsNullOrEmpty(_statusMessage))
                    {
                        <div class="flex items-center gap-2 text-xs text-muted-foreground mb-8 bg-muted/50 p-2 px-3 rounded-md border border-border/50">
                            <span class="flex h-1.5 w-1.5 rounded-full bg-primary animate-pulse"></span>
                            <span>@_statusMessage</span>
                        </div>
                    }

                    <div class="space-y-16">
                        @foreach (var segment in _currentJob.Segments)
                        {
                            <div class="space-y-8">
                                <div class="flex items-center gap-4">
                                    <h2 class="text-xs font-bold uppercase tracking-[0.2em] text-muted-foreground/50">@segment.Title</h2>
                                    <div class="h-[1px] flex-1 bg-border/50"></div>
                                </div>
                                
                                <div class="space-y-12">
                                    @foreach (var sentence in segment.Sentences)
                                    {
                                        <div class="flex flex-col md:flex-row gap-8 items-start relative group">
                                            <!-- Indicator Line -->
                                            <div class="absolute -left-6 top-1 bottom-1 w-0.5 bg-border/30 group-hover:bg-primary/50 transition-colors hidden lg:block"></div>
                                            
                                            <!-- Text Content -->
                                            <div class="flex-1 space-y-4">
                                                <div class="flex items-center gap-3">
                                                    <span class="text-[10px] font-mono font-medium text-muted-foreground bg-muted px-1.5 py-0.5 rounded">#@sentence.Id.ToString("D2")</span>
                                                    <span class="text-[10px] font-medium text-muted-foreground">@sentence.EstimatedDurationSeconds.ToString("F1")s duration</span>
                                                </div>
                                                <p class="text-xl leading-relaxed text-foreground font-medium">@sentence.Text</p>
                                                
                                                <div class="flex flex-wrap gap-2">
                                                    @foreach (var kw in sentence.Keywords.Take(3))
                                                    {
                                                        <span class="inline-flex items-center rounded-md border px-2 py-0.5 text-[10px] font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-secondary text-secondary-foreground">@kw</span>
                                                    }
                                                </div>
                                            </div>

                                            <!-- Visual Side -->
                                            <div class="md:w-[320px] w-full shrink-0">
                                                @if (_researchingSentenceId == sentence.Id && sentence.SearchResults.Count > 1)
                                                {
                                                    <div class="rounded-xl border bg-card p-2 shadow-lg space-y-2">
                                                        <div class="grid grid-cols-2 gap-1.5">
                                                            @foreach (var video in sentence.SearchResults)
                                                            {
                                                                <div class="aspect-video relative rounded-md overflow-hidden cursor-pointer border-2 transition-all @(sentence.SelectedVideo?.Id == video.Id ? "border-primary" : "border-transparent")"
                                                                     @onclick="() => SelectVideo(sentence, video)">
                                                                    <video src="@video.DownloadUrl" muted loop class="absolute inset-0 w-full h-full object-cover"></video>
                                                                </div>
                                                            }
                                                        </div>
                                                        <button class="inline-flex items-center justify-center rounded-md text-[11px] font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-8 px-3 w-full"
                                                                @onclick="() => ConfirmSelection(sentence)">
                                                            Confirm Choice
                                                        </button>
                                                    </div>
                                                }
                                                else if (sentence.SelectedVideo != null)
                                                {
                                                    <div class="rounded-xl border bg-card overflow-hidden shadow group/video">
                                                        <div class="aspect-video relative bg-black">
                                                            <video src="@sentence.SelectedVideo.DownloadUrl" controls muted loop class="absolute inset-0 w-full h-full object-cover"></video>
                                                        </div>
                                                        <div class="flex items-center justify-between p-1 bg-muted/30 border-t">
                                                            <button class="inline-flex items-center justify-center rounded-md text-xs font-medium transition-colors h-8 w-8 hover:bg-black/10 dark:hover:bg-white/10"
                                                                    @onclick="() => ResearchSentence(sentence)">
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.85.99 6.57 2.57L21 8M21 3v5h-5"/></svg>
                                                            </button>
                                                            @if (!sentence.IsDownloaded)
                                                            {
                                                                <button class="inline-flex items-center justify-center rounded-md text-[10px] font-semibold h-7 px-3 border border-input opacity-70 hover:opacity-100 transition-opacity"
                                                                        @onclick="() => DownloadSingle(sentence)">
                                                                    Capture
                                                                </button>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-[9px] font-bold text-success px-3 uppercase tracking-tighter">Verified</span>
                                                            }
                                                        </div>
                                                    </div>
                                                }
                                                else if (sentence.Status == SentenceStatus.NoResults)
                                                {
                                                    <div class="aspect-video rounded-xl border border-dashed flex flex-col items-center justify-center space-y-2 bg-muted/20">
                                                        <span class="text-[10px] text-muted-foreground font-medium uppercase tracking-tighter">No visual match</span>
                                                        <button class="inline-flex items-center justify-center rounded-md text-[10px] font-semibold h-7 px-3 border border-input shadow-sm hover:bg-accent" @onclick="() => ResearchSentence(sentence)">Retry</button>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="aspect-video rounded-xl border bg-muted animate-pulse"></div>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string _projectName = "";
    private string _scriptText = "";
    private string _selectedMood = "";
    private string _statusMessage = "";
    private bool _isSearching = false;
    private bool _isDownloading = false;
    private bool _halalFilterEnabled = false;
    private ProcessingJob? _currentJob;
    private CancellationTokenSource? _cts;
    private int? _researchingSentenceId;
    [Parameter] public string? ProjectId { get; set; }

    private bool CanGenerate => !string.IsNullOrWhiteSpace(_projectName) && !string.IsNullOrWhiteSpace(_scriptText);

    protected override async Task OnInitializedAsync()
    {
        _halalFilterEnabled = HalalFilter.IsEnabled;
        Orchestrator.OnSentenceProgress += HandleProgress;
        Orchestrator.OnJobProgress += HandleJobProgress;

        if (!string.IsNullOrEmpty(ProjectId))
        {
            await LoadSavedProject(ProjectId);
        }
    }

    private async Task LoadSavedProject(string id)
    {
        var saved = await ProjectService.GetProjectAsync(id);
        if (saved != null)
        {
            _projectName = saved.Name;
            _scriptText = saved.RawScript;
            _selectedMood = saved.Mood ?? "";
            
            _currentJob = new ProcessingJob
            {
                Id = saved.Id,
                ProjectName = saved.Name,
                RawScript = saved.RawScript,
                Mood = saved.Mood,
                CreatedAt = saved.CreatedAt,
                Status = JobStatus.PreviewReady
            };

            foreach (var s in saved.Segments.OrderBy(x => x.Order))
            {
                var segment = new ScriptSegment
                {
                    Id = s.Id,
                    Title = s.Title,
                    Status = SegmentStatus.Completed
                };
                foreach (var sent in s.Sentences.OrderBy(x => x.Order))
                {
                    var sentence = new ScriptSentence
                    {
                        Id = sent.Id,
                        Text = sent.Text,
                        Status = SentenceStatus.PreviewReady
                    };
                    if (!string.IsNullOrEmpty(sent.VideoUrl))
                    {
                        sentence.SelectedVideo = new VideoAsset
                        {
                            Id = sent.VideoId ?? "",
                            Provider = sent.VideoProvider ?? "Pexels",
                            DownloadUrl = sent.VideoUrl,
                            PreviewUrl = sent.VideoPreviewUrl ?? "",
                            ThumbnailUrl = sent.VideoThumbUrl ?? ""
                        };
                    }
                    segment.Sentences.Add(sentence);
                }
                _currentJob.Segments.Add(segment);
            }
        }
    }

    private void ToggleHalalFilter()
    {
        _halalFilterEnabled = !_halalFilterEnabled;
        HalalFilter.IsEnabled = _halalFilterEnabled;
    }

    private async Task StartSearch()
    {
        if (!CanGenerate) return;
        _isSearching = true;
        _cts = new CancellationTokenSource();
        _researchingSentenceId = null;
        
        _currentJob = new ProcessingJob {
            ProjectName = _projectName.Trim(),
            RawScript = _scriptText.Trim(),
            Mood = string.IsNullOrEmpty(_selectedMood) ? null : _selectedMood
        };
        
        StateHasChanged();
        await Orchestrator.SearchPreviewsAsync(_currentJob, _cts.Token);
        await SaveCurrentProject();
        _isSearching = false;
        StateHasChanged();
    }

    private async Task ResearchSentence(ScriptSentence sentence)
    {
        if (_currentJob == null) return;
        _researchingSentenceId = sentence.Id;
        StateHasChanged();
        await Orchestrator.ResearchSentenceAsync(_currentJob, sentence, null, _cts?.Token ?? default);
        StateHasChanged();
    }

    private void SelectVideo(ScriptSentence sentence, VideoAsset video)
    {
        sentence.SelectedVideo = video;
        StateHasChanged();
    }

    private async Task ConfirmSelection(ScriptSentence sentence)
    {
        _researchingSentenceId = null;
        sentence.Status = SentenceStatus.PreviewReady;
        await SaveCurrentProject();
        StateHasChanged();
    }

    private async Task SaveCurrentProject()
    {
        if (_currentJob != null)
        {
            await ProjectService.SaveJobAsProjectAsync(_currentJob);
        }
    }

    private async Task DownloadSingle(ScriptSentence sentence)
    {
        if (_currentJob == null) return;
        await Orchestrator.DownloadSentenceAsync(_currentJob, sentence, _cts?.Token ?? default);
        StateHasChanged();
    }

    private async Task DownloadAll()
    {
        if (_currentJob == null) return;
        _isDownloading = true;
        StateHasChanged();
        
        foreach (var sentence in _currentJob.Segments.SelectMany(s => s.Sentences))
        {
            if (sentence.SelectedVideo != null && !sentence.IsDownloaded)
                sentence.IsApproved = true;
        }
        
        await Orchestrator.DownloadApprovedAsync(_currentJob, _cts?.Token ?? default);
        _isDownloading = false;
        StateHasChanged();
    }

    private void ResetJob()
    {
        _currentJob = null;
        _statusMessage = "";
        _researchingSentenceId = null;
    }

    private void HandleProgress(object? sender, SentenceProgressEventArgs e)
    {
        _statusMessage = $"Analyzing Script #{e.Sentence.Id}... {e.Message}";
        InvokeAsync(StateHasChanged);
    }

    private void HandleJobProgress(object? sender, JobProgressEventArgs e)
    {
        _statusMessage = e.Message;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Orchestrator.OnSentenceProgress -= HandleProgress;
        Orchestrator.OnJobProgress -= HandleJobProgress;
        _cts?.Dispose();
    }
}
